<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradePulse - Simulateur d'Investissement</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Ajout de la bibliothèque html2pdf pour l'export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Styles généraux -->
    <link rel="stylesheet" href="css/simulation.css">
    <!-- Styles spécifiques pour le simulateur de prêt -->
    <link rel="stylesheet" href="css/loan-simulator.css">
    <!-- Styles pour l'autocomplétion des villes PTZ -->
    <link rel="stylesheet" href="css/ptz-autocomplete.css">
    <style>
        /* Styles supplémentaires pour le module budget */
        .budget-score-circle {
            transition: background-color 0.3s ease;
        }
        
        #budget-score {
            transition: color 0.3s ease;
        }
        
        #budget-score-bar {
            transition: width 0.5s ease-out, background-color 0.3s ease;
        }
        
        .depense-ligne {
            transition: all 0.3s ease;
        }
        
        .depense-ligne:hover {
            background: rgba(59, 130, 246, 0.1);
            border-radius: 0.5rem;
        }
        
        .depense-supprimer {
            opacity: 0.6;
            transition: all 0.2s ease;
        }
        
        .depense-supprimer:hover {
            opacity: 1;
        }
        
        #temps-objectif {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Styles pour les sous-catégories de budget */
        #view-detailed, #view-simple {
            transition: all 0.3s ease;
        }
        
        #view-detailed.selected, #view-simple.selected {
            position: relative;
            z-index: 1;
        }
        
        #detailed-view-courante, #detailed-view-loisirs, #simple-view {
            transition: all 0.3s ease;
        }
        
        .bg-blue-800.bg-opacity-20 {
            transition: all 0.3s ease;
        }
        
        .bg-blue-800.bg-opacity-20:hover {
            background-color: rgba(30, 64, 175, 0.25);
        }
        
        #total-vie-courante, #total-loisirs {
            transition: all 0.3s ease;
        }
        
        /* Style pour la classe hidden */
        .hidden {
            display: none;
        }
        
        /* Styles pour les remboursements anticipés multiples */
        .repayment-item {
            transition: all 0.3s ease;
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            background-color: rgba(30, 64, 175, 0.15);
        }
        
        .repayment-item:hover {
            background-color: rgba(30, 64, 175, 0.25);
        }
        
        .repayment-item-header {
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .repayment-item-body {
            padding: 0 1rem 0.75rem 1rem;
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease;
        }
        
        .repayment-item.expanded .repayment-item-body {
            max-height: 300px;
        }
        
        .remove-repayment {
            opacity: 0.6;
            transition: all 0.2s;
        }
        
        .remove-repayment:hover {
            opacity: 1;
            color: rgba(239, 68, 68, 0.8);
        }
        
        /* Notification de remboursement total */
        .loan-total-repayment-notice {
            background-color: rgba(52, 211, 153, 0.2);
            border-left: 4px solid rgba(52, 211, 153, 1);
            padding: 0.75rem;
            margin-top: 0.75rem;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
        }
        
        .loan-total-repayment-notice i {
            color: rgba(52, 211, 153, 1);
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }
    </style>
</head>
<body class="dark">
    <!-- Contenu du simulateur - Reste inchangé -->
    <!-- ... -->

    <!-- Type d'importation du module PTZ mise à jour pour les modules ES6 -->
    <script type="module" src="js/ptz-simulator.js"></script>
    <script type="module" src="js/ptz-city-index.js"></script>

    <!-- Autres scripts (inchangés) -->
    <script src="js/simulation.js"></script>
    <script src="js/fiscal-optimizer.js"></script>
    <script src="js/budget-epargne.js"></script>
    <script src="js/loan-simulator.js"></script>
    <script src="js/loan-sensitivity.js"></script>

    <script>
        // Ajouter une animation lorsque les totaux sont mis à jour
        function animateTotalUpdate(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('total-updated');
                setTimeout(() => {
                    element.classList.remove('total-updated');
                }, 1000);
            }
        }
        
        // Fonction pour basculer entre les modes de remboursement
        function switchRepaymentMode(mode) {
            const modeDureeBtn = document.getElementById('mode-duree');
            const modeMensualiteBtn = document.getElementById('mode-mensualite');
            const sectionDuree = document.getElementById('section-reduire-duree');
            const sectionMensualite = document.getElementById('section-reduire-mensualite');
            
            document.getElementById('remboursement-mode').value = mode;
            
            if (mode === 'duree') {
                modeDureeBtn.classList.add('active');
                modeDureeBtn.classList.add('text-green-400');
                modeMensualiteBtn.classList.remove('active');
                modeMensualiteBtn.classList.remove('text-green-400');
                sectionDuree.classList.remove('hidden');
                sectionMensualite.classList.add('hidden');
            } else {
                modeMensualiteBtn.classList.add('active');
                modeMensualiteBtn.classList.add('text-green-400');
                modeDureeBtn.classList.remove('active');
                modeDureeBtn.classList.remove('text-green-400');
                sectionMensualite.classList.remove('hidden');
                sectionDuree.classList.add('hidden');
            }
        }
        
        // Fonction améliorée pour vérifier si le remboursement anticipé est un remboursement total
        function checkTotalRepayment(montant) {
            const loanAmount = parseFloat(document.getElementById('loan-amount').value);
            const interestRate = parseFloat(document.getElementById('interest-rate-slider').value) / 100 / 12;
            const loanDurationYears = parseInt(document.getElementById('loan-duration-slider').value);
            const currentMonth = parseInt(document.getElementById('early-repayment-month-slider-mensualite').value);
            
            // Calcul approximatif du capital restant dû au mois du remboursement
            const mensualite = loanAmount * interestRate / (1 - Math.pow(1 + interestRate, -(loanDurationYears * 12)));
            let capitalRestant = loanAmount;
            
            for (let i = 1; i < currentMonth; i++) {
                const interetMois = capitalRestant * interestRate;
                capitalRestant -= (mensualite - interetMois);
            }
            
            // Vérification si le montant est proche du capital restant dû
            const notice = document.getElementById('total-repayment-notice');
            const totalRepaymentCheckbox = document.getElementById('total-repayment');
            
            if (notice) {
                // Afficher la notification uniquement si la case est cochée
                if (totalRepaymentCheckbox && totalRepaymentCheckbox.checked) {
                    notice.classList.remove('hidden');
                    
                    // Mettre à jour le montant de remboursement avec le capital restant
                    const earlyRepaymentAmountInput = document.getElementById('early-repayment-amount-mensualite');
                    if (earlyRepaymentAmountInput) {
                        earlyRepaymentAmountInput.value = Math.ceil(capitalRestant);
                    }
                } else {
                    notice.classList.add('hidden');
                }
            }
        }
        
        // Initialisation de base
        document.addEventListener('DOMContentLoaded', function() {
            // Code d'initialisation commun pour la page de simulation
        });
    </script>
</body>
</html>