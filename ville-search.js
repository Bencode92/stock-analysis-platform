// === GESTIONNAIRE DE RECHERCHE DE VILLE ===
// Syst√®me de recherche de ville avec auto-compl√©tion et s√©lection de type de logement

class VilleSearchManager {
    constructor() {
        this.villesData = null;
        this.selectedVille = null;
        this.selectedPiece = 'T2'; // Par d√©faut T2
        this.manualMode = false;
        this.onVilleSelected = null; // Callback pour notifier la s√©lection
        
        this.init();
    }
    
    async init() {
        console.log('üè† Initialisation du gestionnaire de recherche de ville...');
        
        // Charger les donn√©es des villes
        await this.loadVillesData();
        
        // Initialiser les √©v√©nements
        this.initEvents();
        
        console.log('‚úÖ VilleSearchManager initialis√© avec', this.villesData?.villes?.length || 0, 'villes');
    }
    
    async loadVillesData() {
        try {
            console.log('üìä Chargement des donn√©es des villes...');
            
            // ‚úÖ CORRECTION : Chemin vers le dossier data/
            const response = await fetch('./data/villes-data.json');
            
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            
            this.villesData = await response.json();
            console.log('‚úÖ Donn√©es des villes charg√©es:', this.villesData.meta || 'Base de donn√©es compl√®te');
            console.log(`üè† ${this.villesData.villes.length} villes disponibles`);
            
        } catch (error) {
            console.warn('‚ö†Ô∏è Erreur lors du chargement des donn√©es des villes:', error.message);
            console.log('üîÑ Utilisation des donn√©es de test...');
            
            // Donn√©es de test si le fichier n'est pas trouv√©
            this.villesData = {
                villes: [
                    {
                        nom: "Lyon",
                        departement: "69",
                        pieces: {
                            "T1": {prix_m2: 6912, loyer_m2: 19.18},
                            "T2": {prix_m2: 4567, loyer_m2: 17.92},
                            "T3": {prix_m2: 3970, loyer_m2: 14.50},
                            "T4": {prix_m2: 3660, loyer_m2: 14.50},
                            "T5": {prix_m2: 3286, loyer_m2: 14.50}
                        }
                    },
                    {
                        nom: "Paris 10e Arrondissement",
                        departement: "75",
                        pieces: {
                            "T1": {prix_m2: 11945, loyer_m2: 32.08},
                            "T2": {prix_m2: 9315, loyer_m2: 32.08},
                            "T3": {prix_m2: 7895, loyer_m2: 28.76}
                        }
                    },
                    {
                        nom: "Marseille",
                        departement: "13",
                        pieces: {
                            "T1": {prix_m2: 7452, loyer_m2: 19.22},
                            "T2": {prix_m2: 5290, loyer_m2: 19.22},
                            "T3": {prix_m2: 4647, loyer_m2: 17.43},
                            "T4": {prix_m2: 4375, loyer_m2: 17.43}
                        }
                    },
                    {
                        nom: "Toulouse",
                        departement: "31",
                        pieces: {
                            "T1": {prix_m2: 7946, loyer_m2: 15.92},
                            "T2": {prix_m2: 4629, loyer_m2: 15.92},
                            "T3": {prix_m2: 3525, loyer_m2: 12.34},
                            "T4": {prix_m2: 3237, loyer_m2: 12.34},
                            "T5": {prix_m2: 2761, loyer_m2: 12.34}
                        }
                    },
                    {
                        nom: "Nice",
                        departement: "06",
                        pieces: {
                            "T1": {prix_m2: 6712, loyer_m2: 19.68},
                            "T2": {prix_m2: 5935, loyer_m2: 19.68},
                            "T3": {prix_m2: 4838, loyer_m2: 16.60},
                            "T4": {prix_m2: 4241, loyer_m2: 16.60}
                        }
                    },
                    {
                        nom: "Nantes",
                        departement: "44",
                        pieces: {
                            "T1": {prix_m2: 7893, loyer_m2: 16.21},
                            "T2": {prix_m2: 4280, loyer_m2: 16.21},
                            "T3": {prix_m2: 3572, loyer_m2: 13.40},
                            "T4": {prix_m2: 3226, loyer_m2: 13.40},
                            "T5": {prix_m2: 3000, loyer_m2: 13.40}
                        }
                    },
                    {
                        nom: "Saint-Cloud",
                        departement: "92",
                        pieces: {
                            "T1": {prix_m2: 6792, loyer_m2: 29.6},
                            "T2": {prix_m2: 6552, loyer_m2: 29.6},
                            "T3": {prix_m2: 5828, loyer_m2: 26.21},
                            "T4": {prix_m2: 5146, loyer_m2: 26.21}
                        }
                    }
                ],
                meta: {
                    total_villes: 7,
                    note: "Donn√©es de test - Erreur de chargement du fichier principal : " + error.message
                }
            };
        }
    }
    
    initEvents() {
        const villeSearch = document.getElementById('ville-search');
        const suggestions = document.getElementById('ville-suggestions');
        const autreVilleCheckbox = document.getElementById('autre-ville-checkbox');
        
        if (!villeSearch) {
            console.error('‚ùå √âl√©ment ville-search non trouv√©');
            return;
        }
        
        console.log('üîó Initialisation des √©v√©nements...');
        
        // ‚úÖ AM√âLIORATION : Gestion des √©v√©nements am√©lior√©e
        villeSearch.addEventListener('input', (e) => {
            this.handleSearchInput(e.target.value);
        });
        
        // ‚úÖ NOUVEAU : Focus pour permettre une nouvelle recherche
        villeSearch.addEventListener('focus', (e) => {
            this.handleSearchFocus(e.target);
        });
        
        // ‚úÖ NOUVEAU : Gestion des touches sp√©ciales
        villeSearch.addEventListener('keydown', (e) => {
            this.handleKeyDown(e);
        });
        
        // Masquer suggestions si clic ailleurs
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                suggestions.style.display = 'none';
            }
        });
        
        // Mode manuel
        if (autreVilleCheckbox) {
            autreVilleCheckbox.addEventListener('change', (e) => {
                this.toggleManualMode(e.target.checked);
            });
        }
        
        // ‚úÖ NOUVEAU : Ajouter bouton de r√©initialisation
        this.addClearButton();
        
        console.log('‚úÖ √âv√©nements initialis√©s');
    }
    
    // ‚úÖ NOUVEAU : Ajouter un bouton X pour vider la recherche
    addClearButton() {
        const villeSearch = document.getElementById('ville-search');
        const searchContainer = villeSearch.closest('.search-container');
        
        if (!searchContainer) return;
        
        // Cr√©er le bouton de r√©initialisation
        const clearButton = document.createElement('button');
        clearButton.type = 'button';
        clearButton.className = 'ville-clear-btn';
        clearButton.innerHTML = '<i class="fas fa-times"></i>';
        clearButton.title = 'Effacer la s√©lection pour rechercher une nouvelle ville';
        clearButton.style.display = 'none';
        
        // Styles du bouton
        Object.assign(clearButton.style, {
            position: 'absolute',
            right: '15px',
            top: '50%',
            transform: 'translateY(-50%)',
            background: 'rgba(255, 255, 255, 0.1)',
            border: '1px solid rgba(255, 255, 255, 0.2)',
            borderRadius: '50%',
            width: '30px',
            height: '30px',
            color: 'rgba(255, 255, 255, 0.7)',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '12px',
            transition: 'all 0.2s ease',
            zIndex: '10'
        });
        
        // √âv√©nements du bouton
        clearButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            this.clearSelection();
        });
        
        clearButton.addEventListener('mouseenter', () => {
            clearButton.style.backgroundColor = 'rgba(239, 68, 68, 0.2)';
            clearButton.style.borderColor = 'rgba(239, 68, 68, 0.5)';
            clearButton.style.color = '#EF4444';
        });
        
        clearButton.addEventListener('mouseleave', () => {
            clearButton.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            clearButton.style.borderColor = 'rgba(255, 255, 255, 0.2)';
            clearButton.style.color = 'rgba(255, 255, 255, 0.7)';
        });
        
        // Positionner le container
        searchContainer.style.position = 'relative';
        searchContainer.appendChild(clearButton);
        
        this.clearButton = clearButton;
    }
    
    // ‚úÖ NOUVEAU : Gestion du focus
    handleSearchFocus(input) {
        if (this.selectedVille && !this.manualMode) {
            // S√©lectionner tout le texte pour faciliter le remplacement
            input.select();
            
            if (this.clearButton) {
                this.clearButton.style.display = 'flex';
            }
        }
    }
    
    // ‚úÖ NOUVEAU : Gestion des touches sp√©ciales
    handleKeyDown(e) {
        if (e.key === 'Escape') {
            document.getElementById('ville-suggestions').style.display = 'none';
        } else if ((e.key === 'Delete' || e.key === 'Backspace') && this.selectedVille) {
            // Si on efface et qu'une ville est s√©lectionn√©e, r√©initialiser apr√®s un court d√©lai
            setTimeout(() => {
                if (e.target.value.length === 0) {
                    this.resetSelection();
                }
            }, 10);
        }
    }
    
    // ‚úÖ AM√âLIORATION : Nouvelle fonction pour g√©rer l'input
    handleSearchInput(searchTerm) {
        // G√©rer le bouton de r√©initialisation
        if (this.clearButton) {
            this.clearButton.style.display = searchTerm.length > 0 ? 'flex' : 'none';
        }
        
        // Si on tape quelque chose de diff√©rent de la ville s√©lectionn√©e, r√©initialiser
        if (this.selectedVille && searchTerm !== this.selectedVille.nom) {
            this.resetSelection();
        }
        
        this.handleSearch(searchTerm);
    }
    
    // ‚úÖ NOUVEAU : R√©initialiser sans vider le champ
    resetSelection() {
        this.selectedVille = null;
        
        const villeInfo = document.getElementById('ville-selected-info');
        if (villeInfo) {
            villeInfo.style.display = 'none';
        }
        
        const villeSearch = document.getElementById('ville-search');
        if (villeSearch) {
            villeSearch.classList.remove('ville-search-enhanced');
        }
        
        // R√©initialiser les styles des champs prix
        this.resetPriceFieldsStyles();
    }
    
    // ‚úÖ NOUVEAU : Vider compl√®tement la s√©lection
    clearSelection() {
        console.log('üßπ R√©initialisation de la recherche de ville');
        
        const villeSearch = document.getElementById('ville-search');
        const suggestions = document.getElementById('ville-suggestions');
        
        if (villeSearch) {
            villeSearch.value = '';
            villeSearch.classList.remove('ville-search-enhanced');
            villeSearch.focus();
        }
        
        if (suggestions) {
            suggestions.style.display = 'none';
        }
        
        if (this.clearButton) {
            this.clearButton.style.display = 'none';
        }
        
        this.resetSelection();
    }
    
    // ‚úÖ NOUVEAU : R√©initialiser les styles des champs prix
    resetPriceFieldsStyles() {
        const prixM2Input = document.getElementById('prix-m2-marche');
        const loyerM2Input = document.getElementById('loyer-m2');
        
        if (prixM2Input) {
            prixM2Input.classList.remove('ville-search-enhanced');
        }
        
        if (loyerM2Input) {
            loyerM2Input.classList.remove('ville-search-enhanced');
        }
    }
    
    handleSearch(searchTerm) {
        const suggestions = document.getElementById('ville-suggestions');
        
        if (!searchTerm || searchTerm.length < 2) {
            suggestions.style.display = 'none';
            return;
        }
        
        // Recherche dans les donn√©es
        const matches = this.villesData.villes.filter(ville =>
            ville.nom.toLowerCase().includes(searchTerm.toLowerCase())
        );
        
        if (matches.length > 0) {
            this.displaySuggestions(matches.slice(0, 8)); // Limiter √† 8 r√©sultats
            suggestions.style.display = 'block';
        } else {
            suggestions.style.display = 'none';
        }
    }
    
    displaySuggestions(villes) {
        const suggestions = document.getElementById('ville-suggestions');
        suggestions.innerHTML = '';
        
        villes.forEach(ville => {
            const suggestionDiv = document.createElement('div');
            suggestionDiv.className = 'ville-suggestion';
            
            const typesDisponibles = Object.keys(ville.pieces);
            const priceRange = this.getPriceRange(ville.pieces);
            
            suggestionDiv.innerHTML = `
                <div class="ville-info">
                    <div class="ville-nom">${ville.nom}</div>
                    <div class="ville-dept">D√©partement ${ville.departement}</div>
                </div>
                <div class="ville-types-info">
                    <div class="ville-types-count">${typesDisponibles.length} types</div>
                    <div style="color: rgba(255,255,255,0.7);">${priceRange.min}‚Ç¨ - ${priceRange.max}‚Ç¨/m¬≤</div>
                </div>
            `;
            
            suggestionDiv.addEventListener('click', () => {
                this.selectVille(ville);
            });
            
            suggestions.appendChild(suggestionDiv);
        });
    }
    
    getPriceRange(pieces) {
        const prices = Object.values(pieces).map(p => p.prix_m2);
        return {
            min: Math.min(...prices),
            max: Math.max(...prices)
        };
    }
    
    selectVille(ville) {
        console.log('üèôÔ∏è Ville s√©lectionn√©e:', ville.nom);
        
        this.selectedVille = ville;
        
        // Mettre √† jour l'input de recherche
        const villeSearch = document.getElementById('ville-search');
        villeSearch.value = ville.nom;
        villeSearch.classList.add('ville-search-enhanced');
        
        // Masquer les suggestions
        document.getElementById('ville-suggestions').style.display = 'none';
        
        // Afficher le bouton de r√©initialisation
        if (this.clearButton) {
            this.clearButton.style.display = 'flex';
        }
        
        // Afficher les infos de la ville
        this.displayVilleInfo(ville);
        
        // Cr√©er le s√©lecteur de pi√®ces
        this.createPieceSelector(ville.pieces);
        
        // Mettre √† jour les champs prix/loyer
        this.updatePriceFields();
        
        // ‚úÖ MODIFICATION 2 : Appeler le callback si d√©fini
        if (typeof this.onVilleSelected === 'function') {
            this.onVilleSelected(this.getSelectedVilleData());
        }
    }
    
    displayVilleInfo(ville) {
        const infoDiv = document.getElementById('ville-selected-info');
        const nomSpan = document.getElementById('ville-nom');
        const deptSpan = document.getElementById('ville-dept');
        const typesSpan = document.getElementById('ville-types');
        
        if (nomSpan) nomSpan.textContent = ville.nom;
        if (deptSpan) deptSpan.textContent = ville.departement;
        if (typesSpan) typesSpan.textContent = Object.keys(ville.pieces).join(', ');
        
        if (infoDiv) {
            infoDiv.style.display = 'block';
            infoDiv.classList.add('fade-in');
        }
    }
    
    createPieceSelector(pieces) {
        const selector = document.getElementById('piece-selector');
        if (!selector) return;
        
        selector.innerHTML = '';
        
        // ‚úÖ MODIFICATION 3 : S√©curiser le choix de pi√®ce
        const keys = Object.keys(pieces);
        if (!keys.includes(this.selectedPiece)) {
            this.selectedPiece = keys[0]; // fallback sur la premi√®re pi√®ce disponible
        }
        
        keys.forEach(pieceType => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = `piece-btn ${pieceType === this.selectedPiece ? 'active' : ''}`;
            btn.textContent = pieceType;
            
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                this.selectPiece(pieceType, btn);
            });
            
            selector.appendChild(btn);
        });
    }
    
    selectPiece(pieceType, btnElement) {
        console.log('üè† Type de logement s√©lectionn√©:', pieceType);
        
        this.selectedPiece = pieceType;
        
        // Mettre √† jour les boutons
        document.querySelectorAll('.piece-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        if (btnElement) {
            btnElement.classList.add('active');
        }
        
        // Mettre √† jour les champs
        this.updatePriceFields();
        
        // ‚úÖ MODIFICATION 2 : Appeler le callback apr√®s changement de pi√®ce
        if (typeof this.onVilleSelected === 'function') {
            this.onVilleSelected(this.getSelectedVilleData());
        }
    }
    
    updatePriceFields() {
        if (!this.selectedVille || !this.selectedPiece) return;
        
        const pieceData = this.selectedVille.pieces[this.selectedPiece];
        if (!pieceData) return;
        
        const prixM2Input = document.getElementById('prix-m2-marche');
        const loyerM2Input = document.getElementById('loyer-m2');
        
        if (prixM2Input) {
            prixM2Input.value = pieceData.prix_m2;
            prixM2Input.classList.add('ville-search-enhanced');
        }
        
        if (loyerM2Input) {
            loyerM2Input.value = pieceData.loyer_m2;
            loyerM2Input.classList.add('ville-search-enhanced');
        }
        
        console.log('üí∞ Prix mis √† jour:', {
            ville: this.selectedVille.nom,
            type: this.selectedPiece,
            prix_m2: pieceData.prix_m2,
            loyer_m2: pieceData.loyer_m2
        });
    }
    
    toggleManualMode(isManual) {
        console.log('üîß Mode manuel:', isManual);
        
        this.manualMode = isManual;
        
        const prixM2Input = document.getElementById('prix-m2-marche');
        const loyerM2Input = document.getElementById('loyer-m2');
        const villeInfo = document.getElementById('ville-selected-info');
        const villeSearch = document.getElementById('ville-search');
        const container = document.querySelector('.container');
        
        if (isManual) {
            // Mode manuel: permettre la saisie libre
            if (prixM2Input) {
                prixM2Input.classList.remove('ville-search-enhanced', 'highlight-field');
                prixM2Input.classList.add('manual-mode');
            }
            if (loyerM2Input) {
                loyerM2Input.classList.remove('ville-search-enhanced', 'highlight-field');
                loyerM2Input.classList.add('manual-mode');
            }
            if (villeSearch) {
                villeSearch.classList.remove('ville-search-enhanced');
            }
            
            if (villeInfo) villeInfo.style.display = 'none';
            if (container) container.classList.add('manual-mode');
            
            // Masquer le bouton en mode manuel
            if (this.clearButton) {
                this.clearButton.style.display = 'none';
            }
            
            this.selectedVille = null;
            
        } else {
            // Mode automatique: remettre en surbrillance
            if (prixM2Input) {
                prixM2Input.classList.remove('manual-mode');
                prixM2Input.classList.add('highlight-field');
            }
            if (loyerM2Input) {
                loyerM2Input.classList.remove('manual-mode');
                loyerM2Input.classList.add('highlight-field');
            }
            if (container) container.classList.remove('manual-mode');
            
            // Remettre √† jour si une ville √©tait s√©lectionn√©e
            if (this.selectedVille) {
                this.updatePriceFields();
                if (villeInfo) villeInfo.style.display = 'block';
            }
        }
        
        // ‚úÖ MODIFICATION 2 : Appeler le callback en mode manuel avec objet neutre
        if (typeof this.onVilleSelected === 'function') {
            this.onVilleSelected(
                this.getSelectedVilleData() || {
                    ville: '',
                    departement: '',
                    piece: null,
                    prix_m2: null,
                    loyer_m2: null,
                    manual_mode: true
                }
            );
        }
    }
    
    // M√©thode pour obtenir les donn√©es de la ville s√©lectionn√©e
    getSelectedVilleData() {
        if (!this.selectedVille || !this.selectedPiece || this.manualMode) return null;
        
        const pieceData = this.selectedVille.pieces[this.selectedPiece];
        if (!pieceData) return null;
        
        return {
            ville: this.selectedVille.nom,
            departement: this.selectedVille.departement,
            piece: this.selectedPiece,
            prix_m2: pieceData.prix_m2,
            loyer_m2: pieceData.loyer_m2,
            manual_mode: this.manualMode
        };
    }
    
    // M√©thode pour obtenir les statistiques de la base de donn√©es
    getStats() {
        if (!this.villesData) return null;
        
        return {
            total_villes: this.villesData.villes.length,
            meta: this.villesData.meta || null,
            selected_ville: this.selectedVille?.nom || null,
            selected_piece: this.selectedPiece || null,
            manual_mode: this.manualMode
        };
    }
}

// === INT√âGRATION AVEC LE SIMULATEUR EXISTANT ===

// Modifier la fonction de simulation existante
function integrateWithExistingSimulator() {
    // Attendre que le DOM soit charg√©
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', integrateWithExistingSimulator);
        return;
    }
    
    // V√©rifier si le bouton de simulation existe
    const btnSimulate = document.getElementById('btn-simulate');
    
    // ‚úÖ MODIFICATION 1 : Supprimer le warning si le bouton n'existe pas
    if (!btnSimulate) {
        // Page sans bouton "simulate" : on ne fait rien, pas de warning
        return;
    }
    
    // Sauvegarder la fonction de simulation originale si elle existe
    const originalSimulateFunction = window.simuler || function() {
        console.log('üîÑ Fonction de simulation par d√©faut appel√©e');
    };
    
    // Cr√©er une nouvelle fonction de simulation qui int√®gre les donn√©es de ville
    window.simulerAvecVilleData = function() {
        console.log('üöÄ Lancement de la simulation avec donn√©es de ville...');
        
        const villeData = window.villeSearchManager?.getSelectedVilleData();
        
        if (villeData) {
            console.log('üèôÔ∏è Simulation avec donn√©es de ville:', villeData);
            
            // Afficher les informations dans les r√©sultats
            const resultsSection = document.getElementById('results');
            if (resultsSection && !resultsSection.classList.contains('hidden')) {
                // Ajouter info sur la ville utilis√©e
                let villeInfo = document.getElementById('ville-used-info');
                if (!villeInfo) {
                    villeInfo = document.createElement('div');
                    villeInfo.id = 'ville-used-info';
                    villeInfo.className = 'info-message mb-4';
                    villeInfo.innerHTML = `
                        <div class="text-lg text-green-400 mr-3">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div>
                            <h4 class="font-medium mb-1">Simulation bas√©e sur les donn√©es de ${villeData.ville}</h4>
                            <p class="text-sm opacity-90">Type: ${villeData.piece} ‚Ä¢ Prix: ${villeData.prix_m2}‚Ç¨/m¬≤ ‚Ä¢ Loyer: ${villeData.loyer_m2}‚Ç¨/m¬≤/mois</p>
                        </div>
                    `;
                    resultsSection.insertBefore(villeInfo, resultsSection.firstChild);
                }
            }
        } else {
            console.log('üìù Simulation avec donn√©es manuelles');
        }
        
        // Appeler la fonction de simulation originale
        return originalSimulateFunction();
    };
    
    // Remplacer la fonction de simulation
    window.simuler = window.simulerAvecVilleData;
    
    console.log('‚úÖ Int√©gration avec le simulateur existant termin√©e');
}

// === INITIALISATION ===
document.addEventListener('DOMContentLoaded', function() {
    console.log('üè† Initialisation du syst√®me de recherche de ville...');
    
    // Initialiser le gestionnaire de recherche
    window.villeSearchManager = new VilleSearchManager();
    
    // Int√©grer avec le simulateur existant
    integrateWithExistingSimulator();
    
    console.log('‚úÖ Syst√®me de recherche de ville initialis√©');
});

// === EXPORT POUR COMPATIBILIT√â ===
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { VilleSearchManager };
}

// === FONCTIONS UTILITAIRES ===

// Fonction pour debug - afficher les stats
window.showVilleStats = function() {
    if (window.villeSearchManager) {
        console.table(window.villeSearchManager.getStats());
    }
};

// Fonction pour forcer la mise √† jour des donn√©es
window.refreshVilleData = function() {
    if (window.villeSearchManager) {
        window.villeSearchManager.loadVillesData();
    }
};
