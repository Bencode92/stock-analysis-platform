"""
ETF Exposure Mapping v3.0 - Architecture propre

Séparation claire :
1. TICKER_TO_EXPOSURE : lookup direct ticker → exposure (pas de recherche texte)
2. KEYWORD_PATTERNS : regex compilées avec word boundaries pour fallback sur nom

Corrige les problèmes :
- Pas de substring matching sur tickers courts (eu, com, mid...)
- Pas de collision de clés
- Regex avec \b pour éviter faux positifs
- Compatible Python 3.8+ (Optional au lieu de |)

Date: 2025-12-26
Source: all_etfs.csv (3527 ETFs)
Classifiés: 2029 tickers en 61 catégories
"""

from typing import Optional
import re
from functools import lru_cache

# =============================================================================
# TICKER_TO_EXPOSURE - Lookup direct uniquement (pas de recherche texte ici)
# =============================================================================
TICKER_TO_EXPOSURE = {

    # === ACWI (7) ===
    "acwi": "acwi",
    "acwx": "acwi",
    "crbn": "acwi",
    "cwi": "acwi",
    "hawx": "acwi",
    "lowc": "acwi",
    "nzac": "acwi",

    # === BIOTECH (4) ===
    "bbc": "biotech",
    "bbh": "biotech",
    "bbp": "biotech",
    "xbi": "biotech",

    # === BONDS_HY (3) ===
    "aohy": "bonds_hy",
    "hiys": "bonds_hy",
    "xhyf": "bonds_hy",

    # === BONDS_IG (1) ===
    "eprf": "bonds_ig",

    # === BONDS_MUNI (6) ===
    "hmop": "bonds_muni",
    "mcef": "bonds_muni",
    "mino": "bonds_muni",
    "must": "bonds_muni",
    "pmio": "bonds_muni",
    "rvnu": "bonds_muni",

    # === BTC_ETF (40) ===
    "arka": "btc_etf",
    "arkb": "btc_etf",
    "arkc": "btc_etf",
    "arky": "btc_etf",
    "bete": "btc_etf",
    "beth": "btc_etf",
    "bitb": "btc_etf",
    "biti": "btc_etf",
    "bito": "btc_etf",
    "bits": "btc_etf",
    "bitu": "btc_etf",
    "bitx": "btc_etf",
    "bpi": "btc_etf",
    "brrr": "btc_etf",
    "btc": "btc_etf",
    "btcc": "btc_etf",
    "btci": "btc_etf",
    "btcl": "btc_etf",
    "btco": "btc_etf",
    "btcw": "btc_etf",
    "btcz": "btc_etf",
    "btf": "btc_etf",
    "btrn": "btc_etf",
    "cgbcf": "btc_etf",
    "defi": "btc_etf",
    "dfii": "btc_etf",
    "ezbc": "btc_etf",
    "fbtc": "btc_etf",
    "gbtc": "btc_etf",
    "hodl": "btc_etf",
    "ibit": "btc_etf",
    "maxi": "btc_etf",
    "mnrs": "btc_etf",
    "pbyef": "btc_etf",
    "prbef": "btc_etf",
    "sbit": "btc_etf",
    "wgmi": "btc_etf",
    "ybit": "btc_etf",
    "ybtc": "btc_etf",
    "zzz": "btc_etf",

    # === BUFFER (132) ===
    "augm": "buffer",
    "augp": "buffer",
    "bapr": "buffer",
    "baug": "buffer",
    "bdec": "buffer",
    "bfeb": "buffer",
    "bjan": "buffer",
    "bjul": "buffer",
    "bjun": "buffer",
    "bmar": "buffer",
    "bmay": "buffer",
    "boct": "buffer",
    "bsep": "buffer",
    "bstp": "buffer",
    "bufb": "buffer",
    "bufc": "buffer",
    "bufd": "buffer",
    "bufq": "buffer",
    "bufr": "buffer",
    "bufy": "buffer",
    "bufz": "buffer",
    "caaa": "buffer",
    "dapr": "buffer",
    "daug": "buffer",
    "ddec": "buffer",
    "decm": "buffer",
    "dfeb": "buffer",
    "dhdg": "buffer",
    "djan": "buffer",
    "djul": "buffer",
    "djun": "buffer",
    "dmar": "buffer",
    "dmax": "buffer",
    "dmay": "buffer",
    "dnov": "buffer",
    "doct": "buffer",
    "dsep": "buffer",
    "eapr": "buffer",
    "ebuf": "buffer",
    "ejul": "buffer",
    "eoct": "buffer",
    "fapr": "buffer",
    "faug": "buffer",
    "fbuf": "buffer",
    "fdec": "buffer",
    "ffeb": "buffer",
    "fjan": "buffer",
    "fjul": "buffer",
    "fjun": "buffer",
    "fmar": "buffer",
    "fmay": "buffer",
    "fnov": "buffer",
    "foct": "buffer",
    "fsep": "buffer",
    "hapr": "buffer",
    "hjul": "buffer",
    "hoct": "buffer",
    "iapr": "buffer",
    "iaug": "buffer",
    "ibuf": "buffer",
    "idec": "buffer",
    "ijan": "buffer",
    "ijul": "buffer",
    "ijun": "buffer",
    "imar": "buffer",
    "imay": "buffer",
    "ioct": "buffer",
    "isep": "buffer",
    "ivvb": "buffer",
    "ivvm": "buffer",
    "janp": "buffer",
    "julm": "buffer",
    "junm": "buffer",
    "kapr": "buffer",
    "kjan": "buffer",
    "kjul": "buffer",
    "knov": "buffer",
    "koct": "buffer",
    "lapr": "buffer",
    "loct": "buffer",
    "maxj": "buffer",
    "napr": "buffer",
    "naug": "buffer",
    "njan": "buffer",
    "njul": "buffer",
    "njun": "buffer",
    "nnov": "buffer",
    "noct": "buffer",
    "nsep": "buffer",
    "octh": "buffer",
    "octm": "buffer",
    "octp": "buffer",
    "papr": "buffer",
    "paug": "buffer",
    "pbjl": "buffer",
    "pbjn": "buffer",
    "pbnv": "buffer",
    "pbqq": "buffer",
    "pdec": "buffer",
    "pfeb": "buffer",
    "pjan": "buffer",
    "pjul": "buffer",
    "pjun": "buffer",
    "pmar": "buffer",
    "pmay": "buffer",
    "pnov": "buffer",
    "poct": "buffer",
    "pqoc": "buffer",
    "psep": "buffer",
    "pstp": "buffer",
    "qcap": "buffer",
    "qcjl": "buffer",
    "qcoc": "buffer",
    "qdec": "buffer",
    "qjun": "buffer",
    "qmag": "buffer",
    "qmar": "buffer",
    "qspt": "buffer",
    "rflr": "buffer",
    "rsjn": "buffer",
    "sepm": "buffer",
    "sqmx": "buffer",
    "tdec": "buffer",
    "xbap": "buffer",
    "xbja": "buffer",
    "xboc": "buffer",
    "xide": "buffer",
    "xijn": "buffer",
    "ximr": "buffer",
    "xise": "buffer",
    "xmay": "buffer",
    "zalt": "buffer",

    # === CHINA (33) ===
    "ashr": "china",
    "ashs": "china",
    "bchi": "china",
    "buyo": "china",
    "ccef": "china",
    "cneq": "china",
    "cnllf": "china",
    "cnya": "china",
    "cqqq": "china",
    "cspf": "china",
    "cxse": "china",
    "drag": "china",
    "fca": "china",
    "flch": "china",
    "gxc": "china",
    "isvbf": "china",
    "jchi": "china",
    "kall": "china",
    "kba": "china",
    "kcai": "china",
    "kgrn": "china",
    "kranf": "china",
    "kure": "china",
    "kweb": "china",
    "mch": "china",
    "mchi": "china",
    "nbce": "china",
    "pcce": "china",
    "pgj": "china",
    "rayc": "china",
    "tchi": "china",
    "xttrf": "china",
    "yxi": "china",

    # === COMMODITIES (24) ===
    "bcd": "commodities",
    "bci": "commodities",
    "ccrv": "commodities",
    "cery": "commodities",
    "cmdt": "commodities",
    "cmdy": "commodities",
    "com": "commodities",
    "comb": "commodities",
    "comt": "commodities",
    "dbc": "commodities",
    "djp": "commodities",
    "dyyxf": "commodities",
    "evmt": "commodities",
    "gcc": "commodities",
    "gsg": "commodities",
    "hard": "commodities",
    "hcom": "commodities",
    "hger": "commodities",
    "ibbcf": "commodities",
    "nbcm": "commodities",
    "pdba": "commodities",
    "pdbc": "commodities",
    "sdci": "commodities",
    "usci": "commodities",

    # === COPPER (5) ===
    "copa": "copper",
    "copj": "copper",
    "cper": "copper",
    "cpxr": "copper",
    "icop": "copper",

    # === COVERED_CALL (25) ===
    "bmdlf": "covered_call",
    "buyw": "covered_call",
    "cvrd": "covered_call",
    "djia": "covered_call",
    "dylg": "covered_call",
    "fthi": "covered_call",
    "ftlb": "covered_call",
    "ftqi": "covered_call",
    "fylg": "covered_call",
    "hygw": "covered_call",
    "hylg": "covered_call",
    "lqdw": "covered_call",
    "pbp": "covered_call",
    "qdcc": "covered_call",
    "qyld": "covered_call",
    "qyle": "covered_call",
    "qylg": "covered_call",
    "ryld": "covered_call",
    "rylg": "covered_call",
    "srhr": "covered_call",
    "tltw": "covered_call",
    "tylg": "covered_call",
    "vega": "covered_call",
    "xyle": "covered_call",
    "xylg": "covered_call",

    # === DEVELOPED_MARKETS (20) ===
    "bbax": "developed_markets",
    "deef": "developed_markets",
    "eafg": "developed_markets",
    "fdt": "developed_markets",
    "ffr": "developed_markets",
    "icow": "developed_markets",
    "idev": "developed_markets",
    "idlv": "developed_markets",
    "idmo": "developed_markets",
    "isdmf": "developed_markets",
    "jade": "developed_markets",
    "nudm": "developed_markets",
    "pdn": "developed_markets",
    "piz": "developed_markets",
    "pxf": "developed_markets",
    "qlvd": "developed_markets",
    "rayd": "developed_markets",
    "rodm": "developed_markets",
    "tltd": "developed_markets",
    "vea": "developed_markets",

    # === DIVIDEND (100) ===
    "aapr": "dividend",
    "adiv": "dividend",
    "adve": "dividend",
    "bamd": "dividend",
    "bdiv": "dividend",
    "bdvg": "dividend",
    "bgdv": "dividend",
    "cgdg": "dividend",
    "cgdv": "dividend",
    "clylf": "dividend",
    "cows": "dividend",
    "ddiv": "dividend",
    "dfnd": "dividend",
    "dgro": "dividend",
    "dgrw": "dividend",
    "dhs": "dividend",
    "divb": "dividend",
    "divl": "dividend",
    "divo": "dividend",
    "divs": "dividend",
    "divy": "dividend",
    "divz": "dividend",
    "dtd": "dividend",
    "dtn": "dividend",
    "dura": "dividend",
    "dvdn": "dividend",
    "dvlu": "dividend",
    "dvnd": "dividend",
    "dvy": "dividend",
    "dvya": "dividend",
    "efad": "dividend",
    "elcv": "dividend",
    "fdiv": "dividend",
    "fdl": "dividend",
    "fdrr": "dividend",
    "fdv": "dividend",
    "fdvv": "dividend",
    "ftds": "dividend",
    "fucif": "dividend",
    "fvd": "dividend",
    "gdiv": "dividend",
    "gend": "dividend",
    "genw": "dividend",
    "hdef": "dividend",
    "hdiqf": "dividend",
    "hdv": "dividend",
    "hidv": "dividend",
    "idvo": "dividend",
    "ipdp": "dividend",
    "isdjf": "dividend",
    "jdiv": "dividend",
    "jhdv": "dividend",
    "kbwd": "dividend",
    "lead": "dividend",
    "mbox": "dividend",
    "ndiv": "dividend",
    "ndvg": "dividend",
    "nudv": "dividend",
    "ousa": "dividend",
    "pey": "dividend",
    "pfm": "dividend",
    "pqdi": "dividend",
    "qdef": "dividend",
    "qdf": "dividend",
    "qsix": "dividend",
    "rdog": "dividend",
    "rdvi": "dividend",
    "rdvy": "dividend",
    "rfda": "dividend",
    "riet": "dividend",
    "rndv": "dividend",
    "rudqf": "dividend",
    "scdl": "dividend",
    "schd": "dividend",
    "sclz": "dividend",
    "sdog": "dividend",
    "sdvd": "dividend",
    "sdy": "dividend",
    "snpd": "dividend",
    "sseef": "dividend",
    "stxd": "dividend",
    "tbg": "dividend",
    "tdiv": "dividend",
    "tdv": "dividend",
    "tdvg": "dividend",
    "tdvi": "dividend",
    "tmdv": "dividend",
    "tphd": "dividend",
    "tphe": "dividend",
    "udi": "dividend",
    "udiv": "dividend",
    "vdyif": "dividend",
    "vig": "dividend",
    "vsda": "dividend",
    "vym": "dividend",
    "wbiy": "dividend",
    "wdssf": "dividend",
    "wsddf": "dividend",
    "xudv": "dividend",
    "ylde": "dividend",

    # === DOW30 (18) ===
    "dia": "dow30",
    "djd": "dow30",
    "dog": "dow30",
    "dogg": "dow30",
    "edow": "dow30",
    "fdm": "dow30",
    "fdn": "dow30",
    "fdni": "dow30",
    "fgd": "dow30",
    "gyld": "dow30",
    "idowf": "dow30",
    "iyy": "dow30",
    "rwo": "dow30",
    "rwr": "dow30",
    "rwx": "dow30",
    "sdow": "dow30",
    "udow": "dow30",
    "umma": "dow30",

    # === EMERGING_MARKETS (90) ===
    "avem": "emerging_markets",
    "aves": "emerging_markets",
    "avsd": "emerging_markets",
    "avse": "emerging_markets",
    "avxc": "emerging_markets",
    "bbem": "emerging_markets",
    "bkem": "emerging_markets",
    "cew": "emerging_markets",
    "dbem": "emerging_markets",
    "dehp": "emerging_markets",
    "dem": "emerging_markets",
    "dfae": "emerging_markets",
    "dfem": "emerging_markets",
    "dfev": "emerging_markets",
    "dfse": "emerging_markets",
    "dgre": "emerging_markets",
    "dvye": "emerging_markets",
    "ecow": "emerging_markets",
    "ediv": "emerging_markets",
    "edog": "emerging_markets",
    "eelv": "emerging_markets",
    "eem": "emerging_markets",
    "eema": "emerging_markets",
    "eemo": "emerging_markets",
    "eemv": "emerging_markets",
    "eemx": "emerging_markets",
    "effe": "emerging_markets",
    "ejan": "emerging_markets",
    "emcr": "emerging_markets",
    "emcs": "emerging_markets",
    "emdm": "emerging_markets",
    "emdv": "emerging_markets",
    "emgf": "emerging_markets",
    "emif": "emerging_markets",
    "emmf": "emerging_markets",
    "emqq": "emerging_markets",
    "emsf": "emerging_markets",
    "emsg": "emerging_markets",
    "emxc": "emerging_markets",
    "eqlt": "emerging_markets",
    "eum": "emerging_markets",
    "evlu": "emerging_markets",
    "eyld": "emerging_markets",
    "fdem": "emerging_markets",
    "femr": "emerging_markets",
    "flqe": "emerging_markets",
    "fnde": "emerging_markets",
    "frdm": "emerging_markets",
    "gem": "emerging_markets",
    "gmf": "emerging_markets",
    "gsee": "emerging_markets",
    "heem": "emerging_markets",
    "iemg": "emerging_markets",
    "isapf": "emerging_markets",
    "iveg": "emerging_markets",
    "jema": "emerging_markets",
    "jhem": "emerging_markets",
    "jpem": "emerging_markets",
    "kemq": "emerging_markets",
    "kemx": "emerging_markets",
    "mem": "emerging_markets",
    "mems": "emerging_markets",
    "mfem": "emerging_markets",
    "nsi": "emerging_markets",
    "ntse": "emerging_markets",
    "nuem": "emerging_markets",
    "oaem": "emerging_markets",
    "pcem": "emerging_markets",
    "pemx": "emerging_markets",
    "pie": "emerging_markets",
    "ppem": "emerging_markets",
    "pxh": "emerging_markets",
    "qemm": "emerging_markets",
    "qlve": "emerging_markets",
    "raye": "emerging_markets",
    "rfem": "emerging_markets",
    "rnem": "emerging_markets",
    "roam": "emerging_markets",
    "sche": "emerging_markets",
    "seem": "emerging_markets",
    "spem": "emerging_markets",
    "ssgaf": "emerging_markets",
    "stxe": "emerging_markets",
    "tlte": "emerging_markets",
    "tsep": "emerging_markets",
    "uevm": "emerging_markets",
    "vwo": "emerging_markets",
    "xc": "emerging_markets",
    "xcem": "emerging_markets",
    "xsoe": "emerging_markets",

    # === ENERGY (37) ===
    "aces": "energy",
    "ccnr": "energy",
    "dbe": "energy",
    "drll": "energy",
    "dtw": "energy",
    "dukb": "energy",
    "einc": "energy",
    "eipi": "energy",
    "eipx": "energy",
    "emlp": "energy",
    "enfr": "energy",
    "eu": "energy",
    "feny": "energy",
    "frnw": "energy",
    "ftwo": "energy",
    "fxn": "energy",
    "ibat": "energy",
    "iunsf": "energy",
    "iye": "energy",
    "nlr": "energy",
    "nvir": "energy",
    "pbw": "energy",
    "pxe": "energy",
    "pxi": "energy",
    "qcln": "energy",
    "smog": "energy",
    "srmkf": "energy",
    "thnr": "energy",
    "umi": "energy",
    "usai": "energy",
    "use": "energy",
    "vcln": "energy",
    "vde": "energy",
    "weei": "energy",
    "wtid": "energy",
    "wtiu": "energy",
    "xle": "energy",

    # === EQUAL_WEIGHT (8) ===
    "bmmpf": "equal_weight",
    "eqwl": "equal_weight",
    "eusa": "equal_weight",
    "govi": "equal_weight",
    "qqew": "equal_weight",
    "qqqe": "equal_weight",
    "rsmr": "equal_weight",
    "szne": "equal_weight",

    # === ESG (44) ===
    "avsu": "esg",
    "blld": "esg",
    "chgx": "esg",
    "dmxf": "esg",
    "eaoa": "esg",
    "eaok": "esg",
    "eaom": "esg",
    "easg": "esg",
    "egus": "esg",
    "emxf": "esg",
    "epre": "esg",
    "erth": "esg",
    "esgd": "esg",
    "esge": "esg",
    "esgs": "esg",
    "esgu": "esg",
    "esgv": "esg",
    "fedm": "esg",
    "feus": "esg",
    "fsst": "esg",
    "infr": "esg",
    "iqhi": "esg",
    "isvtf": "esg",
    "ivra": "esg",
    "kcsh": "esg",
    "ldem": "esg",
    "mote": "esg",
    "pfut": "esg",
    "pldr": "esg",
    "pult": "esg",
    "qqjg": "esg",
    "rafe": "esg",
    "saef": "esg",
    "scrd": "esg",
    "solr": "esg",
    "sspx": "esg",
    "stnc": "esg",
    "stsb": "esg",
    "susa": "esg",
    "susl": "esg",
    "ussg": "esg",
    "usxf": "esg",
    "vckvf": "esg",
    "zsc": "esg",

    # === ETH_ETF (8) ===
    "aeth": "eth_etf",
    "arkz": "eth_etf",
    "ceth": "eth_etf",
    "ethv": "eth_etf",
    "ethw": "eth_etf",
    "ezet": "eth_etf",
    "feth": "eth_etf",
    "qeth": "eth_etf",

    # === EUROPE (35) ===
    "bbeu": "europe",
    "dbeu": "europe",
    "dbez": "europe",
    "dxmef": "europe",
    "esg": "europe",
    "euad": "europe",
    "eudg": "europe",
    "eudv": "europe",
    "eufn": "europe",
    "eumv": "europe",
    "ezu": "europe",
    "fdd": "europe",
    "fep": "europe",
    "feuz": "europe",
    "fez": "europe",
    "fleh": "europe",
    "fleu": "europe",
    "fpxe": "europe",
    "ftdpf": "europe",
    "hedj": "europe",
    "hezu": "europe",
    "ieur": "europe",
    "iev": "europe",
    "imsef": "europe",
    "isacf": "europe",
    "ivvpf": "europe",
    "oeur": "europe",
    "rfdi": "europe",
    "rfeu": "europe",
    "sgssf": "europe",
    "speu": "europe",
    "ssgff": "europe",
    "ssgxf": "europe",
    "sswrf": "europe",
    "vgk": "europe",

    # === FINANCIALS (10) ===
    "dfnl": "financials",
    "gabf": "financials",
    "iyg": "financials",
    "ltsf": "financials",
    "ltsk": "financials",
    "ltsl": "financials",
    "pgf": "financials",
    "prs": "financials",
    "xlf": "financials",
    "yfgsf": "financials",

    # === GLOBAL_EQUITY (192) ===
    "acwf": "global_equity",
    "acwv": "global_equity",
    "agng": "global_equity",
    "agqi": "global_equity",
    "aiq": "global_equity",
    "alty": "global_equity",
    "aqwa": "global_equity",
    "argt": "global_equity",
    "asea": "global_equity",
    "asmf": "global_equity",
    "ausf": "global_equity",
    "aztd": "global_equity",
    "bild": "global_equity",
    "bkch": "global_equity",
    "bkgi": "global_equity",
    "bldg": "global_equity",
    "bles": "global_equity",
    "boat": "global_equity",
    "botz": "global_equity",
    "braz": "global_equity",
    "bug": "global_equity",
    "cefa": "global_equity",
    "cgge": "global_equity",
    "cggo": "global_equity",
    "cgv": "global_equity",
    "cgw": "global_equity",
    "chiq": "global_equity",
    "clma": "global_equity",
    "clou": "global_equity",
    "cmoxf": "global_equity",
    "coal": "global_equity",
    "copx": "global_equity",
    "ctec": "global_equity",
    "cut": "global_equity",
    "dax": "global_equity",
    "dew": "global_equity",
    "dfgr": "global_equity",
    "dgt": "global_equity",
    "div": "global_equity",
    "divd": "global_equity",
    "dmat": "global_equity",
    "dnl": "global_equity",
    "driv": "global_equity",
    "drw": "global_equity",
    "dtcr": "global_equity",
    "ebiz": "global_equity",
    "eblu.eu": "global_equity",
    "eblu.nv": "global_equity",
    "eblu.tc": "global_equity",
    "edoc": "global_equity",
    "efas": "global_equity",
    "emc": "global_equity",
    "emcc": "global_equity",
    "emm": "global_equity",
    "epu": "global_equity",
    "esgf": "global_equity",
    "esgg": "global_equity",
    "exi": "global_equity",
    "fan": "global_equity",
    "fege": "global_equity",
    "fill": "global_equity",
    "finx": "global_equity",
    "flm": "global_equity",
    "flqd": "global_equity",
    "flqg": "global_equity",
    "fpag": "global_equity",
    "ftag": "global_equity",
    "ftgc": "global_equity",
    "ftri": "global_equity",
    "gaa": "global_equity",
    "gal": "global_equity",
    "gbcmf": "global_equity",
    "gbdv": "global_equity",
    "gcow": "global_equity",
    "gex": "global_equity",
    "ggrw": "global_equity",
    "giax": "global_equity",
    "gii": "global_equity",
    "ginx": "global_equity",
    "glof": "global_equity",
    "glow": "global_equity",
    "gmom": "global_equity",
    "gnom": "global_equity",
    "gnr": "global_equity",
    "goat": "global_equity",
    "gqre": "global_equity",
    "grek": "global_equity",
    "gsib": "global_equity",
    "gunr": "global_equity",
    "guru": "global_equity",
    "gval": "global_equity",
    "gxg": "global_equity",
    "gxtg": "global_equity",
    "hero": "global_equity",
    "hmlsf": "global_equity",
    "hrzsf": "global_equity",
    "htec": "global_equity",
    "hydr": "global_equity",
    "icln": "global_equity",
    "igf": "global_equity",
    "iisgf": "global_equity",
    "imsif": "global_equity",
    "ion": "global_equity",
    "ioo": "global_equity",
    "ipav": "global_equity",
    "irvh": "global_equity",
    "iwatf": "global_equity",
    "ixc": "global_equity",
    "ixg": "global_equity",
    "ixj": "global_equity",
    "ixn": "global_equity",
    "ixp": "global_equity",
    "jets": "global_equity",
    "jglo": "global_equity",
    "joyy": "global_equity",
    "jstc": "global_equity",
    "jxi": "global_equity",
    "klmt": "global_equity",
    "klxy": "global_equity",
    "kocg": "global_equity",
    "krbn": "global_equity",
    "krma": "global_equity",
    "krop": "global_equity",
    "kxi": "global_equity",
    "lit": "global_equity",
    "miln": "global_equity",
    "mlpa": "global_equity",
    "mlpd": "global_equity",
    "mlpx": "global_equity",
    "motg": "global_equity",
    "musq": "global_equity",
    "mxi": "global_equity",
    "ndia": "global_equity",
    "nfra": "global_equity",
    "norw": "global_equity",
    "nres": "global_equity",
    "ofos": "global_equity",
    "ogig": "global_equity",
    "onof": "global_equity",
    "pave": "global_equity",
    "pbd": "global_equity",
    "pcgg": "global_equity",
    "pex": "global_equity",
    "pffd": "global_equity",
    "pffv": "global_equity",
    "pick": "global_equity",
    "pio": "global_equity",
    "psp": "global_equity",
    "ptec": "global_equity",
    "pwer": "global_equity",
    "rays": "global_equity",
    "reet": "global_equity",
    "rgef": "global_equity",
    "rnrg": "global_equity",
    "rnwz": "global_equity",
    "robo": "global_equity",
    "rxi": "global_equity",
    "sagp": "global_equity",
    "sdem": "global_equity",
    "sdg": "global_equity",
    "sdiv": "global_equity",
    "sea": "global_equity",
    "shld": "global_equity",
    "snsr": "global_equity",
    "socl": "global_equity",
    "soil": "global_equity",
    "spff": "global_equity",
    "spgm": "global_equity",
    "spre": "global_equity",
    "spte": "global_equity",
    "sret": "global_equity",
    "sroi": "global_equity",
    "tblu": "global_equity",
    "thnq": "global_equity",
    "tmfg": "global_equity",
    "toga": "global_equity",
    "tolz": "global_equity",
    "tov": "global_equity",
    "upgd": "global_equity",
    "ura": "global_equity",
    "vegi": "global_equity",
    "vgfo": "global_equity",
    "vgsr": "global_equity",
    "vnam": "global_equity",
    "vnqi": "global_equity",
    "vpn": "global_equity",
    "war": "global_equity",
    "wdiv": "global_equity",
    "wndy": "global_equity",
    "wood": "global_equity",
    "wrnd": "global_equity",
    "zap": "global_equity",

    # === GOLD_MINERS (15) ===
    "aumi": "gold_miners",
    "dust": "gold_miners",
    "gdmn": "gold_miners",
    "gdx": "gold_miners",
    "gdxd": "gold_miners",
    "gdxj": "gold_miners",
    "gdxu": "gold_miners",
    "gdxy": "gold_miners",
    "goau": "gold_miners",
    "jdst": "gold_miners",
    "jnug": "gold_miners",
    "nugt": "gold_miners",
    "ring": "gold_miners",
    "sgdj": "gold_miners",
    "sgdm": "gold_miners",

    # === GOLD_PHYSICAL (32) ===
    "aaau": "gold_physical",
    "bar": "gold_physical",
    "bgld": "gold_physical",
    "btgd": "gold_physical",
    "cgblf": "gold_physical",
    "ckgdf": "gold_physical",
    "dgz": "gold_physical",
    "dull": "gold_physical",
    "dzz": "gold_physical",
    "fgdl": "gold_physical",
    "fgld": "gold_physical",
    "gde": "gold_physical",
    "gld": "gold_physical",
    "gldb": "gold_physical",
    "gldm": "gold_physical",
    "gldx": "gold_physical",
    "gll": "gold_physical",
    "goex": "gold_physical",
    "hbcgf": "gold_physical",
    "iau": "gold_physical",
    "iaum": "gold_physical",
    "isgpf": "gold_physical",
    "iutcf": "gold_physical",
    "ounz": "gold_physical",
    "rccmd": "gold_physical",
    "sgol": "gold_physical",
    "shny": "gold_physical",
    "ubisf": "gold_physical",
    "ugl": "gold_physical",
    "usg": "gold_physical",
    "ygld": "gold_physical",
    "zkbgf": "gold_physical",

    # === GROWTH (60) ===
    "aor": "growth",
    "aotg": "growth",
    "aweg": "growth",
    "bamg": "growth",
    "bgig": "growth",
    "bul": "growth",
    "cark": "growth",
    "cggr": "growth",
    "csmd": "growth",
    "darp": "growth",
    "eaor": "growth",
    "efg": "growth",
    "fad": "growth",
    "fbcg": "growth",
    "fdg": "growth",
    "fdgr": "growth",
    "ffog": "growth",
    "fgro": "growth",
    "ftgs": "growth",
    "gqqq": "growth",
    "grzz": "growth",
    "hqgo": "growth",
    "ilcg": "growth",
    "iusg": "growth",
    "iwfl": "growth",
    "iwy": "growth",
    "jgro": "growth",
    "jgrw": "growth",
    "lrgg": "growth",
    "lsgr": "growth",
    "mgk": "growth",
    "nbgx": "growth",
    "nugo": "growth",
    "pjfg": "growth",
    "prae": "growth",
    "qdvo": "growth",
    "qgro": "growth",
    "qgrw": "growth",
    "qpx": "growth",
    "qtap": "growth",
    "qtja": "growth",
    "qtjl": "growth",
    "qtoc": "growth",
    "rila": "growth",
    "rjmg": "growth",
    "rnsc": "growth",
    "runn": "growth",
    "stlg": "growth",
    "stxg": "growth",
    "swan": "growth",
    "sxqg": "growth",
    "tbfg": "growth",
    "tchp": "growth",
    "tgrt": "growth",
    "tgrw": "growth",
    "tug": "growth",
    "tugn": "growth",
    "vug": "growth",
    "wltg": "growth",
    "xdqq": "growth",

    # === HEALTHCARE (6) ===
    "andhf": "healthcare",
    "ibrn": "healthcare",
    "idna": "healthcare",
    "ihf": "healthcare",
    "iyh": "healthcare",
    "jdoc": "healthcare",

    # === INDIA (12) ===
    "dgin": "india",
    "epi": "india",
    "flin": "india",
    "inco": "india",
    "inda": "india",
    "inde": "india",
    "indf": "india",
    "indy": "india",
    "inqq": "india",
    "iopp": "india",
    "nfty": "india",
    "pin": "india",

    # === INTERNATIONAL (130) ===
    "aitvf": "international",
    "aivi": "international",
    "apie": "international",
    "asmiy": "international",
    "avde": "international",
    "avnm": "international",
    "avnv": "international",
    "bbin": "international",
    "bidd": "international",
    "binc": "international",
    "binv": "international",
    "bkci": "international",
    "bkie": "international",
    "bovnf": "international",
    "cgic": "international",
    "cgie": "international",
    "cgxu": "international",
    "chowf": "international",
    "cil": "international",
    "cvie": "international",
    "ddwm": "international",
    "dfai": "international",
    "dfic": "international",
    "dfiv": "international",
    "dfsi": "international",
    "dihp": "international",
    "dint": "international",
    "divi": "international",
    "dmcy": "international",
    "doo": "international",
    "dstx": "international",
    "dtan": "international",
    "dth": "international",
    "dukx": "international",
    "dwm": "international",
    "dwmf": "international",
    "dwx": "international",
    "dxiv": "international",
    "edgi": "international",
    "esgn": "international",
    "fdev": "international",
    "feni": "international",
    "fics": "international",
    "fid": "international",
    "fidi": "international",
    "fint": "international",
    "fiva": "international",
    "fndc": "international",
    "fndf": "international",
    "fpxi": "international",
    "gmoi": "international",
    "gsid": "international",
    "gsie": "international",
    "gxus": "international",
    "hauz": "international",
    "hdmv": "international",
    "hfxi": "international",
    "idhq": "international",
    "idme": "international",
    "idog": "international",
    "idub": "international",
    "idv": "international",
    "idvz": "international",
    "ifed": "international",
    "ifgl": "international",
    "ifv": "international",
    "igro": "international",
    "ihdg": "international",
    "imfl": "international",
    "imom": "international",
    "imtm": "international",
    "ineq": "international",
    "intf": "international",
    "intl": "international",
    "ipkw": "international",
    "ipos": "international",
    "iqdf": "international",
    "iqdg": "international",
    "iqdy": "international",
    "iqlt": "international",
    "iqsi": "international",
    "iswn": "international",
    "ival": "international",
    "ixus": "international",
    "jdvi": "international",
    "jgrrf": "international",
    "jhmd": "international",
    "jig": "international",
    "jire": "international",
    "jive": "international",
    "jpin": "international",
    "lenty": "international",
    "lvhi": "international",
    "lvin": "international",
    "mcse": "international",
    "mfdx": "international",
    "moti": "international",
    "ntsi": "international",
    "oaim": "international",
    "osea": "international",
    "pid": "international",
    "pieq": "international",
    "pjio": "international",
    "ppie": "international",
    "ptin": "international",
    "qint": "international",
    "qlti": "international",
    "rfix": "international",
    "rode": "international",
    "schf": "international",
    "schy": "international",
    "seie": "international",
    "ssxu": "international",
    "tlci": "international",
    "tous": "international",
    "tpif": "international",
    "ttai": "international",
    "uivm": "international",
    "vidi": "international",
    "vigi": "international",
    "vsgx": "international",
    "vxus": "international",
    "vymi": "international",
    "wcmi": "international",
    "wwjd": "international",
    "xidv": "international",
    "ydec": "international",
    "yjun": "international",
    "ymar": "international",
    "ysep": "international",

    # === INVERSE (13) ===
    "card": "inverse",
    "etq": "inverse",
    "fngd": "inverse",
    "hbnnf": "inverse",
    "magx": "inverse",
    "mstz": "inverse",
    "nrgd": "inverse",
    "nvdq": "inverse",
    "oild": "inverse",
    "skre": "inverse",
    "tapr": "inverse",
    "tslz": "inverse",
    "vyld": "inverse",

    # === JAPAN (23) ===
    "bbjp": "japan",
    "dbjp": "japan",
    "dxj": "japan",
    "dxjjf": "japan",
    "epp": "japan",
    "ewj": "japan",
    "ewjv": "japan",
    "fjp": "japan",
    "flax": "japan",
    "fljh": "japan",
    "fljp": "japan",
    "fpa": "japan",
    "gsjy": "japan",
    "hewj": "japan",
    "iffif": "japan",
    "ihhsf": "japan",
    "imscf": "japan",
    "ismjf": "japan",
    "jpan": "japan",
    "jpavf": "japan",
    "nbjp": "japan",
    "rayj": "japan",
    "wdtrf": "japan",

    # === LARGE_CAP (49) ===
    "agrw": "large_cap",
    "altl": "large_cap",
    "aviv": "large_cap",
    "bali": "large_cap",
    "bcil": "large_cap",
    "blcr": "large_cap",
    "blcv": "large_cap",
    "caml": "large_cap",
    "demz": "large_cap",
    "dol": "large_cap",
    "esga": "large_cap",
    "esgy": "large_cap",
    "felc": "large_cap",
    "felg": "large_cap",
    "felv": "large_cap",
    "fflc": "large_cap",
    "fflg": "large_cap",
    "fflv": "large_cap",
    "flcc": "large_cap",
    "flcg": "large_cap",
    "flcv": "large_cap",
    "funl": "large_cap",
    "fxi": "large_cap",
    "hfgo": "large_cap",
    "iwlg": "large_cap",
    "jhml": "large_cap",
    "jkd": "large_cap",
    "jke": "large_cap",
    "jkf": "large_cap",
    "lgro": "large_cap",
    "lrge": "large_cap",
    "lyld": "large_cap",
    "mdlv": "large_cap",
    "mslc": "large_cap",
    "nulc": "large_cap",
    "nulg": "large_cap",
    "nulv": "large_cap",
    "nwlg": "large_cap",
    "oalc": "large_cap",
    "ovl": "large_cap",
    "ovlh": "large_cap",
    "palc": "large_cap",
    "prxv": "large_cap",
    "pwb": "large_cap",
    "pwv": "large_cap",
    "shus": "large_cap",
    "sspy": "large_cap",
    "vslu": "large_cap",
    "vv": "large_cap",

    # === LEVERAGED_2X_BEAR (32) ===
    "aibd": "leveraged_2x_bear",
    "bis": "leveraged_2x_bear",
    "bzq": "leveraged_2x_bear",
    "dug": "leveraged_2x_bear",
    "dxd": "leveraged_2x_bear",
    "eev": "leveraged_2x_bear",
    "efu": "leveraged_2x_bear",
    "epv": "leveraged_2x_bear",
    "ery": "leveraged_2x_bear",
    "ethd": "leveraged_2x_bear",
    "euo": "leveraged_2x_bear",
    "ewv": "leveraged_2x_bear",
    "fxp": "leveraged_2x_bear",
    "hbtpf": "leveraged_2x_bear",
    "kold": "leveraged_2x_bear",
    "mzz": "leveraged_2x_bear",
    "qid": "leveraged_2x_bear",
    "rew": "leveraged_2x_bear",
    "rxd": "leveraged_2x_bear",
    "scc": "leveraged_2x_bear",
    "sco": "leveraged_2x_bear",
    "sdd": "leveraged_2x_bear",
    "sdp": "leveraged_2x_bear",
    "sds": "leveraged_2x_bear",
    "sij": "leveraged_2x_bear",
    "skf": "leveraged_2x_bear",
    "smn": "leveraged_2x_bear",
    "srs": "leveraged_2x_bear",
    "ssg": "leveraged_2x_bear",
    "szk": "leveraged_2x_bear",
    "twm": "leveraged_2x_bear",
    "ycs": "leveraged_2x_bear",

    # === LEVERAGED_2X_BULL (69) ===
    "aapu": "leveraged_2x_bull",
    "aibu": "leveraged_2x_bull",
    "amzu": "leveraged_2x_bull",
    "avl": "leveraged_2x_bull",
    "bib": "leveraged_2x_bull",
    "boil": "leveraged_2x_bull",
    "chau": "leveraged_2x_bull",
    "cldl": "leveraged_2x_bull",
    "cweb": "leveraged_2x_bull",
    "ddm": "leveraged_2x_bull",
    "dig": "leveraged_2x_bull",
    "eet": "leveraged_2x_bull",
    "efo": "leveraged_2x_bull",
    "erx": "leveraged_2x_bull",
    "etht": "leveraged_2x_bull",
    "evav": "leveraged_2x_bull",
    "ezj": "leveraged_2x_bull",
    "fngg": "leveraged_2x_bull",
    "ggll": "leveraged_2x_bull",
    "gush": "leveraged_2x_bull",
    "lmbo": "leveraged_2x_bull",
    "ltl": "leveraged_2x_bull",
    "msfu": "leveraged_2x_bull",
    "mvv": "leveraged_2x_bull",
    "nfxl": "leveraged_2x_bull",
    "nvdu": "leveraged_2x_bull",
    "ooto": "leveraged_2x_bull",
    "qld": "leveraged_2x_bull",
    "rdiv": "leveraged_2x_bull",
    "rom": "leveraged_2x_bull",
    "rxl": "leveraged_2x_bull",
    "saa": "leveraged_2x_bull",
    "skyu": "leveraged_2x_bull",
    "spuu": "leveraged_2x_bull",
    "sso": "leveraged_2x_bull",
    "tsll": "leveraged_2x_bull",
    "tsmx": "leveraged_2x_bull",
    "uapr": "leveraged_2x_bull",
    "uaug": "leveraged_2x_bull",
    "ubr": "leveraged_2x_bull",
    "ucc": "leveraged_2x_bull",
    "uco": "leveraged_2x_bull",
    "ucyb": "leveraged_2x_bull",
    "udec": "leveraged_2x_bull",
    "ufeb": "leveraged_2x_bull",
    "uge": "leveraged_2x_bull",
    "ujan": "leveraged_2x_bull",
    "ujul": "leveraged_2x_bull",
    "ujun": "leveraged_2x_bull",
    "ule": "leveraged_2x_bull",
    "ulty": "leveraged_2x_bull",
    "umar": "leveraged_2x_bull",
    "umay": "leveraged_2x_bull",
    "unov": "leveraged_2x_bull",
    "uoct": "leveraged_2x_bull",
    "upar": "leveraged_2x_bull",
    "upv": "leveraged_2x_bull",
    "upw": "leveraged_2x_bull",
    "uraa": "leveraged_2x_bull",
    "ure": "leveraged_2x_bull",
    "usd": "leveraged_2x_bull",
    "usep": "leveraged_2x_bull",
    "uwm": "leveraged_2x_bull",
    "uxi": "leveraged_2x_bull",
    "uyg": "leveraged_2x_bull",
    "uym": "leveraged_2x_bull",
    "xpp": "leveraged_2x_bull",
    "xxch": "leveraged_2x_bull",
    "ycl": "leveraged_2x_bull",

    # === LEVERAGED_3X_BEAR (11) ===
    "drip": "leveraged_3x_bear",
    "drv": "leveraged_3x_bear",
    "edz": "leveraged_3x_bear",
    "faz": "leveraged_3x_bear",
    "hibs": "leveraged_3x_bear",
    "labd": "leveraged_3x_bear",
    "soxs": "leveraged_3x_bear",
    "spxs": "leveraged_3x_bear",
    "tecs": "leveraged_3x_bear",
    "tza": "leveraged_3x_bear",
    "yang": "leveraged_3x_bear",

    # === LEVERAGED_3X_BULL (28) ===
    "brzu": "leveraged_3x_bull",
    "cure": "leveraged_3x_bull",
    "dfen": "leveraged_3x_bull",
    "dpst": "leveraged_3x_bull",
    "drn": "leveraged_3x_bull",
    "dusl": "leveraged_3x_bull",
    "edc": "leveraged_3x_bull",
    "eurl": "leveraged_3x_bull",
    "fas": "leveraged_3x_bull",
    "hibl": "leveraged_3x_bull",
    "indl": "leveraged_3x_bull",
    "koru": "leveraged_3x_bull",
    "labu": "leveraged_3x_bull",
    "mexx": "leveraged_3x_bull",
    "midu": "leveraged_3x_bull",
    "nail": "leveraged_3x_bull",
    "pill": "leveraged_3x_bull",
    "retl": "leveraged_3x_bull",
    "soxl": "leveraged_3x_bull",
    "spxl": "leveraged_3x_bull",
    "tecl": "leveraged_3x_bull",
    "tna": "leveraged_3x_bull",
    "tpor": "leveraged_3x_bull",
    "utsl": "leveraged_3x_bull",
    "want": "leveraged_3x_bull",
    "webl": "leveraged_3x_bull",
    "webs": "leveraged_3x_bull",
    "yinn": "leveraged_3x_bull",

    # === MID_CAP (57) ===
    "cza": "mid_cap",
    "dim": "mid_cap",
    "eqwm": "mid_cap",
    "ewmc": "mid_cap",
    "ffsm": "mid_cap",
    "fmde": "mid_cap",
    "frty": "mid_cap",
    "grpm": "mid_cap",
    "ijh": "mid_cap",
    "ijj": "mid_cap",
    "ijk": "mid_cap",
    "imcb": "mid_cap",
    "imcg": "mid_cap",
    "imcv": "mid_cap",
    "ismd": "mid_cap",
    "ivog": "mid_cap",
    "ivoo": "mid_cap",
    "ivov": "mid_cap",
    "jhmm": "mid_cap",
    "jkg": "mid_cap",
    "jkh": "mid_cap",
    "jki": "mid_cap",
    "jmee": "mid_cap",
    "mdcp": "mid_cap",
    "mdyg": "mid_cap",
    "mdyv": "mid_cap",
    "mgmt": "mid_cap",
    "mid": "mid_cap",
    "mide": "mid_cap",
    "mssm": "mid_cap",
    "myy": "mid_cap",
    "numg": "mid_cap",
    "numv": "mid_cap",
    "pamc": "mid_cap",
    "pxmv": "mid_cap",
    "qvmm": "mid_cap",
    "regl": "mid_cap",
    "rfg": "mid_cap",
    "rfv": "mid_cap",
    "rwk": "mid_cap",
    "smco": "mid_cap",
    "smdd": "mid_cap",
    "smig": "mid_cap",
    "smiz": "mid_cap",
    "spmd": "mid_cap",
    "tmfm": "mid_cap",
    "tmsl": "mid_cap",
    "tsme": "mid_cap",
    "umdd": "mid_cap",
    "vo": "mid_cap",
    "voe": "mid_cap",
    "vot": "mid_cap",
    "xjh": "mid_cap",
    "xmhq": "mid_cap",
    "xmlv": "mid_cap",
    "xmmo": "mid_cap",
    "xmvm": "mid_cap",

    # === MIN_VOL (18) ===
    "bmlwf": "min_vol",
    "dvol": "min_vol",
    "esmv": "min_vol",
    "fdlo": "min_vol",
    "fllv": "min_vol",
    "glov": "min_vol",
    "hdlb": "min_vol",
    "hdlv": "min_vol",
    "ilow": "min_vol",
    "lowv": "min_vol",
    "lvhd": "min_vol",
    "lvol": "min_vol",
    "qlv": "min_vol",
    "thlv": "min_vol",
    "usml": "min_vol",
    "usmv": "min_vol",
    "vfmv": "min_vol",
    "vsmv": "min_vol",

    # === MOMENTUM (16) ===
    "fdmo": "momentum",
    "glry": "momentum",
    "jmom": "momentum",
    "joet": "momentum",
    "mmtm": "momentum",
    "mtul": "momentum",
    "mtum": "momentum",
    "pdp": "momentum",
    "pfi": "momentum",
    "psl": "momentum",
    "pth": "momentum",
    "qmom": "momentum",
    "qqqa": "momentum",
    "romo": "momentum",
    "samm": "momentum",
    "vfmo": "momentum",

    # === MSCI_WORLD (4) ===
    "irrrf": "msci_world",
    "iwvuf": "msci_world",
    "qwld": "msci_world",
    "urth": "msci_world",

    # === MULTIFACTOR (8) ===
    "deus": "multifactor",
    "fdls": "multifactor",
    "flrg": "multifactor",
    "fsmd": "multifactor",
    "mfus": "multifactor",
    "rous": "multifactor",
    "usmf": "multifactor",
    "vfmf": "multifactor",

    # === NASDAQ100 (13) ===
    "cpnj": "nasdaq100",
    "cpnq": "nasdaq100",
    "cpns": "nasdaq100",
    "ewqqf": "nasdaq100",
    "gpiq": "nasdaq100",
    "isvaf": "nasdaq100",
    "qclr": "nasdaq100",
    "qmmy": "nasdaq100",
    "qqmg": "nasdaq100",
    "qqqm": "nasdaq100",
    "qqqt": "nasdaq100",
    "qrmi": "nasdaq100",
    "qtr": "nasdaq100",

    # === PALLADIUM (1) ===
    "pall": "palladium",

    # === PLATINUM (2) ===
    "pltm": "platinum",
    "pplt": "platinum",

    # === PRECIOUS_METALS (2) ===
    "dbp": "precious_metals",
    "gltr": "precious_metals",

    # === QUALITY (16) ===
    "fqal": "quality",
    "garp": "quality",
    "gqi": "quality",
    "jqua": "quality",
    "pset": "quality",
    "qcon": "quality",
    "qidx": "quality",
    "qlty": "quality",
    "qpff": "quality",
    "qsy": "quality",
    "qual": "quality",
    "qull": "quality",
    "roe": "quality",
    "srhq": "quality",
    "vfqy": "quality",
    "wbil": "quality",

    # === REITS (36) ===
    "area": "reits",
    "avre": "reits",
    "bbre": "reits",
    "byre": "reits",
    "cred": "reits",
    "csre": "reits",
    "dcmb": "reits",
    "dfar": "reits",
    "eret": "reits",
    "fpro": "reits",
    "frel": "reits",
    "fri": "reits",
    "haus": "reits",
    "idgt": "reits",
    "imprf": "reits",
    "inds": "reits",
    "iyr": "reits",
    "jre": "reits",
    "lpre": "reits",
    "mort": "reits",
    "mvrl": "reits",
    "netl": "reits",
    "nure": "reits",
    "pffr": "reits",
    "ppty": "reits",
    "preuf": "reits",
    "prvt": "reits",
    "psr": "reits",
    "reit": "reits",
    "rek": "reits",
    "rez": "reits",
    "rinc": "reits",
    "schh": "reits",
    "usrt": "reits",
    "vnq": "reits",
    "xlre": "reits",

    # === RUSSELL1000 (12) ===
    "eqal": "russell1000",
    "iwb": "russell1000",
    "iwd": "russell1000",
    "iwf": "russell1000",
    "omfl": "russell1000",
    "oneo": "russell1000",
    "onev": "russell1000",
    "oney": "russell1000",
    "qarp": "russell1000",
    "vone": "russell1000",
    "vong": "russell1000",
    "vonv": "russell1000",

    # === RUSSELL2000 (15) ===
    "itwo": "russell2000",
    "iwm": "russell2000",
    "iwmi": "russell2000",
    "iwn": "russell2000",
    "iwo": "russell2000",
    "omfs": "russell2000",
    "rssl": "russell2000",
    "rwm": "russell2000",
    "smdv": "russell2000",
    "srty": "russell2000",
    "urty": "russell2000",
    "vtwg": "russell2000",
    "vtwo": "russell2000",
    "vtwv": "russell2000",
    "zprvf": "russell2000",

    # === SEMICONDUCTOR (9) ===
    "besiy": "semiconductor",
    "chps": "semiconductor",
    "ftxl": "semiconductor",
    "shoc": "semiconductor",
    "smh": "semiconductor",
    "soxq": "semiconductor",
    "soxx": "semiconductor",
    "vvsmf": "semiconductor",
    "xsd": "semiconductor",

    # === SILVER_MINERS (3) ===
    "sil": "silver_miners",
    "silj": "silver_miners",
    "slvp": "silver_miners",

    # === SILVER_PHYSICAL (9) ===
    "agq": "silver_physical",
    "gbug": "silver_physical",
    "sivr": "silver_physical",
    "slv": "silver_physical",
    "slvo": "silver_physical",
    "svrzf": "silver_physical",
    "zkbsf": "silver_physical",
    "zsilf": "silver_physical",
    "zsl": "silver_physical",

    # === SMALL_CAP (98) ===
    "avds": "small_cap",
    "avdv": "small_cap",
    "avee": "small_cap",
    "brf": "small_cap",
    "bsvo": "small_cap",
    "ddls": "small_cap",
    "dfe": "small_cap",
    "dfis": "small_cap",
    "dfj": "small_cap",
    "dgs": "small_cap",
    "disv": "small_cap",
    "dls": "small_cap",
    "dwas": "small_cap",
    "dxjs": "small_cap",
    "ebit": "small_cap",
    "ecns": "small_cap",
    "eems": "small_cap",
    "esix": "small_cap",
    "eusc": "small_cap",
    "ewx": "small_cap",
    "ewzs": "small_cap",
    "fesm": "small_cap",
    "fgsm": "small_cap",
    "fscc": "small_cap",
    "grpz": "small_cap",
    "gsc": "small_cap",
    "gwx": "small_cap",
    "hscz": "small_cap",
    "ieus": "small_cap",
    "ijr": "small_cap",
    "ijs": "small_cap",
    "ijt": "small_cap",
    "imwsf": "small_cap",
    "iscb": "small_cap",
    "iscf": "small_cap",
    "iscg": "small_cap",
    "iscv": "small_cap",
    "isvl": "small_cap",
    "jhsc": "small_cap",
    "jkj": "small_cap",
    "jkk": "small_cap",
    "jpsv": "small_cap",
    "mfms": "small_cap",
    "myld": "small_cap",
    "nbct": "small_cap",
    "nbsm": "small_cap",
    "nscs": "small_cap",
    "nusc": "small_cap",
    "oasc": "small_cap",
    "ovs": "small_cap",
    "pscc": "small_cap",
    "pscd": "small_cap",
    "psce": "small_cap",
    "pscf": "small_cap",
    "psch": "small_cap",
    "pscm": "small_cap",
    "psct": "small_cap",
    "pscu": "small_cap",
    "pxsv": "small_cap",
    "qvms": "small_cap",
    "rdte": "small_cap",
    "rogs": "small_cap",
    "rois": "small_cap",
    "rosc": "small_cap",
    "rwj": "small_cap",
    "rzg": "small_cap",
    "rzv": "small_cap",
    "scap": "small_cap",
    "scdv": "small_cap",
    "schc": "small_cap",
    "scif": "small_cap",
    "scj": "small_cap",
    "scz": "small_cap",
    "seis": "small_cap",
    "sflo": "small_cap",
    "sixs": "small_cap",
    "slyg": "small_cap",
    "slyv": "small_cap",
    "smdx": "small_cap",
    "smin": "small_cap",
    "smll": "small_cap",
    "spsm": "small_cap",
    "sqlv": "small_cap",
    "stxk": "small_cap",
    "tmfs": "small_cap",
    "vb": "small_cap",
    "vbk": "small_cap",
    "vbr": "small_cap",
    "viog": "small_cap",
    "vioo": "small_cap",
    "viov": "small_cap",
    "wsml": "small_cap",
    "xjr": "small_cap",
    "xshd": "small_cap",
    "xshq": "small_cap",
    "xslv": "small_cap",
    "xsmo": "small_cap",
    "xsvm": "small_cap",

    # === SP500 (104) ===
    "cath": "sp500",
    "cpsa": "sp500",
    "cpsf": "sp500",
    "cpsj": "sp500",
    "cpsm": "sp500",
    "cpsy": "sp500",
    "cstnl": "sp500",
    "divg": "sp500",
    "efiv": "sp500",
    "emot": "sp500",
    "ewco": "sp500",
    "ewre": "sp500",
    "fcfy": "sp500",
    "ftki": "sp500",
    "gpix": "sp500",
    "imsxf": "sp500",
    "invmf": "sp500",
    "issxf": "sp500",
    "ive": "sp500",
    "ivv": "sp500",
    "ivw": "sp500",
    "jepy": "sp500",
    "kng": "sp500",
    "kngz": "sp500",
    "nobl": "sp500",
    "phdg": "sp500",
    "putd": "sp500",
    "pxlv": "sp500",
    "qdiv": "sp500",
    "qvml": "sp500",
    "rcd": "sp500",
    "rgi": "sp500",
    "rpg": "sp500",
    "rpv": "sp500",
    "rsp": "sp500",
    "rspa": "sp500",
    "rspc": "sp500",
    "rspd": "sp500",
    "rspe": "sp500",
    "rspf": "sp500",
    "rspg": "sp500",
    "rsph": "sp500",
    "rspm": "sp500",
    "rspn": "sp500",
    "rspr": "sp500",
    "rsps": "sp500",
    "rspt": "sp500",
    "rspu": "sp500",
    "rtm": "sp500",
    "rwl": "sp500",
    "rye": "sp500",
    "ryf": "sp500",
    "ryh": "sp500",
    "ryt": "sp500",
    "ryu": "sp500",
    "sh": "sp500",
    "snpe": "sp500",
    "snpg": "sp500",
    "snpv": "sp500",
    "spdg": "sp500",
    "spdn": "sp500",
    "spdv": "sp500",
    "spgp": "sp500",
    "sphb": "sp500",
    "sphd": "sp500",
    "sphq": "sp500",
    "splg": "sp500",
    "splv": "sp500",
    "spmo": "sp500",
    "spmv": "sp500",
    "spvm": "sp500",
    "spvu": "sp500",
    "spxe": "sp500",
    "spxn": "sp500",
    "spxt": "sp500",
    "spxu": "sp500",
    "spxv": "sp500",
    "spy": "sp500",
    "spyd": "sp500",
    "spyg": "sp500",
    "spyi": "sp500",
    "spyt": "sp500",
    "spyu": "sp500",
    "spyv": "sp500",
    "spyx": "sp500",
    "ssspf": "sp500",
    "upro": "sp500",
    "voo": "sp500",
    "voog": "sp500",
    "voov": "sp500",
    "wdte": "sp500",
    "xclr": "sp500",
    "xlg": "sp500",
    "xpay": "sp500",
    "xrlv": "sp500",
    "xrmi": "sp500",
    "xspuf": "sp500",
    "xtr": "sp500",
    "xvv": "sp500",
    "xxxx": "sp500",
    "xyld.eu": "sp500",
    "xyld.iv": "sp500",
    "xyld.nv": "sp500",
    "xyld.tc": "sp500",

    # === TECH (33) ===
    "arkq": "tech",
    "arty": "tech",
    "bai": "tech",
    "batt": "tech",
    "carz": "tech",
    "chat": "tech",
    "crtc": "tech",
    "dtre": "tech",
    "fdtx": "tech",
    "ftec": "tech",
    "fxl": "tech",
    "hao": "tech",
    "irbo": "tech",
    "iteq": "tech",
    "ittsf": "tech",
    "ivrs": "tech",
    "iyw": "tech",
    "izrl": "tech",
    "jtek": "tech",
    "lfgy": "tech",
    "llyx": "tech",
    "lrnz": "tech",
    "moto": "tech",
    "ptf": "tech",
    "qqxt": "tech",
    "qtec": "tech",
    "semi": "tech",
    "urax": "tech",
    "vgt": "tech",
    "xitk": "tech",
    "xlk": "tech",
    "xntk": "tech",
    "xpnd": "tech",

    # === URANIUM (3) ===
    "uran": "uranium",
    "urnj": "uranium",
    "urnm": "uranium",

    # === US_LARGE_CAP (100) ===
    "aflg": "us_large_cap",
    "amom": "us_large_cap",
    "aprp": "us_large_cap",
    "aprt": "us_large_cap",
    "aprw": "us_large_cap",
    "augt": "us_large_cap",
    "augw": "us_large_cap",
    "avlc": "us_large_cap",
    "avlv": "us_large_cap",
    "azaa": "us_large_cap",
    "azaj": "us_large_cap",
    "azal": "us_large_cap",
    "azao": "us_large_cap",
    "azba": "us_large_cap",
    "azbl": "us_large_cap",
    "azbo": "us_large_cap",
    "bcus": "us_large_cap",
    "bklc": "us_large_cap",
    "cdei": "us_large_cap",
    "cdl": "us_large_cap",
    "csm": "us_large_cap",
    "cvlc": "us_large_cap",
    "dect": "us_large_cap",
    "decw": "us_large_cap",
    "dflv": "us_large_cap",
    "dfvx": "us_large_cap",
    "dln": "us_large_cap",
    "dubs": "us_large_cap",
    "dval": "us_large_cap",
    "eps": "us_large_cap",
    "febt": "us_large_cap",
    "febw": "us_large_cap",
    "fex": "us_large_cap",
    "flce": "us_large_cap",
    "flql": "us_large_cap",
    "flv": "us_large_cap",
    "fta": "us_large_cap",
    "ftc": "us_large_cap",
    "grny": "us_large_cap",
    "gsew": "us_large_cap",
    "gslc": "us_large_cap",
    "hegd": "us_large_cap",
    "iqsu": "us_large_cap",
    "iwfg": "us_large_cap",
    "jant": "us_large_cap",
    "janu": "us_large_cap",
    "janw": "us_large_cap",
    "jneu": "us_large_cap",
    "julp": "us_large_cap",
    "jult": "us_large_cap",
    "julu": "us_large_cap",
    "julw": "us_large_cap",
    "junp": "us_large_cap",
    "junt": "us_large_cap",
    "junw": "us_large_cap",
    "jusa": "us_large_cap",
    "just": "us_large_cap",
    "lcf": "us_large_cap",
    "lglv": "us_large_cap",
    "lqai": "us_large_cap",
    "lrgc": "us_large_cap",
    "lrnd": "us_large_cap",
    "mart": "us_large_cap",
    "marw": "us_large_cap",
    "mayt": "us_large_cap",
    "mayw": "us_large_cap",
    "mmlg": "us_large_cap",
    "mrcp": "us_large_cap",
    "novp": "us_large_cap",
    "nvbt": "us_large_cap",
    "nvbw": "us_large_cap",
    "oakm": "us_large_cap",
    "octt": "us_large_cap",
    "octw": "us_large_cap",
    "pbap": "us_large_cap",
    "pbau": "us_large_cap",
    "pbmr": "us_large_cap",
    "pbmy": "us_large_cap",
    "pbse": "us_large_cap",
    "pgro": "us_large_cap",
    "ptlc": "us_large_cap",
    "qdpl": "us_large_cap",
    "qlc": "us_large_cap",
    "qrft": "us_large_cap",
    "rnlc": "us_large_cap",
    "sawg": "us_large_cap",
    "schg": "us_large_cap",
    "schv": "us_large_cap",
    "schx": "us_large_cap",
    "seim": "us_large_cap",
    "seiq": "us_large_cap",
    "seiv": "us_large_cap",
    "selv": "us_large_cap",
    "sepp": "us_large_cap",
    "sept": "us_large_cap",
    "sepu": "us_large_cap",
    "sepw": "us_large_cap",
    "sglc": "us_large_cap",
    "spbw": "us_large_cap",
    "utrn": "us_large_cap",

    # === US_MID_CAP (33) ===
    "afmc": "us_mid_cap",
    "avmc": "us_mid_cap",
    "avmv": "us_mid_cap",
    "bbmc": "us_mid_cap",
    "bkmc": "us_mid_cap",
    "bsmc": "us_mid_cap",
    "cgmm": "us_mid_cap",
    "cvmc": "us_mid_cap",
    "don": "us_mid_cap",
    "ezm": "us_mid_cap",
    "flqm": "us_mid_cap",
    "fnk": "us_mid_cap",
    "fnx": "us_mid_cap",
    "fny": "us_mid_cap",
    "fscs": "us_mid_cap",
    "fsmo": "us_mid_cap",
    "iqsm": "us_mid_cap",
    "iwp": "us_mid_cap",
    "iwr": "us_mid_cap",
    "iws": "us_mid_cap",
    "jpme": "us_mid_cap",
    "jsmd": "us_mid_cap",
    "kmid": "us_mid_cap",
    "mdy": "us_mid_cap",
    "pjfm": "us_mid_cap",
    "ptmc": "us_mid_cap",
    "rnmc": "us_mid_cap",
    "schm": "us_mid_cap",
    "sdvy": "us_mid_cap",
    "ssdrf": "us_mid_cap",
    "tplc": "us_mid_cap",
    "tple": "us_mid_cap",
    "usvm": "us_mid_cap",

    # === US_SMALL_CAP (45) ===
    "avsc": "us_small_cap",
    "avuv": "us_small_cap",
    "bbsc": "us_small_cap",
    "bkse": "us_small_cap",
    "cafg": "us_small_cap",
    "calf": "us_small_cap",
    "cplcf": "us_small_cap",
    "csa": "us_small_cap",
    "csb": "us_small_cap",
    "des": "us_small_cap",
    "dfas": "us_small_cap",
    "dfsv": "us_small_cap",
    "dgrs": "us_small_cap",
    "ees": "us_small_cap",
    "esml": "us_small_cap",
    "fdts": "us_small_cap",
    "fem": "us_small_cap",
    "fems": "us_small_cap",
    "flqs": "us_small_cap",
    "fyc": "us_small_cap",
    "fyt": "us_small_cap",
    "fyx": "us_small_cap",
    "jpse": "us_small_cap",
    "jsml": "us_small_cap",
    "kaug": "us_small_cap",
    "kjun": "us_small_cap",
    "mmsc": "us_small_cap",
    "oscv": "us_small_cap",
    "ousm": "us_small_cap",
    "psc": "us_small_cap",
    "psci": "us_small_cap",
    "rbuf": "us_small_cap",
    "saug": "us_small_cap",
    "saws": "us_small_cap",
    "scha": "us_small_cap",
    "scy": "us_small_cap",
    "smay": "us_small_cap",
    "smcf": "us_small_cap",
    "smlf": "us_small_cap",
    "smlv": "us_small_cap",
    "smmv": "us_small_cap",
    "snov": "us_small_cap",
    "sval": "us_small_cap",
    "tpsc": "us_small_cap",
    "vss": "us_small_cap",

    # === US_TOTAL_MARKET (3) ===
    "itot": "us_total_market",
    "tusa": "us_total_market",
    "vti": "us_total_market",

    # === UTILITIES (7) ===
    "futy": "utilities",
    "fxu": "utilities",
    "idu": "utilities",
    "pui": "utilities",
    "utes": "utilities",
    "vpu": "utilities",
    "xlu": "utilities",

    # === VALUE (60) ===
    "abeq": "value",
    "aivc": "value",
    "aivl": "value",
    "aslv": "value",
    "avgv": "value",
    "bamv": "value",
    "busa": "value",
    "camx": "value",
    "copy": "value",
    "dfat": "value",
    "dfuv": "value",
    "dstl": "value",
    "dvp": "value",
    "ecml": "value",
    "efv": "value",
    "fab": "value",
    "fbcv": "value",
    "fdvl": "value",
    "fovl": "value",
    "fval": "value",
    "gmov": "value",
    "gvlu": "value",
    "gvus": "value",
    "hygv": "value",
    "ilcv": "value",
    "itan": "value",
    "iusv": "value",
    "ives": "value",
    "ivlu": "value",
    "iwdl": "value",
    "iwx": "value",
    "java": "value",
    "jval": "value",
    "kvle": "value",
    "lsvd": "value",
    "mavf": "value",
    "mgv": "value",
    "mval": "value",
    "mvpl": "value",
    "nxtv": "value",
    "pjfv": "value",
    "pval": "value",
    "py": "value",
    "quvu": "value",
    "qval": "value",
    "revs": "value",
    "stxv": "value",
    "tval": "value",
    "ulvm": "value",
    "valq": "value",
    "vamo": "value",
    "vfva": "value",
    "vlu": "value",
    "vlue": "value",
    "vmax": "value",
    "vmot": "value",
    "vtv": "value",
    "wbat": "value",
    "wbif": "value",
    "wtv": "value",
}

# =============================================================================
# KEYWORD_PATTERNS - Regex avec word boundaries pour fallback sur nom ETF
# Ordre = priorité (plus spécifique en premier)
# =============================================================================
KEYWORD_PATTERNS = [
    # Métaux précieux
    (r"\bsilver\b(?!.*miner)", "silver_physical"),
    (r"\bsilver.*miner", "silver_miners"),
    (r"\bgold\b(?!.*miner)", "gold_physical"),
    (r"\bgold.*miner", "gold_miners"),
    (r"\bplatinum\b", "platinum"),
    (r"\bpalladium\b", "palladium"),
    (r"precious\s*metal", "precious_metals"),
    
    # Crypto
    (r"\bbitcoin\b", "btc_etf"),
    (r"\bethereum\b", "eth_etf"),
    
    # Leveraged / Inverse (AVANT autres catégories)
    (r"\b3x\b.*\bbull\b|\bbull\b.*\b3x\b", "leveraged_3x_bull"),
    (r"\b3x\b.*\bbear\b|\bbear\b.*\b3x\b", "leveraged_3x_bear"),
    (r"\b2x\b.*\bbull\b|\bbull\b.*\b2x\b|\bultra\b(?!.*short)", "leveraged_2x_bull"),
    (r"\b2x\b.*\bbear\b|\bbear\b.*\b2x\b|\bultrashort\b", "leveraged_2x_bear"),
    (r"\binverse\b", "inverse"),
    
    # Structured products
    (r"\bbuffer\b|\bdefined\s*outcome", "buffer"),
    (r"covered\s*call|buy.?write", "covered_call"),
    
    # Indices US
    (r"s&p\s*500|s&p500", "sp500"),
    (r"\bnasdaq\s*100\b", "nasdaq100"),
    (r"\brussell\s*2000\b", "russell2000"),
    (r"\brussell\s*1000\b", "russell1000"),
    (r"\bdow\s*jones\b|\bdow\s*30\b", "dow30"),
    (r"total.*stock.*market|total.*us.*market", "us_total_market"),
    
    # Taille (US spécifique d'abord)
    (r"(?:us|u\.s\.).*large.?cap|large.?cap.*(?:us|u\.s\.)", "us_large_cap"),
    (r"(?:us|u\.s\.).*mid.?cap|mid.?cap.*(?:us|u\.s\.)", "us_mid_cap"),
    (r"(?:us|u\.s\.).*small.?cap|small.?cap.*(?:us|u\.s\.)", "us_small_cap"),
    (r"\blarge.?cap\b", "large_cap"),
    (r"\bmid.?cap\b", "mid_cap"),
    (r"\bsmall.?cap\b", "small_cap"),
    
    # Global / World
    (r"\bacwi\b", "acwi"),
    (r"\bmsci\s*world\b", "msci_world"),
    (r"\bglobal\b(?!.*bond)(?!.*fixed)", "global_equity"),
    
    # Régions
    (r"\bemerging\s*market|\bemerging\b", "emerging_markets"),
    (r"\bdeveloped\s*market|ftse\s*developed", "developed_markets"),
    (r"\binternational\b(?!.*bond)", "international"),
    (r"\beurope\b|\beurozone\b|\bstoxx\b", "europe"),
    (r"\bjapan\b", "japan"),
    (r"\bchina\b|\bcsi\s*\d+", "china"),
    (r"\bindia\b", "india"),
    
    # Facteurs
    (r"\bequal\s*weight", "equal_weight"),
    (r"multi.?factor", "multifactor"),
    (r"\bminimum\s*volatility\b|\blow\s*volatility\b|\bmin\s*vol\b", "min_vol"),
    (r"\bdividend\b", "dividend"),
    (r"\bvalue\b", "value"),
    (r"\bgrowth\b", "growth"),
    (r"\bmomentum\b", "momentum"),
    (r"\bquality\b", "quality"),
    (r"\besg\b|\bsustainable\b|\bresponsible\b", "esg"),
    
    # Obligations
    (r"\btreasury\b", "bonds_treasury"),
    (r"\bmunicipal\b|\bmuni\b", "bonds_muni"),
    (r"\bhigh\s*yield\b", "bonds_hy"),
    (r"\binvestment\s*grade\b", "bonds_ig"),
    
    # Secteurs
    (r"\btechnology\b", "tech"),
    (r"\bsemiconductor\b", "semiconductor"),
    (r"\bhealthcare\b", "healthcare"),
    (r"\bbiotech\b", "biotech"),
    (r"\bfinancial\b(?!.*ex)", "financials"),
    (r"\benergy\b", "energy"),
    (r"\breal\s*estate\b|\breit\b", "reits"),
    (r"\butilities\b", "utilities"),
    
    # Commodities
    (r"\bcommodit", "commodities"),
    (r"\bcopper\b", "copper"),
    (r"\buranium\b", "uranium"),
]


@lru_cache(maxsize=1)
def _compiled_patterns():
    """Compile les regex une seule fois (cached)."""
    return [(re.compile(pattern, re.IGNORECASE), exposure) 
            for pattern, exposure in KEYWORD_PATTERNS]


def detect_etf_exposure(name: str, ticker: str = "", fund_type: str = "") -> Optional[str]:
    """
    Détecte l'exposition d'un ETF.
    
    Stratégie :
    1. Lookup direct sur ticker (O(1), pas de regex)
    2. Fallback sur regex avec word boundaries sur nom + fund_type
    
    Args:
        name: Nom de l'ETF
        ticker: Symbol/ticker
        fund_type: Type de fonds (optionnel)
    
    Returns:
        Exposure standardisée ou None si non identifiable
    """
    # 1. Lookup direct sur ticker (priorité absolue)
    ticker_lower = (ticker or "").lower().strip()
    if ticker_lower and ticker_lower in TICKER_TO_EXPOSURE:
        return TICKER_TO_EXPOSURE[ticker_lower]
    
    # 2. Fallback regex sur nom (avec word boundaries = safe)
    search_text = f"{name} {fund_type}".lower()
    
    for pattern, exposure in _compiled_patterns():
        if pattern.search(search_text):
            return exposure
    
    return None


# =============================================================================
# TESTS
# =============================================================================
if __name__ == "__main__":
    tests = [
        # Silver (bug original)
        ("iShares Silver Trust", "SLV", "silver_physical"),
        ("abrdn Physical Silver Shares ETF", "SIVR", "silver_physical"),
        
        # Gold
        ("SPDR Gold MiniShares Trust", "GLDM", "gold_physical"),
        ("VanEck Gold Miners ETF", "GDX", "gold_miners"),
        
        # S&P 500 (doit matcher même sans ticker connu)
        ("SPDR S&P 500 ETF Trust", "SPY", "sp500"),
        ("Some Random S&P 500 Fund", "", "sp500"),
        
        # Leveraged
        ("ProShares Ultra S&P500", "SSO", "leveraged_2x_bull"),
        ("Direxion Daily S&P 500 Bull 3X", "SPXL", "leveraged_3x_bull"),
        
        # Faux positifs potentiels (vrais tickers = doivent matcher leur catégorie)
        ("Encore Energy Corp", "EU", "energy"),
        ("Direxion Auspice Broad Commodity Strategy ETF", "COM", "commodities"),
        ("American Century Mid Cap Growth Fund", "MID", "mid_cap"),
    ]
    
    print("=== TESTS ===")
    passed = 0
    for name, ticker, expected in tests:
        result = detect_etf_exposure(name, ticker)
        status = "✓" if result == expected else "✗"
        if result == expected:
            passed += 1
        print(f"{status} {ticker or 'N/A':6} | Expected: {str(expected):20} | Got: {str(result):20}")
    
    print(f"\nPassed: {passed}/{len(tests)}")
