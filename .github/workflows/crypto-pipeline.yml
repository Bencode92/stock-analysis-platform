name: ðŸª™ Crypto Data Pipeline

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GÃˆRE: DonnÃ©es et analyse crypto (volatilitÃ©, momentum)
# SCRIPTS: scripts/update-crypto-data.py + scripts/crypto-volatility-return.js
# HORAIRE: 03:30 Paris (nuit, avant volume filter 04:00)
# DURÃ‰E: ~1 minute
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if data exists'
        required: false
        default: 'false'
      vol_interval:
        description: 'Volatility calculation interval (1day or 1h)'
        required: false
        default: '1day'
      min_vol_30d:
        description: 'Minimum 30d volatility % (default: 30)'
        required: false
        default: '30'
      max_vol_30d:
        description: 'Maximum 30d volatility % (default: 500)'
        required: false
        default: '500'
      min_ret_7d:
        description: 'Minimum 7d return % (default: -50)'
        required: false
        default: '-50'

  schedule:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸŒ™ NUIT (03:30 Paris) - avant volume filter (04:00)
    # Ã©tÃ©: 01:30 UTC | hiver: 02:30 UTC
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - cron: '30 1 * * *'
    - cron: '30 2 * * *'

concurrency:
  group: repo-writes-global
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Gate
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  gate:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.detect.outputs.should_run }}
      
    steps:
      - name: ðŸ• Detect if we should run
        id: detect
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "âœ… Manual trigger"
            exit 0
          fi
          
          PARIS=$(TZ=Europe/Paris date +%H%M)
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“ Paris time: $PARIS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Window: 03:25 - 03:35 Paris
          if [ "$PARIS" -ge "0325" ] && [ "$PARIS" -le "0335" ]; then
            echo "ðŸª™ Crypto pipeline window detected"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ Skipped: PARIS=$PARIS not in window (03:25-03:35)"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Update Crypto Data
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-crypto-data:
    needs: gate
    if: needs.gate.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      data_updated: ${{ steps.update.outputs.updated }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: pip install -r requirements.txt || pip install requests pandas

      - name: ðŸª™ Update crypto data
        id: update
        env:
          TWELVE_DATA_API_KEY: ${{ secrets.TWELVE_DATA_API }}
          FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸª™ Mise Ã  jour des donnÃ©es crypto"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ -f "data/Crypto.csv" ]; then
            LAST_MODIFIED=$(date -r data/Crypto.csv +%s)
            NOW=$(date +%s)
            AGE=$((NOW - LAST_MODIFIED))
            HOURS=$((AGE / 3600))
            echo "ðŸ“… DerniÃ¨re mise Ã  jour il y a $HOURS heures"
            
            if [ "$FORCE_UPDATE" = "false" ] && [ $HOURS -lt 24 ]; then
              echo "â­ï¸ DonnÃ©es rÃ©centes, pas de mise Ã  jour nÃ©cessaire"
              echo "updated=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          if [ -f "scripts/update-crypto-data.py" ]; then
            python scripts/update-crypto-data.py
          else
            echo "âš ï¸ Script non trouvÃ©, utilisation des donnÃ©es existantes"
          fi
          
          echo "updated=true" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Commit updated data
        if: steps.update.outputs.updated == 'true'
        run: |
          set -e
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          
          git add data/Crypto.csv 2>/dev/null || true
          git add data/crypto_lists.json 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes"
            exit 0
          fi
          
          TS=$(date -u +'%Y-%m-%d %H:%M UTC')
          git commit -m "ðŸª™ Crypto data update - $TS [skip ci]"
          
          BRANCH="${GITHUB_REF_NAME:-main}"
          for i in 1 2 3; do
            git fetch origin && git rebase "origin/$BRANCH" || git rebase --abort || true
            git push origin "HEAD:$BRANCH" && echo "âœ… Push OK" && exit 0
            sleep $((RANDOM%5+2))
          done
          exit 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Analyze and Filter Cryptos
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  analyze-and-filter-cryptos:
    needs: [gate, update-crypto-data]
    if: needs.gate.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: ðŸ“Š Run crypto volatility analysis
        env:
          TWELVE_DATA_API_KEY: ${{ secrets.TWELVE_DATA_API }}
          DATA_DIR: data
          OUTPUT_DIR: data/filtered
          VOL_INTERVAL: ${{ github.event.inputs.vol_interval || '1day' }}
          MIN_VOL_30D: ${{ github.event.inputs.min_vol_30d || '30' }}
          MAX_VOL_30D: ${{ github.event.inputs.max_vol_30d || '500' }}
          MIN_RET_7D: ${{ github.event.inputs.min_ret_7d || '-50' }}
          LOOKBACK_DAYS: 120
          MAX_STALE_HOURS: 48
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“Š Analyse volatilitÃ© (interval: $VOL_INTERVAL)"
          echo "   Vol30d: $MIN_VOL_30D-$MAX_VOL_30D%, Ret7d > $MIN_RET_7D%"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          node scripts/crypto-volatility-return.js

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: crypto-analysis-${{ github.run_number }}
          path: |
            data/filtered/Crypto_filtered_volatility.csv
            data/filtered/Crypto_rejected_volatility.csv
            data/filtered/Top10_momentum.csv
            data/filtered/Top10_volatility.csv
          retention-days: 7

      - name: ðŸ’¾ Commit results
        run: |
          set -e
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          
          git add data/filtered/*.csv 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes"
            exit 0
          fi
          
          TS=$(date -u +'%Y-%m-%d %H:%M UTC')
          git commit -m "ðŸª™ Crypto analysis - $TS [skip ci]"
          
          BRANCH="${GITHUB_REF_NAME:-main}"
          for i in 1 2 3; do
            git fetch origin && git rebase "origin/$BRANCH" || git rebase --abort || true
            git push origin "HEAD:$BRANCH" && echo "âœ… Push OK" && exit 0
            sleep $((RANDOM%5+2))
          done
          exit 1

      - name: ðŸ“‹ Generate summary
        if: always()
        run: |
          echo "# ðŸª™ Crypto Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/filtered/Crypto_filtered_volatility.csv" ]; then
            TOTAL=$(tail -n +2 data/Crypto.csv 2>/dev/null | wc -l || echo "0")
            ACCEPTED=$(tail -n +2 data/filtered/Crypto_filtered_volatility.csv 2>/dev/null | wc -l || echo "0")
            
            echo "## ðŸ“ˆ Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Total:** $TOTAL cryptos" >> $GITHUB_STEP_SUMMARY
            echo "- **âœ… Accepted:** $ACCEPTED cryptos" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "data/filtered/Top10_momentum.csv" ]; then
              echo "### ðŸš€ Top 5 Momentum" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -n +2 data/filtered/Top10_momentum.csv | head -5 | \
                awk -F',' '{printf "%-12s %7s%%\n", $1, $9}' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi
