name: Crypto Data Pipeline

on:
  schedule:
    # Exécution quotidienne à 2h30 UTC (avant le filtrage)
    - cron: '30 2 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if data exists'
        required: false
        default: 'false'
      run_filter:
        description: 'Run volume filtering after update'
        required: false
        default: 'true'
      run_volatility:
        description: 'Run volatility analysis after update'
        required: false
        default: 'true'
      vol_interval:
        description: 'Volatility calculation interval (1day or 1h)'
        required: false
        default: '1day'

jobs:
  update-crypto-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      data_updated: ${{ steps.update.outputs.updated }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt || pip install requests pandas
    
    - name: Update crypto data
      id: update
      env:
        TWELVE_DATA_API_KEY: ${{ secrets.TWELVE_DATA_API }}
        FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
      run: |
        echo "🔄 Mise à jour des données crypto"
        
        # Vérifier si le fichier existe et sa date
        if [ -f "data/Crypto.csv" ]; then
          LAST_MODIFIED=$(date -r data/Crypto.csv +%s)
          NOW=$(date +%s)
          AGE=$((NOW - LAST_MODIFIED))
          HOURS=$((AGE / 3600))
          echo "📅 Dernière mise à jour il y a $HOURS heures"
          
          if [ "$FORCE_UPDATE" = "false" ] && [ $HOURS -lt 24 ]; then
            echo "⏭️ Données récentes, pas de mise à jour nécessaire"
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
        fi
        
        # Exécuter le script de mise à jour (à créer si nécessaire)
        if [ -f "scripts/update-crypto-data.py" ]; then
          python scripts/update-crypto-data.py
        else
          echo "⚠️ Script de mise à jour non trouvé, utilisation des données existantes"
        fi
        
        echo "updated=true" >> $GITHUB_OUTPUT
    
    - name: Commit updated data
      if: steps.update.outputs.updated == 'true'
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        git add data/Crypto.csv || true
        git add data/crypto_lists.json || true
        git diff --staged --quiet || git commit -m "Update crypto data [skip ci]"
        git push

  filter-cryptos-volume:
    needs: update-crypto-data
    if: github.event.inputs.run_filter != 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}  # Pull latest changes
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run crypto volume filtering
      id: filter
      env:
        TWELVE_DATA_API_KEY: ${{ secrets.TWELVE_DATA_API }}
        DATA_DIR: data
        OUTPUT_DIR: data/filtered
        MIN_USD_DAY: 1000000
        MIN_USD_AVG7D: 2000000
      run: |
        echo "🚀 Filtrage des crypto-monnaies par volume"
        node scripts/crypto-filter-by-volume.js
    
    - name: Upload filtered data
      uses: actions/upload-artifact@v4
      with:
        name: crypto-volume-results
        path: |
          data/filtered/Crypto_filtered_by_volume.csv
          data/filtered/Crypto_rejected_by_volume.csv
        retention-days: 30
    
    - name: Commit filtered data
      if: success()
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        git add data/filtered/Crypto_filtered_by_volume.csv || true
        git add data/filtered/Crypto_rejected_by_volume.csv || true
        git diff --staged --quiet || git commit -m "Update filtered crypto data (volume) [skip ci]"
        git push

  analyze-crypto-volatility:
    needs: update-crypto-data
    if: github.event.inputs.run_volatility != 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}  # Pull latest changes
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run crypto volatility analysis
      id: volatility
      env:
        TWELVE_DATA_API_KEY: ${{ secrets.TWELVE_DATA_API }}
        DATA_DIR: data
        OUTPUT_DIR: data/metrics
        VOL_INTERVAL: ${{ github.event.inputs.vol_interval || '1day' }}
        LOOKBACK_DAYS: 120
      run: |
        echo "📊 Analyse de volatilité et rendements (interval: $VOL_INTERVAL)"
        node scripts/crypto-volatility-return.js
    
    - name: Upload volatility results
      uses: actions/upload-artifact@v4
      with:
        name: crypto-volatility-results
        path: |
          data/metrics/Crypto_returns_vol_*.csv
          data/metrics/TopVol_*.csv
          data/metrics/TopRet30d_*.csv
        retention-days: 30
    
    - name: Commit volatility data
      if: success()
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        git add data/metrics/*.csv || true
        git diff --staged --quiet || git commit -m "Update crypto volatility metrics [skip ci]"
        git push
    
    - name: Generate volatility summary
      if: success()
      run: |
        INTERVAL="${{ github.event.inputs.vol_interval || '1day' }}"
        echo "## 📈 Analyse de Volatilité ($INTERVAL)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "data/metrics/Crypto_returns_vol_${INTERVAL}.csv" ]; then
          TOTAL=$(tail -n +2 data/metrics/Crypto_returns_vol_${INTERVAL}.csv | wc -l)
          VALID=$(tail -n +2 data/metrics/Crypto_returns_vol_${INTERVAL}.csv | grep -v "insufficient_history" | grep -v "error:" | wc -l)
          
          echo "- **Total analysé:** $TOTAL cryptos" >> $GITHUB_STEP_SUMMARY
          echo "- **Analyses valides:** $VALID cryptos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Top 5 momentum
          echo "### 🚀 Top 5 Momentum (30j)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ -f "data/metrics/TopRet30d_${INTERVAL}.csv" ]; then
            echo "Symbol,Exchange,Return_30d,Volatility_30d" >> $GITHUB_STEP_SUMMARY
            tail -n +2 data/metrics/TopRet30d_${INTERVAL}.csv | \
              head -5 | \
              cut -d',' -f1,4,9,11 | \
              column -t -s, >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Top 5 volatilité
          echo "### ⚡ Top 5 Volatilité (30j annualisée)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ -f "data/metrics/TopVol_${INTERVAL}.csv" ]; then
            echo "Symbol,Exchange,Volatility_30d,Return_30d" >> $GITHUB_STEP_SUMMARY
            tail -n +2 data/metrics/TopVol_${INTERVAL}.csv | \
              head -5 | \
              cut -d',' -f1,4,11,9 | \
              column -t -s, >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

  create-summary:
    needs: [update-crypto-data, filter-cryptos-volume, analyze-crypto-volatility]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Create final summary
      run: |
        echo "# 📊 Pipeline de Données Crypto - Résumé" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # État de la mise à jour
        echo "## 🔄 État des Jobs" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.update-crypto-data.result }}" = "success" ]; then
          echo "✅ **Mise à jour des données:** Succès" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Mise à jour des données:** Échec" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.filter-cryptos-volume.result }}" = "success" ]; then
          echo "✅ **Filtrage par volume:** Succès" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.filter-cryptos-volume.result }}" = "skipped" ]; then
          echo "⏭️ **Filtrage par volume:** Ignoré" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Filtrage par volume:** Échec" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.analyze-crypto-volatility.result }}" = "success" ]; then
          echo "✅ **Analyse volatilité:** Succès" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.analyze-crypto-volatility.result }}" = "skipped" ]; then
          echo "⏭️ **Analyse volatilité:** Ignoré" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Analyse volatilité:** Échec" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "⏰ **Exécuté le:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "🔧 **Déclenché par:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "👤 **Par:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        fi
