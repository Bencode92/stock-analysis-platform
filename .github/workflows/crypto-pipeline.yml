name: ðŸª™ Crypto Data Pipeline

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GÃˆRE: DonnÃ©es et analyse crypto (volatilitÃ©, momentum)
# SCRIPTS: scripts/update-crypto-data.py + scripts/crypto-volatility-return.js
# HORAIRES: 00:00, 08:40, 14:00, 18:30 Paris
# DURÃ‰E: ~1 minute
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if data exists'
        required: false
        default: 'false'
      vol_interval:
        description: 'Volatility calculation interval (1day or 1h)'
        required: false
        default: '1day'
      min_vol_30d:
        description: 'Minimum 30d volatility % (default: 10)'
        required: false
        default: '10'
      max_vol_30d:
        description: 'Maximum 30d volatility % (default: 500)'
        required: false
        default: '500'
      min_ret_7d:
        description: 'Minimum 7d return % (default: -50)'
        required: false
        default: '-50'

  schedule:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸŒ™ MINUIT (00:00 Paris)
    # Ã©tÃ©: 22:00 UTC (J-1) | hiver: 23:00 UTC (J-1)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - cron: '0 22 * * *'
    - cron: '0 23 * * *'
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # â˜€ï¸ MATIN (08:40 Paris) - avant markets/sectors
    # Ã©tÃ©: 06:40 UTC | hiver: 07:40 UTC
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - cron: '40 6 * * *'
    - cron: '40 7 * * *'
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸŒ… APRES-MIDI (14:00 Paris) - avant US open
    # Ã©tÃ©: 12:00 UTC | hiver: 13:00 UTC
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - cron: '0 12 * * *'
    - cron: '0 13 * * *'
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸŒ† SOIR (18:30 Paris) - aprÃ¨s Europe close
    # Ã©tÃ©: 16:30 UTC | hiver: 17:30 UTC
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - cron: '30 16 * * *'
    - cron: '30 17 * * *'

concurrency:
  group: repo-writes-global
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Gate - fenÃªtres Ã©largies Ã  Â±20 min pour absorber les dÃ©lais GitHub
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  gate:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.detect.outputs.should_run }}
      session: ${{ steps.detect.outputs.session }}
      
    steps:
      - name: ðŸ• Detect if we should run
        id: detect
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "session=manual" >> $GITHUB_OUTPUT
            echo "âœ… Manual trigger"
            exit 0
          fi
          
          PARIS=$(TZ=Europe/Paris date +%H%M)
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“ Paris time: $PARIS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          SESSION=""
          
          # Minuit: 23:45 - 00:20 Paris (fenÃªtre Ã©largie)
          if [ "$PARIS" -ge "2345" ] || [ "$PARIS" -le "0020" ]; then
            SESSION="midnight"
            echo "ðŸŒ™ MIDNIGHT window detected"
            
          # Matin: 08:25 - 09:00 Paris (fenÃªtre Ã©largie)
          elif [ "$PARIS" -ge "0825" ] && [ "$PARIS" -le "0900" ]; then
            SESSION="morning"
            echo "â˜€ï¸ MORNING window detected"
            
          # AprÃ¨s-midi: 13:45 - 14:20 Paris (fenÃªtre Ã©largie)
          elif [ "$PARIS" -ge "1345" ] && [ "$PARIS" -le "1420" ]; then
            SESSION="afternoon"
            echo "ðŸŒ… AFTERNOON window detected"
            
          # Soir: 18:15 - 18:50 Paris (fenÃªtre Ã©largie)
          elif [ "$PARIS" -ge "1815" ] && [ "$PARIS" -le "1850" ]; then
            SESSION="evening"
            echo "ðŸŒ† EVENING window detected"
          fi
          
          if [ -n "$SESSION" ]; then
            echo "âœ… Gate passed: session=$SESSION"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "session=$SESSION" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ Skipped: PARIS=$PARIS not in any window"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Update Crypto Data
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-crypto-data:
    needs: gate
    if: needs.gate.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      data_updated: ${{ steps.update.outputs.updated }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: pip install -r requirements.txt || pip install requests pandas

      - name: ðŸª™ Update crypto data
        id: update
        env:
          TWELVE_DATA_API_KEY: ${{ secrets.TWELVE_DATA_API }}
          FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
          SESSION: ${{ needs.gate.outputs.session }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸª™ Crypto update - Session: $SESSION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Pour les runs frÃ©quents, on skip le check des 24h
          # sauf pour minuit qui fait un refresh complet
          if [ -f "data/Crypto.csv" ] && [ "$SESSION" != "midnight" ]; then
            LAST_MODIFIED=$(date -r data/Crypto.csv +%s)
            NOW=$(date +%s)
            AGE=$((NOW - LAST_MODIFIED))
            HOURS=$((AGE / 3600))
            echo "ðŸ“… Last update: $HOURS hours ago"
            
            # Skip si moins de 4h (sauf force ou minuit)
            if [ "$FORCE_UPDATE" = "false" ] && [ $HOURS -lt 4 ]; then
              echo "â­ï¸ Recent data, skipping update"
              echo "updated=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          if [ -f "scripts/update-crypto-data.py" ]; then
            python scripts/update-crypto-data.py
          else
            echo "âš ï¸ Script not found"
          fi
          
          echo "updated=true" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Commit updated data
        if: steps.update.outputs.updated == 'true'
        run: |
          set -e
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          
          git add data/Crypto.csv 2>/dev/null || true
          git add data/crypto_lists.json 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes"
            exit 0
          fi
          
          SESSION="${{ needs.gate.outputs.session }}"
          TS=$(date -u +'%Y-%m-%d %H:%M UTC')
          
          case "$SESSION" in
            midnight)  EMOJI="ðŸŒ™" ;;
            morning)   EMOJI="â˜€ï¸" ;;
            afternoon) EMOJI="ðŸŒ…" ;;
            evening)   EMOJI="ðŸŒ†" ;;
            *)         EMOJI="ðŸª™" ;;
          esac
          
          git commit -m "$EMOJI Crypto [$SESSION] - $TS [skip ci]"
          
          BRANCH="${GITHUB_REF_NAME:-main}"
          for i in 1 2 3; do
            git fetch origin && git rebase "origin/$BRANCH" || git rebase --abort || true
            git push origin "HEAD:$BRANCH" && echo "âœ… Push OK" && exit 0
            sleep $((RANDOM%5+2))
          done
          exit 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Analyze and Filter Cryptos
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  analyze-and-filter-cryptos:
    needs: [gate, update-crypto-data]
    if: needs.gate.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: ðŸ“Š Run crypto volatility analysis
        env:
          TWELVE_DATA_API_KEY: ${{ secrets.TWELVE_DATA_API }}
          DATA_DIR: data
          OUTPUT_DIR: data/filtered
          VOL_INTERVAL: ${{ github.event.inputs.vol_interval || '1day' }}
          MIN_VOL_30D: ${{ github.event.inputs.min_vol_30d || '30' }}
          MAX_VOL_30D: ${{ github.event.inputs.max_vol_30d || '500' }}
          MIN_RET_7D: ${{ github.event.inputs.min_ret_7d || '-50' }}
          LOOKBACK_DAYS: 120
          MAX_STALE_HOURS: 48
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“Š Analyse volatilitÃ© (interval: $VOL_INTERVAL)"
          echo "   Vol30d: $MIN_VOL_30D-$MAX_VOL_30D%, Ret7d > $MIN_RET_7D%"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          node scripts/crypto-volatility-return.js

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: crypto-analysis-${{ github.run_number }}
          path: |
            data/filtered/Crypto_filtered_volatility.csv
            data/filtered/Crypto_rejected_volatility.csv
            data/filtered/Top10_momentum.csv
            data/filtered/Top10_volatility.csv
          retention-days: 7

      - name: ðŸ’¾ Commit results
        run: |
          set -e
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          
          git add data/filtered/*.csv 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes"
            exit 0
          fi
          
          SESSION="${{ needs.gate.outputs.session }}"
          TS=$(date -u +'%Y-%m-%d %H:%M UTC')
          
          case "$SESSION" in
            midnight)  EMOJI="ðŸŒ™" ;;
            morning)   EMOJI="â˜€ï¸" ;;
            afternoon) EMOJI="ðŸŒ…" ;;
            evening)   EMOJI="ðŸŒ†" ;;
            *)         EMOJI="ðŸª™" ;;
          esac
          
          git commit -m "$EMOJI Crypto analysis [$SESSION] - $TS [skip ci]"
          
          BRANCH="${GITHUB_REF_NAME:-main}"
          for i in 1 2 3; do
            git fetch origin && git rebase "origin/$BRANCH" || git rebase --abort || true
            git push origin "HEAD:$BRANCH" && echo "âœ… Push OK" && exit 0
            sleep $((RANDOM%5+2))
          done
          exit 1

      - name: ðŸ“‹ Generate summary
        if: always()
        run: |
          echo "# ðŸª™ Crypto Analysis" >> $GITHUB_STEP_SUMMARY
          echo "**Session:** ${{ needs.gate.outputs.session }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/filtered/Crypto_filtered_volatility.csv" ]; then
            TOTAL=$(tail -n +2 data/Crypto.csv 2>/dev/null | wc -l || echo "0")
            ACCEPTED=$(tail -n +2 data/filtered/Crypto_filtered_volatility.csv 2>/dev/null | wc -l || echo "0")
            
            echo "## ðŸ“ˆ Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Total:** $TOTAL cryptos" >> $GITHUB_STEP_SUMMARY
            echo "- **âœ… Accepted:** $ACCEPTED cryptos" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "data/filtered/Top10_momentum.csv" ]; then
              echo "### ðŸš€ Top 5 Momentum" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -n +2 data/filtered/Top10_momentum.csv | head -5 | \
                awk -F',' '{printf "%-12s %7s%%\n", $1, $9}' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi
