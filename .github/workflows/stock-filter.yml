name: ğŸ“ˆ Stock Markets Schedule

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GÃˆRE: Asia/Europe/US - OPEN + CLOSE + Consolidation globale
# SCRIPT: stock-advanced-filter.js
# GATE: VÃ©rifie l'heure locale du marchÃ© pour Ã©viter les runs inutiles (DST-proof)
# FENÃŠTRES: Â±20min pour absorber les dÃ©lais GitHub Actions
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  workflow_dispatch:
    inputs:
      market:
        description: 'MarchÃ© Ã  traiter'
        required: true
        type: choice
        options: [asia, europe, us, all]
      session:
        description: 'Session'
        required: true
        type: choice
        options: [open, close, both]
      force:
        description: 'Forcer (ignorer gate horaire)'
        type: boolean
        default: false

  schedule:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸŒ ASIE (pas de DST - crons simples)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Tokyo OPEN 09:00 JST = 00:00 UTC
    - cron: '0 0 * * 1-5'
    # Shanghai OPEN 09:30 CST = 01:30 UTC
    - cron: '30 1 * * 1-5'
    # Tokyo CLOSE 15:00 JST = 06:00 UTC
    - cron: '0 6 * * 1-5'
    # Shanghai CLOSE 15:00 CST = 07:00 UTC
    - cron: '0 7 * * 1-5'
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ‡ªğŸ‡º EUROPE (DST: double cron pour couvrir Ã©tÃ©/hiver)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Paris OPEN 09:00 = 07:00 UTC (Ã©tÃ©) ou 08:00 UTC (hiver)
    - cron: '0 7 * * 1-5'
    - cron: '0 8 * * 1-5'
    # Paris CLOSE 17:35 = 15:35 UTC (Ã©tÃ©) ou 16:35 UTC (hiver)
    - cron: '35 15 * * 1-5'
    - cron: '35 16 * * 1-5'
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ‡ºğŸ‡¸ USA (DST: double cron pour couvrir Ã©tÃ©/hiver)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # NYSE OPEN 09:30 ET = 13:30 UTC (Ã©tÃ©) ou 14:30 UTC (hiver) â†’ 15:30 Paris
    - cron: '30 13 * * 1-5'
    - cron: '30 14 * * 1-5'
    # NYSE CLOSE 16:00 ET = 20:00 UTC (Ã©tÃ©) ou 21:00 UTC (hiver) â†’ 22:00 Paris
    - cron: '0 20 * * 1-5'
    - cron: '0 21 * * 1-5'
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸŒ CONSOLIDATION GLOBALE (23:00 Paris)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - cron: '0 21 * * 1-5'
    - cron: '0 22 * * 1-5'

concurrency:
  group: repo-writes-global
  cancel-in-progress: false

permissions:
  contents: write

env:
  TWELVE_DATA_API_KEY: ${{ secrets.TWELVE_DATA_API }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: GATE - DÃ©terminer quel marchÃ©/session traiter
  # FenÃªtres Ã©largies Â±20min pour absorber les dÃ©lais GitHub
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  gate:
    runs-on: ubuntu-latest
    outputs:
      market: ${{ steps.detect.outputs.market }}
      session: ${{ steps.detect.outputs.session }}
      should_run: ${{ steps.detect.outputs.should_run }}
      
    steps:
      - name: ğŸ• Detect market session based on local time
        id: detect
        run: |
          # Si workflow_dispatch, on passe direct
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "market=${{ inputs.market }}" >> $GITHUB_OUTPUT
            echo "session=${{ inputs.session }}" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "âœ… Manual trigger: market=${{ inputs.market }}, session=${{ inputs.session }}"
            exit 0
          fi
          
          # RÃ©cupÃ©rer les heures locales (format HHMM)
          TOKYO=$(TZ=Asia/Tokyo date +%H%M)
          SHANGHAI=$(TZ=Asia/Shanghai date +%H%M)
          PARIS=$(TZ=Europe/Paris date +%H%M)
          NY=$(TZ=America/New_York date +%H%M)
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ Current local times:"
          echo "   ğŸ—¼ Tokyo    = $TOKYO"
          echo "   ğŸ¯ Shanghai = $SHANGHAI"
          echo "   ğŸ—¼ Paris    = $PARIS"
          echo "   ğŸ—½ New York = $NY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          MARKET=""
          SESSION=""
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ğŸŒ ASIA GATES (fenÃªtres Ã©largies Â±20min)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if [ "$TOKYO" -ge "0840" ] && [ "$TOKYO" -le "0920" ]; then
            MARKET="asia"; SESSION="open"
            echo "ğŸŒ Tokyo OPEN detected"
          elif [ "$SHANGHAI" -ge "0910" ] && [ "$SHANGHAI" -le "0950" ]; then
            MARKET="asia"; SESSION="open"
            echo "ğŸŒ Shanghai OPEN detected"
          elif [ "$TOKYO" -ge "1440" ] && [ "$TOKYO" -le "1520" ]; then
            MARKET="asia"; SESSION="close"
            echo "ğŸŒ Tokyo CLOSE detected"
          elif [ "$SHANGHAI" -ge "1440" ] && [ "$SHANGHAI" -le "1520" ]; then
            MARKET="asia"; SESSION="close"
            echo "ğŸŒ Shanghai CLOSE detected"
            
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ğŸ‡ªğŸ‡º EUROPE GATES (fenÃªtres Ã©largies Â±20min)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          elif [ "$PARIS" -ge "0840" ] && [ "$PARIS" -le "0920" ]; then
            MARKET="europe"; SESSION="open"
            echo "ğŸ‡ªğŸ‡º Europe OPEN detected (Paris 09:00)"
          elif [ "$PARIS" -ge "1715" ] && [ "$PARIS" -le "1755" ]; then
            MARKET="europe"; SESSION="close"
            echo "ğŸ‡ªğŸ‡º Europe CLOSE detected (Paris 17:35)"
            
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ğŸ‡ºğŸ‡¸ US GATES (fenÃªtres Ã©largies Â±20min)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          elif [ "$NY" -ge "0910" ] && [ "$NY" -le "0950" ]; then
            MARKET="us"; SESSION="open"
            echo "ğŸ‡ºğŸ‡¸ US OPEN detected (NYSE 09:30)"
          elif [ "$NY" -ge "1540" ] && [ "$NY" -le "1620" ]; then
            MARKET="us"; SESSION="close"
            echo "ğŸ‡ºğŸ‡¸ US CLOSE detected (NYSE 16:00)"
            
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # ğŸŒ GLOBAL CONSOLIDATION (23:00 Paris, fenÃªtre Ã©largie Â±20min)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          elif [ "$PARIS" -ge "2240" ] && [ "$PARIS" -le "2320" ]; then
            MARKET="all"; SESSION="consolidation"
            echo "ğŸŒ GLOBAL CONSOLIDATION detected"
          fi
          
          # Output
          if [ -n "$MARKET" ]; then
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… Gate PASSED: market=$MARKET, session=$SESSION"
            echo "market=$MARKET" >> $GITHUB_OUTPUT
            echo "session=$SESSION" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "â­ï¸ Gate SKIPPED: No matching market/session for current time"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: ExÃ©cuter le filtrage stocks
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  filter-stocks:
    needs: gate
    if: needs.gate.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install csv-parse axios

      - name: ğŸ“Š Run Stock Advanced Filter
        env:
          MARKET: ${{ needs.gate.outputs.market }}
          SESSION: ${{ needs.gate.outputs.session }}
        run: |
          echo "ğŸ¯ Processing: MARKET=$MARKET, SESSION=$SESSION"
          
          # Mapper vers REGIONS pour stock-advanced-filter.js
          case "$MARKET" in
            asia)   export REGIONS="asia" ;;
            europe) export REGIONS="europe" ;;
            us)     export REGIONS="us" ;;
            all)    export REGIONS="all" ;;
          esac
          
          echo "ğŸŒ REGIONS=$REGIONS"
          node stock-advanced-filter.js

      - name: ğŸ“‹ Verify generated files
        run: |
          echo "ğŸ“‚ Files in data/:"
          ls -lh data/*.json 2>/dev/null | head -20 || echo "No JSON"
          git status --porcelain | head -20

      - name: ğŸ’¾ Commit and push
        run: |
          set -e
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          
          git add data/*.json 2>/dev/null || true
          
          if git diff --quiet && git diff --staged --quiet; then
            echo "â„¹ï¸ Nothing to commit"
            exit 0
          fi
          
          MARKET="${{ needs.gate.outputs.market }}"
          SESSION="${{ needs.gate.outputs.session }}"
          TS=$(date -u +'%Y-%m-%d %H:%M UTC')
          
          case "$MARKET" in
            asia)   E="ğŸŒ" ;; europe) E="ğŸ‡ªğŸ‡º" ;; us) E="ğŸ‡ºğŸ‡¸" ;; *) E="ğŸŒ" ;;
          esac
          
          git commit -m "$E Stocks [$MARKET/$SESSION] - $TS [skip ci]"
          
          BRANCH="${GITHUB_REF_NAME:-main}"
          for i in 1 2 3; do
            git fetch origin && git rebase "origin/$BRANCH" || git rebase --abort || true
            git push origin "HEAD:$BRANCH" && echo "âœ… Push OK" && exit 0
            sleep $((RANDOM%5+2))
          done
          exit 1
