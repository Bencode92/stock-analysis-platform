name: ğŸ“Š Update Markets Data

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GÃˆRE: DonnÃ©es indices de marchÃ©
# SCRIPT: scripts/update_market_data_etf.py
# HORAIRES: 
#   - 09:20 Paris (avant Europe open, ~3 min)
#   - 18:05 Paris (aprÃ¨s Europe close)
#   - 22:30 Paris (aprÃ¨s US close)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  workflow_dispatch:

  schedule:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸŒ… MATIN (09:20 Paris)
    # Ã©tÃ©: 07:20 UTC | hiver: 08:20 UTC
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - cron: '20 7 * * 1-5'
    - cron: '20 8 * * 1-5'
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ‡ªğŸ‡º POST-EUROPE (18:05 Paris)
    # Ã©tÃ©: 16:05 UTC | hiver: 17:05 UTC
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - cron: '5 16 * * 1-5'
    - cron: '5 17 * * 1-5'
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ‡ºğŸ‡¸ POST-US (22:30 Paris)
    # Ã©tÃ©: 20:30 UTC | hiver: 21:30 UTC
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - cron: '30 20 * * 1-5'
    - cron: '30 21 * * 1-5'

concurrency:
  group: repo-writes-global
  cancel-in-progress: false

permissions:
  contents: write

env:
  TWELVE_DATA_API: ${{ secrets.TWELVE_DATA_API }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Gate
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  gate:
    runs-on: ubuntu-latest
    outputs:
      session: ${{ steps.detect.outputs.session }}
      should_run: ${{ steps.detect.outputs.should_run }}
      
    steps:
      - name: ğŸ• Detect session
        id: detect
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "session=manual" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "âœ… Manual trigger"
            exit 0
          fi
          
          PARIS=$(TZ=Europe/Paris date +%H%M)
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ Paris time: $PARIS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          SESSION=""
          
          # Matin: 09:15 - 09:25 Paris
          if [ "$PARIS" -ge "0915" ] && [ "$PARIS" -le "0925" ]; then
            SESSION="morning"
            echo "ğŸŒ… MORNING session"
            
          # Post-Europe: 18:00 - 18:10 Paris
          elif [ "$PARIS" -ge "1800" ] && [ "$PARIS" -le "1810" ]; then
            SESSION="post-europe"
            echo "ğŸ‡ªğŸ‡º POST-EUROPE session"
            
          # Post-US: 22:25 - 22:35 Paris
          elif [ "$PARIS" -ge "2225" ] && [ "$PARIS" -le "2235" ]; then
            SESSION="post-us"
            echo "ğŸ‡ºğŸ‡¸ POST-US session"
          fi
          
          if [ -n "$SESSION" ]; then
            echo "âœ… Gate passed: session=$SESSION"
            echo "session=$SESSION" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ Gate skipped: PARIS=$PARIS"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Update Markets
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-markets:
    needs: gate
    if: needs.gate.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Create data directory
        run: mkdir -p data

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install twelvedata

      - name: ğŸ“Š Update market data
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Session: ${{ needs.gate.outputs.session }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          python scripts/update_market_data_etf.py
        continue-on-error: true

      - name: Verify data file
        run: |
          if [ ! -f data/markets.json ]; then
            echo '{}' > data/markets.json
          fi
          echo "ğŸ“‹ markets.json size: $(wc -c < data/markets.json) bytes"

      - name: ğŸ’¾ Commit and push
        run: |
          set -e
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          
          git add data/markets.json
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes"
            exit 0
          fi
          
          SESSION="${{ needs.gate.outputs.session }}"
          TS=$(date -u +'%Y-%m-%d %H:%M UTC')
          
          case "$SESSION" in
            morning)     EMOJI="ğŸŒ…" ;;
            post-europe) EMOJI="ğŸ‡ªğŸ‡º" ;;
            post-us)     EMOJI="ğŸ‡ºğŸ‡¸" ;;
            *)           EMOJI="ğŸ“Š" ;;
          esac
          
          git commit -m "$EMOJI Markets [$SESSION] - $TS [skip ci]"
          
          BRANCH="${GITHUB_REF_NAME:-main}"
          for i in 1 2 3; do
            git fetch origin && git rebase "origin/$BRANCH" || git rebase --abort || true
            git push origin "HEAD:$BRANCH" && echo "âœ… Push OK" && exit 0
            sleep $((RANDOM%5+2))
          done
          exit 1
