name: Update Themes Data

on:
  schedule:
    - cron: '0 */4 * * *'  # Toutes les 4 heures
  workflow_dispatch:  # Permet l'exÃ©cution manuelle

jobs:
  update-themes:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Timeout de sÃ©curitÃ©
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'  # Cache des dÃ©pendances pip
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Installation des dÃ©pendances de base (obligatoires pour CI)
          pip install aiohttp numpy requests pandas scikit-learn nltk
          pip install sentence-transformers langdetect joblib faiss-cpu
          # ğŸ†• DÃ©pendances pour la traduction automatique
          pip install deepl langdetect
          # DÃ©pendances optionnelles (ignore les erreurs)
          pip install tenacity structlog orjson || echo "âš ï¸ DÃ©pendances optionnelles ignorÃ©es"
          
      - name: Create required directories
        run: |
          mkdir -p data models
          
      - name: Update themes data
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          DEEPL_API_KEY: ${{ secrets.DEEPL_API_KEY }}  # ğŸ†• ClÃ© API DeepL
          PYTHONPATH: ${{ github.workspace }}  # ğŸ†• Ajoute la racine du repo
          TP_MAX_TOTAL: 150
          TP_MAX_WORKERS: 2  # Limiter pour CI
          TP_LOG_LEVEL: INFO
        timeout-minutes: 20
        run: python scripts/fmp_news_updater.py
        
      - name: Verify output files
        run: |
          if [ -f "data/themes.json" ] && [ -f "data/news.json" ]; then
            echo "âœ… Fichiers gÃ©nÃ©rÃ©s avec succÃ¨s"
            echo "ğŸ“Š Taille themes.json: $(du -h data/themes.json | cut -f1)"
            echo "ğŸ“° Taille news.json: $(du -h data/news.json | cut -f1)"
            # VÃ©rifier que les fichiers ne sont pas vides
            themes_size=$(stat -c%s "data/themes.json")
            news_size=$(stat -c%s "data/news.json")
            if [ $themes_size -lt 100 ] || [ $news_size -lt 100 ]; then
              echo "âŒ Erreur: fichiers trop petits (potentiellement corrompus)"
              exit 1
            fi
            # ğŸ†• VÃ©rification que la traduction fonctionne
            echo "ğŸŒ VÃ©rification de la traduction..."
            if jq -r '.france[0].title // .us[0].title // empty' data/news.json | grep -q .; then
              echo "âœ… DonnÃ©es d'actualitÃ©s trouvÃ©es"
            else
              echo "âš ï¸ Aucune actualitÃ© trouvÃ©e dans le JSON"
            fi
          else
            echo "âŒ Erreur: fichiers manquants"
            exit 1
          fi
          
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action [Bot]"
          git add data/themes.json data/news.json
          if git diff --staged --quiet; then
            echo "ğŸ“ Aucun changement dÃ©tectÃ© dans les donnÃ©es"
          else
            # Ajouter des statistiques dans le message de commit
            themes_count=$(jq -r '.themes.weekly | length' data/themes.json 2>/dev/null || echo "?")
            git commit -m "ğŸ”„ Update themes and news data with translations [skip ci]

            ğŸ“Š Themes analyzed: $themes_count
            ğŸŒ Auto-translation: enabled
            ğŸ• Updated: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            git push
            echo "âœ… DonnÃ©es mises Ã  jour et publiÃ©es avec traduction"
          fi
