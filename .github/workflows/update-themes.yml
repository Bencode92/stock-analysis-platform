name: Update Themes Data

on:
  schedule:
    - cron: '0 */4 * * *'  # Toutes les 4 heures
  workflow_dispatch:  # Permet l'ex√©cution manuelle

jobs:
  update-themes:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Timeout de s√©curit√©
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'  # Cache des d√©pendances pip
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # D√©pendances de base (obligatoires)
          pip install aiohttp numpy requests pandas scikit-learn nltk
          
          # D√©pendances ML/NLP (pour fonctionnalit√©s avanc√©es)
          pip install sentence-transformers langdetect joblib
          
          # FAISS pour recherche s√©mantique (version CPU pour CI)
          pip install faiss-cpu
          
          # D√©pendances optionnelles (am√©lioration performance/observabilit√©)
          pip install tenacity structlog orjson || echo "D√©pendances optionnelles ignor√©es"
          
      - name: Create required directories
        run: |
          mkdir -p data models
          
      - name: Update themes data
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          TP_MAX_TOTAL: 150
          TP_MAX_WORKERS: 2  # Limiter pour CI
          TP_LOG_LEVEL: INFO
        timeout-minutes: 20
        run: python scripts/fmp_news_updater.py
        
      - name: Verify output files
        run: |
          if [ -f "data/themes.json" ] && [ -f "data/news.json" ]; then
            echo "‚úÖ Fichiers g√©n√©r√©s avec succ√®s"
            echo "üìä Taille themes.json: $(du -h data/themes.json | cut -f1)"
            echo "üì∞ Taille news.json: $(du -h data/news.json | cut -f1)"
          else
            echo "‚ùå Erreur: fichiers manquants"
            exit 1
          fi
          
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/themes.json data/news.json
          if git diff --staged --quiet; then
            echo "üìù Aucun changement d√©tect√©"
          else
            git commit -m "üîÑ Update themes and news data [skip ci]"
            git push
            echo "‚úÖ Donn√©es mises √† jour et publi√©es"
          fi