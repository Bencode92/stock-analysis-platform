name: ğŸ“Š Update Sectors Data

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GÃˆRE: DonnÃ©es sectorielles
# SCRIPT: scripts/update_sectors_data_etf.py
# HORAIRES: 
#   - 09:25 Paris (aprÃ¨s markets, avant ETF refresh)
#   - 18:10 Paris (aprÃ¨s Europe close)
#   - 22:35 Paris (aprÃ¨s US close)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  workflow_dispatch:

  schedule:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸŒ… MATIN (09:25 Paris) - aprÃ¨s markets (09:20)
    # Ã©tÃ©: 07:25 UTC | hiver: 08:25 UTC
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - cron: '25 7 * * 1-5'
    - cron: '25 8 * * 1-5'
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ‡ªğŸ‡º POST-EUROPE (18:10 Paris) - aprÃ¨s markets (18:05)
    # Ã©tÃ©: 16:10 UTC | hiver: 17:10 UTC
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - cron: '10 16 * * 1-5'
    - cron: '10 17 * * 1-5'
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ‡ºğŸ‡¸ POST-US (22:35 Paris) - aprÃ¨s markets (22:30)
    # Ã©tÃ©: 20:35 UTC | hiver: 21:35 UTC
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - cron: '35 20 * * 1-5'
    - cron: '35 21 * * 1-5'

concurrency:
  group: repo-writes-global
  cancel-in-progress: false

permissions:
  contents: write

env:
  TWELVE_DATA_API: ${{ secrets.TWELVE_DATA_API }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Gate
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  gate:
    runs-on: ubuntu-latest
    outputs:
      session: ${{ steps.detect.outputs.session }}
      should_run: ${{ steps.detect.outputs.should_run }}
      
    steps:
      - name: ğŸ• Detect session
        id: detect
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "session=manual" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "âœ… Manual trigger"
            exit 0
          fi
          
          PARIS=$(TZ=Europe/Paris date +%H%M)
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ Paris time: $PARIS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          SESSION=""
          
          # Matin: 09:20 - 09:30 Paris
          if [ "$PARIS" -ge "0920" ] && [ "$PARIS" -le "0930" ]; then
            SESSION="morning"
            echo "ğŸŒ… MORNING session"
            
          # Post-Europe: 18:05 - 18:15 Paris
          elif [ "$PARIS" -ge "1805" ] && [ "$PARIS" -le "1815" ]; then
            SESSION="post-europe"
            echo "ğŸ‡ªğŸ‡º POST-EUROPE session"
            
          # Post-US: 22:30 - 22:40 Paris
          elif [ "$PARIS" -ge "2230" ] && [ "$PARIS" -le "2240" ]; then
            SESSION="post-us"
            echo "ğŸ‡ºğŸ‡¸ POST-US session"
          fi
          
          if [ -n "$SESSION" ]; then
            echo "âœ… Gate passed: session=$SESSION"
            echo "session=$SESSION" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ Gate skipped: PARIS=$PARIS"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Update Sectors
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-sectors:
    needs: gate
    if: needs.gate.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Create data directory
        run: mkdir -p data

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install twelvedata

      - name: ğŸ“Š Update sectors data
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Session: ${{ needs.gate.outputs.session }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          python scripts/update_sectors_data_etf.py
        continue-on-error: true

      - name: Verify data file
        run: |
          if [ ! -f data/sectors.json ]; then
            echo '{"sectors": {}, "meta": {"timestamp": null}}' > data/sectors.json
          fi
          echo "ğŸ“‹ sectors.json size: $(wc -c < data/sectors.json) bytes"

      - name: ğŸ’¾ Commit and push
        run: |
          set -e
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          
          git add data/sectors.json
          git add data/sectors_etf_mapping.csv 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes"
            exit 0
          fi
          
          SESSION="${{ needs.gate.outputs.session }}"
          TS=$(date -u +'%Y-%m-%d %H:%M UTC')
          
          case "$SESSION" in
            morning)     EMOJI="ğŸŒ…" ;;
            post-europe) EMOJI="ğŸ‡ªğŸ‡º" ;;
            post-us)     EMOJI="ğŸ‡ºğŸ‡¸" ;;
            *)           EMOJI="ğŸ“Š" ;;
          esac
          
          git commit -m "$EMOJI Sectors [$SESSION] - $TS [skip ci]"
          
          BRANCH="${GITHUB_REF_NAME:-main}"
          for i in 1 2 3; do
            git fetch origin && git rebase "origin/$BRANCH" || git rebase --abort || true
            git push origin "HEAD:$BRANCH" && echo "âœ… Push OK" && exit 0
            sleep $((RANDOM%5+2))
          done
          exit 1
