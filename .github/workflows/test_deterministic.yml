# .github/workflows/test_deterministic.yml
#
# P1-5: Test de d√©terminisme CI
#
# V√©rifie que le pipeline est d√©terministe:
# - 2 runs ‚Üí m√™me hash canonique
# - Variables d'environnement pour stabilit√© BLAS/threads
#
name: Deterministic Tests

on:
  push:
    branches: [main]
    paths:
      - 'generate_portfolios_v4.py'
      - 'portfolio_engine/**'
      - 'utils/canonicalize.py'
      - 'tests/test_deterministic.py'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-determinism:
    runs-on: ubuntu-latest
    
    env:
      # === Mode d√©terministe ===
      DETERMINISTIC: "1"
      PYTHONHASHSEED: "0"
      
      # === Threads BLAS/NumPy (√©vite variance SciPy/SLSQP) ===
      OMP_NUM_THREADS: "1"
      MKL_NUM_THREADS: "1"
      OPENBLAS_NUM_THREADS: "1"
      NUMEXPR_NUM_THREADS: "1"
      
      # === Timezone fixe ===
      TZ: "UTC"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest numpy pandas scipy pyyaml
          # Install project in editable mode if setup.py exists
          if [ -f setup.py ]; then pip install -e .; fi
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run deterministic tests
        run: |
          echo "üîß Environment:"
          echo "   DETERMINISTIC=$DETERMINISTIC"
          echo "   PYTHONHASHSEED=$PYTHONHASHSEED"
          echo "   OMP_NUM_THREADS=$OMP_NUM_THREADS"
          echo "   TZ=$TZ"
          echo ""
          pytest tests/test_deterministic.py -v --tb=short
      
      - name: Test canonicalize CLI
        run: |
          # V√©rifier que le module s'ex√©cute sans erreur
          python -c "from utils.canonicalize import compute_hashes; print('‚úÖ Import OK')"

  # Job optionnel: v√©rifier hash sur portfolio r√©el (si fixtures existent)
  test-golden-hash:
    runs-on: ubuntu-latest
    needs: test-determinism
    if: github.event_name == 'push'
    
    env:
      DETERMINISTIC: "1"
      PYTHONHASHSEED: "0"
      OMP_NUM_THREADS: "1"
      MKL_NUM_THREADS: "1"
      OPENBLAS_NUM_THREADS: "1"
      NUMEXPR_NUM_THREADS: "1"
      TZ: "UTC"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest numpy pandas scipy pyyaml
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Check for golden fixtures
        id: check-fixtures
        run: |
          if [ -f "tests/fixtures/golden/portfolios_canonical.json" ]; then
            echo "has_golden=true" >> $GITHUB_OUTPUT
          else
            echo "has_golden=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No golden fixture found, skipping golden hash test"
          fi
      
      - name: Test golden hash
        if: steps.check-fixtures.outputs.has_golden == 'true'
        run: |
          python -c "
          import json
          from utils.canonicalize import compute_hashes
          
          with open('tests/fixtures/golden/portfolios_canonical.json', 'r') as f:
              golden = json.load(f)
          
          expected = golden.get('_meta', {}).get('expected_core_hash')
          if expected:
              actual = compute_hashes(golden)['core_hash']
              if actual == expected:
                  print(f'‚úÖ Golden hash match: {actual[:16]}...')
              else:
                  print(f'‚ùå Hash mismatch!')
                  print(f'   Expected: {expected[:16]}...')
                  print(f'   Actual:   {actual[:16]}...')
                  exit(1)
          else:
              print('‚ö†Ô∏è No expected_core_hash in golden fixture')
          "
