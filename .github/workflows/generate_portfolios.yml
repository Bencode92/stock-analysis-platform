name: G√©n√©ration des Portefeuilles v4.9.1 + Backtest + Debug + Validation

on:
  push:
    branches: [ main ]
    paths:
      - actualites.html
      - marche.html
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-portfolios:
    runs-on: ubuntu-latest
    env:
      API_CHAT: ${{ secrets.API_CHAT }}
      OPENAI_API_KEY: ${{ secrets.API_CHAT }}
      TWELVE_DATA_API: ${{ secrets.TWELVE_DATA_API }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: üì¶ Installer les d√©pendances
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scipy requests beautifulsoup4 lxml openai pyyaml jsonschema

      # ============= v4.9 RADAR: Deterministic Market Context =============
      # Le contexte est g√©n√©r√© par market_sector_radar.py dans generate_portfolios_v4.py
      # GPT n'est plus utilis√© pour les tilts (d√©terministe + auditable)
      # OpenAI est conserv√© UNIQUEMENT pour les commentaires (UX)
      - name: üßπ Clean stale market_context (RADAR v4.9)
        run: |
          echo "üßπ Nettoyage des anciens fichiers market_context..."
          rm -f data/market_context.json
          echo "‚è≠Ô∏è Skip GPT market_context ‚Äî RADAR d√©terministe activ√©"
          echo "üìä Le contexte sera g√©n√©r√© par market_sector_radar.py (data-driven)"
          echo ""
          echo "‚ÑπÔ∏è  OpenAI est utilis√© UNIQUEMENT pour les commentaires (pas le scoring)"

      - name: üöÄ Ex√©cuter le moteur v4.9.1 + Backtest + Debug
        run: python generate_portfolios_v4.py

      # ============= v4.5 NEW: Schema Validation =============
      - name: ‚úÖ Valider le sch√©ma JSON
        run: |
          echo "üîç Validation du sch√©ma portfolios.json..."
          
          if [ ! -f data/portfolios.json ]; then
            echo "‚ùå ERREUR: portfolios.json non g√©n√©r√©!"
            exit 1
          fi
          
          # Validation avec le script d√©di√©
          python scripts/validate_schema.py data/portfolios.json --verbose
          
          VALIDATION_EXIT=$?
          if [ $VALIDATION_EXIT -ne 0 ]; then
            echo "‚ùå ERREUR: Validation du sch√©ma √©chou√©e!"
            echo "   Le fichier portfolios.json ne respecte pas le contrat de sortie."
            exit 1
          fi
          
          echo "‚úÖ Validation du sch√©ma r√©ussie"

      - name: üßæ Check outputs
        if: always()
        run: |
          echo "== data =="
          ls -lah data || true
          echo "----"
          
          # Market Context
          if [ -f data/market_context.json ]; then
            echo "‚úÖ market_context.json"
            # V√©rifier que c'est bien du RADAR
            python3 << 'EOF'
          import json
          with open("data/market_context.json") as f:
              ctx = json.load(f)
          model = ctx.get('_meta', {}).get('model', 'unknown')
          mode = ctx.get('_meta', {}).get('mode', 'unknown')
          print(f"   Model: {model}")
          print(f"   Mode: {mode}")
          if model.startswith("radar_"):
              print("   ‚úÖ Contexte RADAR (d√©terministe)")
          else:
              print("   ‚ö†Ô∏è Contexte non-RADAR d√©tect√©!")
          EOF
          else
            echo "‚ö†Ô∏è market_context.json ABSENT (tilts neutres)"
          fi
          
          # Portfolios
          if [ -f data/portfolios.json ]; then
            echo "‚úÖ portfolios.json"
            sha1sum data/portfolios.json || true
          else
            echo "‚ùå portfolios.json ABSENT"
          fi
          
          # Backtest results
          if [ -f data/backtest_results.json ]; then
            echo "‚úÖ backtest_results.json"
            echo "Comparaison des 3 profils:"
            python3 << 'EOF'
          import json
          with open("data/backtest_results.json") as f:
              data = json.load(f)
          comp = data.get("comparison", {})
          print(f"{'M√©trique':<20} | {'Agressif':>12} | {'Mod√©r√©':>12} | {'Stable':>12}")
          print("-" * 65)
          for key in ["total_return_pct", "sharpe_ratio", "max_drawdown_pct"]:
              agg = comp.get("Agressif", {}).get(key, "N/A")
              mod = comp.get("Mod√©r√©", {}).get(key, "N/A")
              stb = comp.get("Stable", {}).get(key, "N/A")
              print(f"{key:<20} | {str(agg):>12} | {str(mod):>12} | {str(stb):>12}")
          EOF
          else
            echo "‚ö†Ô∏è backtest_results.json ABSENT (TWELVE_DATA_API non configur√©e?)"
          fi
          
          # v4.9.1: Backtest debug file
          if [ -f data/backtest_debug.json ]; then
            echo "‚úÖ backtest_debug.json (v4.9.1)"
            python3 << 'EOF'
          import json
          with open("data/backtest_debug.json") as f:
              data = json.load(f)
          n_assets = data.get("data_coverage", {}).get("tickers_with_data", 0)
          types = data.get("data_coverage", {}).get("assets_by_type", {})
          print(f"   Actifs document√©s: {n_assets}")
          print(f"   Types: {types}")
          EOF
          else
            echo "‚ö†Ô∏è backtest_debug.json ABSENT"
          fi
          
          echo "----"
          echo "== portfolio_history =="
          ls -lah data/portfolio_history || true

      - name: üìä Backtest Summary
        if: always()
        run: |
          echo "## üìä Portfolio Engine v4.9.1 Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Schema Validation Status
          echo "### ‚úÖ Schema Validation" >> $GITHUB_STEP_SUMMARY
          if [ -f data/portfolios.json ]; then
            if python scripts/validate_schema.py data/portfolios.json 2>/dev/null; then
              echo "| Status | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Status | ‚ùå Fail |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Status | ‚ö†Ô∏è No file |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Market Context Summary (RADAR v4.9)
          if [ -f data/market_context.json ]; then
            echo "### üéØ Market Context (RADAR v4.9)" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("data/market_context.json") as f:
              ctx = json.load(f)
          regime = ctx.get('market_regime', 'N/A')
          conf = ctx.get('confidence', 'N/A')
          tilts = ctx.get('macro_tilts', {})
          fav_sec = ', '.join(tilts.get('favored_sectors', [])) or 'None'
          avoid_sec = ', '.join(tilts.get('avoided_sectors', [])) or 'None'
          fav_reg = ', '.join(tilts.get('favored_regions', [])) or 'None'
          avoid_reg = ', '.join(tilts.get('avoided_regions', [])) or 'None'
          model = ctx.get('_meta', {}).get('model', 'unknown')
          is_radar = '‚úÖ RADAR' if model.startswith('radar_') else '‚ö†Ô∏è non-RADAR'
          is_fb = '‚ö†Ô∏è FALLBACK' if ctx.get('_meta', {}).get('is_fallback') else ''
          print(f"| Metric | Value |")
          print(f"|--------|-------|")
          print(f"| Model | {model} {is_radar} |")
          print(f"| Regime | {regime} {is_fb} |")
          print(f"| Confidence | {conf} |")
          print(f"| Favored Sectors | {fav_sec} |")
          print(f"| Avoided Sectors | {avoid_sec} |")
          print(f"| Favored Regions | {fav_reg} |")
          print(f"| Avoided Regions | {avoid_reg} |")
          EOF
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f data/backtest_results.json ]; then
            echo "### üìà Backtest Comparison (90 days)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Agressif | Mod√©r√© | Stable |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
            
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("data/backtest_results.json") as f:
              data = json.load(f)
          comp = data.get("comparison", {})
          metrics = [
              ("Total Return %", "total_return_pct"),
              ("Sharpe Ratio", "sharpe_ratio"),
              ("Max Drawdown %", "max_drawdown_pct"),
              ("Volatility %", "volatility_pct"),
          ]
          for label, key in metrics:
              agg = comp.get("Agressif", {}).get(key, "N/A")
              mod = comp.get("Mod√©r√©", {}).get(key, "N/A")
              stb = comp.get("Stable", {}).get(key, "N/A")
              print(f"| {label} | {agg} | {mod} | {stb} |")
          EOF
          else
            echo "‚ö†Ô∏è Backtest skipped (TWELVE_DATA_API not configured)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # v4.9.1: Debug file summary
          if [ -f data/backtest_debug.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîç Backtest Debug (v4.9.1)" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("data/backtest_debug.json") as f:
              data = json.load(f)
          cov = data.get("data_coverage", {})
          n_assets = cov.get("tickers_with_data", 0)
          types = cov.get("assets_by_type", {})
          print(f"| Metric | Value |")
          print(f"|--------|-------|")
          print(f"| Assets documented | {n_assets} |")
          for t, count in types.items():
              print(f"| {t} | {count} |")
          EOF
          fi

      - name: üíæ Commit & push
        if: always()
        run: |
          # FIX: Configurer l'identit√© git GLOBALEMENT (pour commit ET rebase)
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Ajouter les artefacts g√©n√©r√©s (incluant market_context.json + backtest_debug.json v4.9.1)
          git add data/portfolios.json \
                  data/portfolios_euus.json \
                  data/backtest_results.json \
                  data/backtest_debug.json \
                  data/market_context.json \
                  data/portfolio_history/* || true

          # Si .gitignore les filtre, forcer l'ajout
          if git check-ignore -q data/portfolios.json; then
            git add -f data/portfolios.json
          fi
          if git check-ignore -q data/backtest_results.json; then
            git add -f data/backtest_results.json
          fi
          if git check-ignore -q data/backtest_debug.json; then
            git add -f data/backtest_debug.json
          fi
          if git check-ignore -q data/market_context.json; then
            git add -f data/market_context.json
          fi
          if git check-ignore -q data/portfolio_history; then
            git add -f data/portfolio_history/*.json || true
          fi

          git commit -m "üìä Portefeuilles v4.9.1 RADAR + Backtest 90j + Debug + Schema ‚úì" || echo "rien √† committer"

          # Push avec retry robuste en cas de divergence
          git push || (git pull --rebase origin main && git push)

      # ============= v4.9: Archive RADAR Context =============
      - name: üóÇÔ∏è Archive market_context.json
        if: success()
        run: |
          if [ -f data/market_context.json ]; then
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            cp data/market_context.json "data/portfolio_history/market_context_${TIMESTAMP}.json"
            echo "‚úÖ Archiv√©: market_context_${TIMESTAMP}.json"
          fi
