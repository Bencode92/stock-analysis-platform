name: G√©n√©ration des Portefeuilles v4.4 + Backtest

on:
  push:
    branches: [ main ]
    paths:
      - actualites.html
      - marche.html
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-portfolios:
    runs-on: ubuntu-latest
    env:
      API_CHAT: ${{ secrets.API_CHAT }}
      OPENAI_API_KEY: ${{ secrets.API_CHAT }}
      TWELVE_DATA_API: ${{ secrets.TWELVE_DATA_API }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: üì¶ Installer les d√©pendances
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scipy requests beautifulsoup4 lxml openai pyyaml

      # ============= v4.4 NEW: Generate Market Context =============
      - name: üåç G√©n√©rer market_context.json (GPT unifi√©)
        run: |
          echo "üîÑ G√©n√©ration du contexte march√© unifi√©..."
          python portfolio_engine/market_context.py --data-dir data --output data/market_context.json || echo "‚ö†Ô∏è Fallback neutre utilis√©"
          
          # Diagnostic
          if [ -f data/market_context.json ]; then
            echo "‚úÖ market_context.json g√©n√©r√©"
            python3 << 'EOF'
          import json
          with open("data/market_context.json") as f:
              ctx = json.load(f)
          print(f"   R√©gime: {ctx.get('market_regime', 'N/A')}")
          print(f"   Confidence: {ctx.get('confidence', 'N/A')}")
          tilts = ctx.get('macro_tilts', {})
          print(f"   Secteurs favoris√©s: {tilts.get('favored_sectors', [])}")
          print(f"   R√©gions favoris√©es: {tilts.get('favored_regions', [])}")
          is_fallback = ctx.get('_meta', {}).get('is_fallback', False)
          if is_fallback:
              print("   ‚ö†Ô∏è Mode FALLBACK (pas de tilts appliqu√©s)")
          EOF
          else
            echo "‚ö†Ô∏è market_context.json non g√©n√©r√©, tilts neutres"
          fi

      - name: üöÄ Ex√©cuter le moteur v4.4 + Backtest
        run: python generate_portfolios_v4.py

      - name: üßæ Check outputs
        if: always()
        run: |
          echo "== data =="
          ls -lah data || true
          echo "----"
          
          # Market Context
          if [ -f data/market_context.json ]; then
            echo "‚úÖ market_context.json"
          else
            echo "‚ö†Ô∏è market_context.json ABSENT (tilts neutres)"
          fi
          
          # Portfolios
          if [ -f data/portfolios.json ]; then
            echo "‚úÖ portfolios.json"
            sha1sum data/portfolios.json || true
          else
            echo "‚ùå portfolios.json ABSENT"
          fi
          
          # Backtest results
          if [ -f data/backtest_results.json ]; then
            echo "‚úÖ backtest_results.json"
            echo "Comparaison des 3 profils:"
            python3 << 'EOF'
          import json
          with open("data/backtest_results.json") as f:
              data = json.load(f)
          comp = data.get("comparison", {})
          print(f"{'M√©trique':<20} | {'Agressif':>12} | {'Mod√©r√©':>12} | {'Stable':>12}")
          print("-" * 65)
          for key in ["total_return_pct", "sharpe_ratio", "max_drawdown_pct"]:
              agg = comp.get("Agressif", {}).get(key, "N/A")
              mod = comp.get("Mod√©r√©", {}).get(key, "N/A")
              stb = comp.get("Stable", {}).get(key, "N/A")
              print(f"{key:<20} | {str(agg):>12} | {str(mod):>12} | {str(stb):>12}")
          EOF
          else
            echo "‚ö†Ô∏è backtest_results.json ABSENT (TWELVE_DATA_API non configur√©e?)"
          fi
          
          echo "----"
          echo "== portfolio_history =="
          ls -lah data/portfolio_history || true

      - name: üìä Backtest Summary
        if: always()
        run: |
          echo "## üìä Portfolio Engine v4.4 Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Market Context Summary
          if [ -f data/market_context.json ]; then
            echo "### üåç Market Context" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("data/market_context.json") as f:
              ctx = json.load(f)
          regime = ctx.get('market_regime', 'N/A')
          conf = ctx.get('confidence', 'N/A')
          tilts = ctx.get('macro_tilts', {})
          fav_sec = ', '.join(tilts.get('favored_sectors', [])) or 'None'
          avoid_sec = ', '.join(tilts.get('avoided_sectors', [])) or 'None'
          fav_reg = ', '.join(tilts.get('favored_regions', [])) or 'None'
          avoid_reg = ', '.join(tilts.get('avoided_regions', [])) or 'None'
          is_fb = '‚ö†Ô∏è FALLBACK' if ctx.get('_meta', {}).get('is_fallback') else '‚úÖ'
          print(f"| Metric | Value |")
          print(f"|--------|-------|")
          print(f"| Regime | {regime} {is_fb} |")
          print(f"| Confidence | {conf} |")
          print(f"| Favored Sectors | {fav_sec} |")
          print(f"| Avoided Sectors | {avoid_sec} |")
          print(f"| Favored Regions | {fav_reg} |")
          print(f"| Avoided Regions | {avoid_reg} |")
          EOF
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f data/backtest_results.json ]; then
            echo "### üìà Backtest Comparison (90 days)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Agressif | Mod√©r√© | Stable |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
            
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("data/backtest_results.json") as f:
              data = json.load(f)
          comp = data.get("comparison", {})
          metrics = [
              ("Total Return %", "total_return_pct"),
              ("Sharpe Ratio", "sharpe_ratio"),
              ("Max Drawdown %", "max_drawdown_pct"),
              ("Volatility %", "volatility_pct"),
          ]
          for label, key in metrics:
              agg = comp.get("Agressif", {}).get(key, "N/A")
              mod = comp.get("Mod√©r√©", {}).get(key, "N/A")
              stb = comp.get("Stable", {}).get(key, "N/A")
              print(f"| {label} | {agg} | {mod} | {stb} |")
          EOF
          else
            echo "‚ö†Ô∏è Backtest skipped (TWELVE_DATA_API not configured)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üíæ Commit & push
        if: always()
        run: |
          # Ajouter les artefacts g√©n√©r√©s (incluant market_context.json)
          git add data/portfolios.json \
                  data/backtest_results.json \
                  data/market_context.json \
                  data/portfolio_history/* || true

          # Si .gitignore les filtre, forcer l'ajout
          if git check-ignore -q data/portfolios.json; then
            git add -f data/portfolios.json
          fi
          if git check-ignore -q data/backtest_results.json; then
            git add -f data/backtest_results.json
          fi
          if git check-ignore -q data/market_context.json; then
            git add -f data/market_context.json
          fi
          if git check-ignore -q data/portfolio_history; then
            git add -f data/portfolio_history/*.json || true
          fi

          git -c user.name="github-actions[bot]" \
              -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
              commit -m "üìä Portefeuilles v4.4 + Market Context + Backtest 90j" || echo "rien √† committer"

          # Push simple; si √ßa √©choue pour divergence, tenter un rebase rapide
          git push || (git pull --rebase && git push)

      # ============= v4.4 NEW: Archive Market Context =============
      - name: üóÇÔ∏è Archive market_context.json
        if: success()
        run: |
          if [ -f data/market_context.json ]; then
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            cp data/market_context.json "data/portfolio_history/market_context_${TIMESTAMP}.json"
            echo "‚úÖ Archiv√©: market_context_${TIMESTAMP}.json"
          fi
