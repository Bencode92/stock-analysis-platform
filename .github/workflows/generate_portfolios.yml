name: G√©n√©ration des Portefeuilles v5.1.0 + Audit Collector + Selection Explained + Backtest + Debug + Validation

on:
  push:
    branches: [ main ]
    paths:
      - actualites.html
      - marche.html
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-portfolios:
    runs-on: ubuntu-latest
    env:
      API_CHAT: ${{ secrets.API_CHAT }}
      OPENAI_API_KEY: ${{ secrets.API_CHAT }}
      TWELVE_DATA_API: ${{ secrets.TWELVE_DATA_API }}
      # v5.1.0: Audit collector (none | summary | full)
      DEBUG_AUDIT: summary

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: üì¶ Installer les d√©pendances
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scipy requests beautifulsoup4 lxml openai pyyaml jsonschema

      # ============= v4.9 RADAR: Deterministic Market Context =============
      - name: üßπ Clean stale market_context (RADAR v4.9)
        run: |
          echo "üßπ Nettoyage des anciens fichiers market_context..."
          rm -f data/market_context.json
          echo "‚è≠Ô∏è Skip GPT market_context ‚Äî RADAR d√©terministe activ√©"
          echo "üìä Le contexte sera g√©n√©r√© par market_sector_radar.py (data-driven)"
          echo ""
          echo "‚ÑπÔ∏è  OpenAI est utilis√© UNIQUEMENT pour les commentaires (pas le scoring)"

      - name: üöÄ Ex√©cuter le moteur v5.1.0 + Audit Collector + Selection Explained + Backtest + Debug
        run: python generate_portfolios_v4.py

      # ============= v4.5 NEW: Schema Validation =============
      - name: ‚úÖ Valider le sch√©ma JSON
        run: |
          echo "üîç Validation du sch√©ma portfolios.json..."
          
          if [ ! -f data/portfolios.json ]; then
            echo "‚ùå ERREUR: portfolios.json non g√©n√©r√©!"
            exit 1
          fi
          
          python scripts/validate_schema.py data/portfolios.json --verbose
          
          VALIDATION_EXIT=$?
          if [ $VALIDATION_EXIT -ne 0 ]; then
            echo "‚ùå ERREUR: Validation du sch√©ma √©chou√©e!"
            exit 1
          fi
          
          echo "‚úÖ Validation du sch√©ma r√©ussie"

      - name: üßæ Check outputs
        if: always()
        run: |
          echo "== data =="
          ls -lah data || true
          echo "----"
          
          # Market Context
          if [ -f data/market_context.json ]; then
            echo "‚úÖ market_context.json"
            python3 << 'EOF'
          import json
          with open("data/market_context.json") as f:
              ctx = json.load(f)
          model = ctx.get('_meta', {}).get('model', 'unknown')
          mode = ctx.get('_meta', {}).get('mode', 'unknown')
          print(f"   Model: {model}")
          print(f"   Mode: {mode}")
          if model.startswith("radar_"):
              print("   ‚úÖ Contexte RADAR (d√©terministe)")
          else:
              print("   ‚ö†Ô∏è Contexte non-RADAR d√©tect√©!")
          EOF
          else
            echo "‚ö†Ô∏è market_context.json ABSENT (tilts neutres)"
          fi
          
          # Portfolios Global
          if [ -f data/portfolios.json ]; then
            echo "‚úÖ portfolios.json (Global)"
            sha1sum data/portfolios.json || true
          else
            echo "‚ùå portfolios.json ABSENT"
          fi
          
          # Portfolios EU/US v2.2
          if [ -f data/portfolios_euus.json ]; then
            echo "‚úÖ portfolios_euus.json (EU/US Focus v2.2)"
            python3 << 'EOF'
          import json
          with open("data/portfolios_euus.json") as f:
              data = json.load(f)
          meta = data.get("_meta", {})
          print(f"   EU/US Mode: {meta.get('euus_mode', False)}")
          print(f"   Blocked regions: {meta.get('blocked_regions', [])}")
          for profile in ["Agressif", "Mod√©r√©", "Stable"]:
              if profile in data:
                  n_actions = len(data[profile].get("Actions", {}))
                  n_etf = len(data[profile].get("ETF", {}))
                  n_bonds = len(data[profile].get("Obligations", {}))
                  print(f"   {profile}: {n_actions} actions, {n_etf} ETF, {n_bonds} bonds")
          EOF
          else
            echo "‚ö†Ô∏è portfolios_euus.json ABSENT"
          fi
          
          # v4.12.0: Selection Audit
          if [ -f data/selection_audit.json ]; then
            echo "‚úÖ selection_audit.json (v4.12.0)"
            python3 << 'EOF'
          import json
          with open("data/selection_audit.json") as f:
              data = json.load(f)
          summary = data.get("summary", {})
          print(f"   Equities initial: {summary.get('equities_initial', 0)}")
          print(f"   Equities selected: {summary.get('equities_selected', 0)}")
          print(f"   Equities rejected notable: {summary.get('equities_rejected_notable', 0)}")
          print(f"   Filters applied: {summary.get('total_filters_applied', 0)}")
          EOF
          else
            echo "‚ö†Ô∏è selection_audit.json ABSENT"
          fi
          
          # v4.12.1: Selection Explained (TOP caps analysis)
          if [ -f data/selection_explained.json ]; then
            echo "‚úÖ selection_explained.json (v4.12.1)"
            python3 << 'EOF'
          import json
          with open("data/selection_explained.json") as f:
              data = json.load(f)
          summary = data.get("summary", {})
          print(f"   Total universe: {summary.get('total_universe', 0)}")
          print(f"   Total selected: {summary.get('total_selected', 0)}")
          print(f"   Selection rate: {summary.get('selection_rate', 'N/A')}")
          # Show TOP caps by region
          top_caps = data.get("top_caps_by_region", {})
          for region in ["US", "Europe", "Asia"]:
              if region in top_caps:
                  selected = top_caps[region].get("selected_in_top_20", 0)
                  rejection_rate = top_caps[region].get("rejection_rate_top_20", "N/A")
                  print(f"   {region} TOP 20: {selected}/20 selected ({rejection_rate} rejected)")
          EOF
          else
            echo "‚ö†Ô∏è selection_explained.json ABSENT"
          fi
          
          # Backtest results (Global)
          if [ -f data/backtest_results.json ]; then
            echo "‚úÖ backtest_results.json (Global)"
            echo "Comparaison des 3 profils:"
            python3 << 'EOF'
          import json
          with open("data/backtest_results.json") as f:
              data = json.load(f)
          comp = data.get("comparison", {})
          print(f"{'M√©trique':<20} | {'Agressif':>12} | {'Mod√©r√©':>12} | {'Stable':>12}")
          print("-" * 65)
          for key in ["total_return_pct", "sharpe_ratio", "max_drawdown_pct"]:
              agg = comp.get("Agressif", {}).get(key, "N/A")
              mod = comp.get("Mod√©r√©", {}).get(key, "N/A")
              stb = comp.get("Stable", {}).get(key, "N/A")
              print(f"{key:<20} | {str(agg):>12} | {str(mod):>12} | {str(stb):>12}")
          EOF
          else
            echo "‚ö†Ô∏è backtest_results.json ABSENT (TWELVE_DATA_API non configur√©e?)"
          fi
          
          # Backtest results EU/US
          if [ -f data/backtest_results_euus.json ]; then
            echo "‚úÖ backtest_results_euus.json (EU/US)"
            python3 << 'EOF'
          import json
          with open("data/backtest_results_euus.json") as f:
              data = json.load(f)
          comp = data.get("comparison", {})
          print("EU/US Backtest:")
          for profile in ["Agressif", "Mod√©r√©", "Stable"]:
              stats = comp.get(profile, {})
              ret = stats.get("total_return_pct", "N/A")
              vol = stats.get("volatility_pct", "N/A")
              print(f"   {profile}: return={ret}%, vol={vol}%")
          EOF
          else
            echo "‚ö†Ô∏è backtest_results_euus.json ABSENT"
          fi
          
          # v4.9.1: Backtest debug file
          if [ -f data/backtest_debug.json ]; then
            echo "‚úÖ backtest_debug.json (v4.9.1)"
            python3 << 'EOF'
          import json
          with open("data/backtest_debug.json") as f:
              data = json.load(f)
          n_assets = data.get("data_coverage", {}).get("tickers_with_data", 0)
          types = data.get("data_coverage", {}).get("assets_by_type", {})
          print(f"   Actifs document√©s: {n_assets}")
          print(f"   Types: {types}")
          EOF
          else
            echo "‚ö†Ô∏è backtest_debug.json ABSENT"
          fi
          
          # v5.1.0: Selection Debug (audit_collector)
          if [ -f data/selection_debug.json ]; then
            echo "‚úÖ selection_debug.json (v5.1.0)"
            python3 << 'EOF'
          import json
          with open("data/selection_debug.json") as f:
              data = json.load(f)
          meta = data.get("_meta", {})
          print(f"   Run ID: {meta.get('run_id', 'N/A')}")
          print(f"   Git SHA: {meta.get('git_sha', 'N/A')[:8] if meta.get('git_sha') else 'N/A'}")
          print(f"   Mode: {meta.get('mode', 'N/A')}")
          stages = data.get("stages", {})
          for stage_name, stage_data in stages.items():
              before = stage_data.get("before_count", 0)
              after = stage_data.get("after_count", 0)
              print(f"   {stage_name}: {before} ‚Üí {after}")
          EOF
          else
            echo "‚ö†Ô∏è selection_debug.json ABSENT (DEBUG_AUDIT=none?)"
          fi
          
          echo "----"
          echo "== portfolio_history =="
          ls -lah data/portfolio_history || true

      - name: üìä Backtest Summary
        if: always()
        run: |
          echo "## üìä Portfolio Engine v5.1.0 Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Schema Validation Status
          echo "### ‚úÖ Schema Validation" >> $GITHUB_STEP_SUMMARY
          if [ -f data/portfolios.json ]; then
            if python scripts/validate_schema.py data/portfolios.json 2>/dev/null; then
              echo "| Status | ‚úÖ Pass |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Status | ‚ùå Fail |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Status | ‚ö†Ô∏è No file |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Market Context Summary (RADAR v4.9)
          if [ -f data/market_context.json ]; then
            echo "### üéØ Market Context (RADAR v4.9)" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("data/market_context.json") as f:
              ctx = json.load(f)
          regime = ctx.get('market_regime', 'N/A')
          conf = ctx.get('confidence', 'N/A')
          tilts = ctx.get('macro_tilts', {})
          fav_sec = ', '.join(tilts.get('favored_sectors', [])) or 'None'
          avoid_sec = ', '.join(tilts.get('avoided_sectors', [])) or 'None'
          fav_reg = ', '.join(tilts.get('favored_regions', [])) or 'None'
          avoid_reg = ', '.join(tilts.get('avoided_regions', [])) or 'None'
          model = ctx.get('_meta', {}).get('model', 'unknown')
          is_radar = '‚úÖ RADAR' if model.startswith('radar_') else '‚ö†Ô∏è non-RADAR'
          is_fb = '‚ö†Ô∏è FALLBACK' if ctx.get('_meta', {}).get('is_fallback') else ''
          print(f"| Metric | Value |")
          print(f"|--------|-------|")
          print(f"| Model | {model} {is_radar} |")
          print(f"| Regime | {regime} {is_fb} |")
          print(f"| Confidence | {conf} |")
          print(f"| Favored Sectors | {fav_sec} |")
          print(f"| Avoided Sectors | {avoid_sec} |")
          print(f"| Favored Regions | {fav_reg} |")
          print(f"| Avoided Regions | {avoid_reg} |")
          EOF
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # v4.12.0: Selection Audit Summary
          if [ -f data/selection_audit.json ]; then
            echo "### üîç Selection Audit (v4.12.0)" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("data/selection_audit.json") as f:
              data = json.load(f)
          summary = data.get("summary", {})
          filters = data.get("filters_applied", [])
          print(f"| Metric | Value |")
          print(f"|--------|-------|")
          print(f"| Equities Initial | {summary.get('equities_initial', 0)} |")
          print(f"| Equities Selected | {summary.get('equities_selected', 0)} |")
          print(f"| Equities Rejected (Notable) | {summary.get('equities_rejected_notable', 0)} |")
          print(f"| ETF Selected | {summary.get('etf_selected', 0)} |")
          print(f"| Crypto Selected | {summary.get('crypto_selected', 0)} |")
          print(f"| Filters Applied | {len(filters)} |")
          EOF
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # v5.1.0: Selection Debug Summary (audit_collector)
          if [ -f data/selection_debug.json ]; then
            echo "### üìä Selection Debug (v5.1.0)" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("data/selection_debug.json") as f:
              data = json.load(f)
          meta = data.get("_meta", {})
          print(f"| Metric | Value |")
          print(f"|--------|-------|")
          print(f"| Run ID | {meta.get('run_id', 'N/A')} |")
          print(f"| Git SHA | {meta.get('git_sha', 'N/A')[:8] if meta.get('git_sha') else 'N/A'} |")
          print(f"| Mode | {meta.get('mode', 'N/A')} |")
          print(f"")
          print(f"**Pipeline Stages:**")
          print(f"| Stage | Before | After | Delta |")
          print(f"|-------|--------|-------|-------|")
          stages = data.get("stages", {})
          for stage_name, stage_data in stages.items():
              before = stage_data.get("before_count", 0)
              after = stage_data.get("after_count", 0)
              delta = after - before
              print(f"| {stage_name} | {before} | {after} | {delta:+d} |")
          EOF
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # v4.12.1: Selection Explained Summary (TOP caps by region)
          if [ -f data/selection_explained.json ]; then
            echo "### üèÜ TOP Caps Analysis (v4.12.1)" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("data/selection_explained.json") as f:
              data = json.load(f)
          summary = data.get("summary", {})
          print(f"| Metric | Value |")
          print(f"|--------|-------|")
          print(f"| Total Universe | {summary.get('total_universe', 0)} |")
          print(f"| Total Selected | {summary.get('total_selected', 0)} |")
          print(f"| Selection Rate | {summary.get('selection_rate', 'N/A')} |")
          print(f"")
          print(f"**TOP 20 Caps by Region:**")
          print(f"| Region | Selected | Rejected | Rate |")
          print(f"|--------|----------|----------|------|")
          top_caps = data.get("top_caps_by_region", {})
          for region in ["US", "Europe", "Asia"]:
              if region in top_caps:
                  selected = top_caps[region].get("selected_in_top_20", 0)
                  rejected = 20 - selected
                  rate = top_caps[region].get("rejection_rate_top_20", "N/A")
                  print(f"| {region} | {selected} | {rejected} | {rate} |")
          EOF
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Global Backtest Results
          if [ -f data/backtest_results.json ]; then
            echo "### üìà Global Backtest Comparison (90 days)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Agressif | Mod√©r√© | Stable |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
            
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("data/backtest_results.json") as f:
              data = json.load(f)
          comp = data.get("comparison", {})
          metrics = [
              ("Total Return %", "total_return_pct"),
              ("Sharpe Ratio", "sharpe_ratio"),
              ("Max Drawdown %", "max_drawdown_pct"),
              ("Volatility %", "volatility_pct"),
          ]
          for label, key in metrics:
              agg = comp.get("Agressif", {}).get(key, "N/A")
              mod = comp.get("Mod√©r√©", {}).get(key, "N/A")
              stb = comp.get("Stable", {}).get(key, "N/A")
              print(f"| {label} | {agg} | {mod} | {stb} |")
          EOF
          else
            echo "‚ö†Ô∏è Backtest skipped (TWELVE_DATA_API not configured)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # v4.9.1: Debug file summary
          if [ -f data/backtest_debug.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîç Backtest Debug (v4.9.1)" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("data/backtest_debug.json") as f:
              data = json.load(f)
          cov = data.get("data_coverage", {})
          n_assets = cov.get("tickers_with_data", 0)
          types = cov.get("assets_by_type", {})
          print(f"| Metric | Value |")
          print(f"|--------|-------|")
          print(f"| Assets documented | {n_assets} |")
          for t, count in types.items():
              print(f"| {t} | {count} |")
          EOF
          fi
          
          # EU/US Focus Portfolios Summary (v2.2)
          if [ -f data/portfolios_euus.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üá™üá∫üá∫üá∏ EU/US Focus Portfolios (v2.2)" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("data/portfolios_euus.json") as f:
              data = json.load(f)
          meta = data.get("_meta", {})
          blocked = meta.get("blocked_regions", ["IN", "ASIA_EX_IN", "LATAM"])
          print(f"| Metric | Value |")
          print(f"|--------|-------|")
          print(f"| Mode | EU/US Focus |")
          print(f"| Blocked Regions | {', '.join(blocked)} |")
          print(f"")
          print(f"| Profile | Actions | ETF | Bonds | Vol % |")
          print(f"|---------|---------|-----|-------|-------|")
          for profile in ["Agressif", "Mod√©r√©", "Stable"]:
              if profile in data:
                  n_act = len(data[profile].get("Actions", {}))
                  n_etf = len(data[profile].get("ETF", {}))
                  n_bnd = len(data[profile].get("Obligations", {}))
                  vol = data[profile].get("_optimization", {}).get("vol_realized", "N/A")
                  print(f"| {profile} | {n_act} | {n_etf} | {n_bnd} | {vol} |")
          EOF
          fi
          
          # EU/US Backtest Results
          if [ -f data/backtest_results_euus.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìà EU/US Backtest Comparison (90 days)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Agressif | Mod√©r√© | Stable |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("data/backtest_results_euus.json") as f:
              data = json.load(f)
          comp = data.get("comparison", {})
          for label, key in [("Total Return %", "total_return_pct"), ("Volatility %", "volatility_pct"), ("Max Drawdown %", "max_drawdown_pct"), ("Sharpe Ratio", "sharpe_ratio")]:
              agg = comp.get("Agressif", {}).get(key, "N/A")
              mod = comp.get("Mod√©r√©", {}).get(key, "N/A")
              stb = comp.get("Stable", {}).get(key, "N/A")
              print(f"| {label} | {agg} | {mod} | {stb} |")
          EOF
          fi

      - name: üíæ Commit & push
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Ajouter les artefacts g√©n√©r√©s (v5.1.0 avec selection_debug.json)
          git add data/portfolios.json \
                  data/portfolios_euus.json \
                  data/backtest_results.json \
                  data/backtest_results_euus.json \
                  data/backtest_debug.json \
                  data/market_context.json \
                  data/selection_audit.json \
                  data/selection_explained.json \
                  data/selection_debug.json \
                  data/portfolio_history/* || true

          # Si .gitignore les filtre, forcer l'ajout
          if git check-ignore -q data/portfolios.json; then
            git add -f data/portfolios.json
          fi
          if git check-ignore -q data/portfolios_euus.json; then
            git add -f data/portfolios_euus.json
          fi
          if git check-ignore -q data/backtest_results.json; then
            git add -f data/backtest_results.json
          fi
          if git check-ignore -q data/backtest_results_euus.json; then
            git add -f data/backtest_results_euus.json
          fi
          if git check-ignore -q data/backtest_debug.json; then
            git add -f data/backtest_debug.json
          fi
          if git check-ignore -q data/market_context.json; then
            git add -f data/market_context.json
          fi
          if git check-ignore -q data/selection_audit.json; then
            git add -f data/selection_audit.json
          fi
          if git check-ignore -q data/selection_explained.json; then
            git add -f data/selection_explained.json
          fi
          if git check-ignore -q data/selection_debug.json; then
            git add -f data/selection_debug.json
          fi
          if git check-ignore -q data/portfolio_history; then
            git add -f data/portfolio_history/*.json || true
          fi

          git commit -m "üìä Portefeuilles v5.1.0 RADAR + Audit Collector + Selection Explained + EU/US Focus + Backtest 90j ‚úì" || echo "rien √† committer"

          git push || (git pull --rebase origin main && git push)

      - name: üóÇÔ∏è Archive market_context.json
        if: success()
        run: |
          if [ -f data/market_context.json ]; then
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            cp data/market_context.json "data/portfolio_history/market_context_${TIMESTAMP}.json"
            echo "‚úÖ Archiv√©: market_context_${TIMESTAMP}.json"
          fi
