name: GÃ©nÃ©ration des Portefeuilles v4

on:
  push:
    branches: [ main ]
    paths:
      - actualites.html
      - marche.html
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-portfolios:
    runs-on: ubuntu-latest
    env:
      API_CHAT: ${{ secrets.API_CHAT }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ðŸ“¦ Installer les dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scipy requests beautifulsoup4 lxml openai

      - name: ðŸš€ ExÃ©cuter le moteur v4
        run: python generate_portfolios_v4.py

      - name: ðŸ§¾ Check outputs
        if: always()
        run: |
          echo "== data =="
          ls -lah data || true
          echo "----"
          if [ -f data/portfolios.json ]; then
            echo "SHA1 portfolios.json:"
            sha1sum data/portfolios.json || true
            echo "STAT:"
            stat data/portfolios.json || true
            echo "----"
            echo "CONTENU (premiÃ¨res lignes) :"
            sed -n '1,100p' data/portfolios.json || true
          else
            echo "portfolios.json ABSENT"
          fi
          echo "----"
          echo "== portfolio_history =="
          ls -lah data/portfolio_history || true
          echo "----"
          echo "Dernier fichier v4 :"
          ls -t data/portfolio_history/portfolios_v4_*.json 2>/dev/null | head -1 | xargs cat 2>/dev/null | head -50 || true

      - name: ðŸ’¾ Commit & push
        if: always()
        run: |
          # Ajouter les artefacts gÃ©nÃ©rÃ©s
          git add data/portfolios.json \
                  data/portfolio_history/* || true

          # Si .gitignore les filtre, forcer l'ajout
          if git check-ignore -q data/portfolios.json; then
            git add -f data/portfolios.json
          fi
          if git check-ignore -q data/portfolio_history; then
            git add -f data/portfolio_history/*.json || true
          fi

          git -c user.name="github-actions[bot]" \
              -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
              commit -m "ðŸ“Š Portefeuilles v4 (dÃ©terministe)" || echo "rien Ã  committer"

          # Push simple; si Ã§a Ã©choue pour divergence, tenter un rebase rapide
          git push || (git pull --rebase && git push)
