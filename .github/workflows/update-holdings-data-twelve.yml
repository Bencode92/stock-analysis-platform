name: Update Holdings via Twelve Data API

on:
  schedule:
    # Ex√©cution hebdomadaire - Dimanche √† 3h00 UTC (4h00 Paris, 23h00 NYC samedi)
    - cron: '0 3 * * 0'
  
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Forcer la mise √† jour m√™me si le fichier est r√©cent'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      max_holdings:
        description: 'Nombre max de holdings par ETF (d√©faut: 10)'
        required: false
        default: '10'
        type: string

env:
  PYTHON_VERSION: '3.10'
  TZ: 'Europe/Paris'
  # ‚ö†Ô∏è SCRIPT PRINCIPAL UTILIS√â PAR CE WORKFLOW
  HOLDINGS_SCRIPT: 'scripts/update_holdings.py'

jobs:
  update-holdings:
    name: Update ETF Holdings Data
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üêç Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: üì¶ Cache Python Dependencies
        uses: actions/cache@v3
        id: cache-pip
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-holdings-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-holdings-
            ${{ runner.os }}-pip-
      
      - name: üìö Install Dependencies
        run: |
          echo "üì¶ Installation des d√©pendances Python..."
          python -m pip install --upgrade pip
          pip install requests
          echo "‚úÖ D√©pendances install√©es"
      
      - name: üîç Check Script Exists
        run: |
          echo "üîç V√©rification du script principal..."
          if [ -f "${{ env.HOLDINGS_SCRIPT }}" ]; then
            echo "‚úÖ Script trouv√©: ${{ env.HOLDINGS_SCRIPT }}"
            echo "   Taille: $(du -h ${{ env.HOLDINGS_SCRIPT }} | cut -f1)"
            echo "   Lignes: $(wc -l < ${{ env.HOLDINGS_SCRIPT }}) lignes"
          else
            echo "‚ùå ERREUR: Script non trouv√©: ${{ env.HOLDINGS_SCRIPT }}"
            echo "   V√©rifiez que le fichier existe dans le repository"
            exit 1
          fi
      
      - name: üîç Check Current Holdings Status
        id: check_status
        run: |
          echo "üîç V√©rification du statut actuel des holdings..."
          
          if [ -f "data/etf_holdings.json" ]; then
            FILE_SIZE=$(du -h data/etf_holdings.json | cut -f1)
            FILE_DATE=$(date -r data/etf_holdings.json '+%Y-%m-%d %H:%M:%S')
            FILE_AGE=$((($(date +%s) - $(date -r data/etf_holdings.json +%s)) / 86400))
            
            echo "üìÅ Fichier existant trouv√©:"
            echo "   - Taille: $FILE_SIZE"
            echo "   - Date: $FILE_DATE"
            echo "   - √Çge: $FILE_AGE jours"
            
            # Extraire les stats du JSON
            python -c "
import json
try:
    with open('data/etf_holdings.json') as f:
        data = json.load(f)
        meta = data.get('meta', {})
        print(f'   - ETFs: {meta.get(\"etf_count\", 0)}')
        print(f'   - Holdings totaux: {meta.get(\"total_holdings\", 0)}')
        print(f'   - Derni√®re g√©n√©ration: {meta.get(\"generated_at\", \"N/A\")}')
except:
    pass
            "
            
            if [ $FILE_AGE -lt 6 ] && [ "${{ github.event.inputs.force_update }}" != "true" ]; then
              echo "skip_update=true" >> $GITHUB_OUTPUT
              echo "‚ÑπÔ∏è Fichier r√©cent, mise √† jour non n√©cessaire"
            else
              echo "skip_update=false" >> $GITHUB_OUTPUT
              echo "üîÑ Mise √† jour n√©cessaire (√¢ge > 6 jours ou forc√©e)"
            fi
          else
            echo "skip_update=false" >> $GITHUB_OUTPUT
            echo "üìù Aucun fichier existant, cr√©ation n√©cessaire"
          fi
      
      - name: üóëÔ∏è Force Update if requested
        if: github.event.inputs.force_update == 'true'
        run: |
          echo "üîß Suppression du fichier existant pour forcer la mise √† jour..."
          rm -f data/etf_holdings.json
          echo "‚úÖ Fichier supprim√©"
      
      - name: üìä Update Holdings Data - EXECUTE PYTHON SCRIPT
        if: steps.check_status.outputs.skip_update != 'true'
        env:
          TWELVE_DATA_API: ${{ secrets.TWELVE_DATA_API }}
          HOLDINGS_MAX: ${{ github.event.inputs.max_holdings || '10' }}
          HOLDINGS_STALE_DAYS: '7'
          HOLDINGS_SLEEP: '1.0'
        run: |
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üöÄ EX√âCUTION DU SCRIPT PYTHON PRINCIPAL"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "üìÑ Script: ${{ env.HOLDINGS_SCRIPT }}"
          echo ""
          echo "‚öôÔ∏è Configuration:"
          echo "   - API: Twelve Data"
          echo "   - Max holdings/ETF: $HOLDINGS_MAX"
          echo "   - Pause entre requ√™tes: ${HOLDINGS_SLEEP}s"
          echo "   - P√©remption: $HOLDINGS_STALE_DAYS jours"
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "‚ñ∂Ô∏è  LANCEMENT DU SCRIPT..."
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          
          # ‚ö†Ô∏è EX√âCUTION DU SCRIPT PYTHON PRINCIPAL
          python ${{ env.HOLDINGS_SCRIPT }}
          
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "‚úÖ SCRIPT TERMIN√â"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
      
      - name: üìà Verify Update Results
        if: steps.check_status.outputs.skip_update != 'true'
        id: verify_results
        run: |
          echo "üìä V√©rification des r√©sultats..."
          
          if [ -f "data/etf_holdings.json" ]; then
            echo "‚úÖ Fichier g√©n√©r√© avec succ√®s par le script"
            
            # Afficher les statistiques
            echo ""
            echo "üìà Statistiques du fichier g√©n√©r√©:"
            ls -lh data/etf_holdings.json
            
            python -c "
import json
with open('data/etf_holdings.json') as f:
    data = json.load(f)
    meta = data.get('meta', {})
    etfs = data.get('etfs', {})
    
    print(f'')
    print(f'üìä Contenu:')
    print(f'   - ETFs avec holdings: {len(etfs)}')
    print(f'   - Holdings totaux: {meta.get(\"total_holdings\", 0)}')
    print(f'   - Cr√©dits API utilis√©s: ~{meta.get(\"api_credits_used\", 0)}')
    print(f'   - Timestamp: {meta.get(\"generated_at\", \"N/A\")}')
    
    # Afficher les 5 premiers ETFs comme exemple
    print(f'')
    print(f'üìã Exemples d\\'ETFs trait√©s:')
    for symbol in list(etfs.keys())[:5]:
        etf = etfs[symbol]
        holdings_count = len(etf.get('holdings', []))
        print(f'   - {symbol}: {holdings_count} holdings')
            "
            
            echo "update_success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Erreur: Fichier non g√©n√©r√© par le script"
            echo "   V√©rifiez les logs du script Python ci-dessus"
            echo "update_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: üíæ Commit and Push Changes
        if: steps.verify_results.outputs.update_success == 'true'
        run: |
          # Configuration Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # V√©rifier s'il y a des changements
          if [[ -n $(git status -s data/etf_holdings.json) ]]; then
            echo "üìù Pr√©paration du commit..."
            
            git add data/etf_holdings.json
            
            # Message de commit avec date et heure
            TIMESTAMP=$(TZ=${{ env.TZ }} date '+%Y-%m-%d %H:%M')
            COMMIT_MSG="üìà Update ETF holdings data [${TIMESTAMP}]"
            
            if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
              COMMIT_MSG="${COMMIT_MSG} (forced update)"
            fi
            
            git commit -m "$COMMIT_MSG"
            
            echo "üöÄ Push des modifications..."
            git push
            
            echo "‚úÖ Modifications push√©es avec succ√®s"
          else
            echo "‚ÑπÔ∏è Aucune modification d√©tect√©e (donn√©es identiques)"
          fi
      
      - name: üìù Generate Summary
        if: always()
        run: |
          echo "# üìä Rapport de mise √† jour des Holdings ETF" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## üìÑ Script ex√©cut√©" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.HOLDINGS_SCRIPT }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Informations d'ex√©cution
          echo "## üéØ Contexte d'ex√©cution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "- **Type:** D√©clenchement manuel" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
              echo "- **Mode:** Mise √† jour forc√©e" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "${{ github.event.inputs.max_holdings }}" ]; then
              echo "- **Holdings/ETF:** ${{ github.event.inputs.max_holdings }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Type:** Planifi√© (hebdomadaire)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **Date:** $(TZ=${{ env.TZ }} date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # R√©sultats
          echo "## üìà R√©sultats" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_status.outputs.skip_update }}" == "true" ]; then
            echo "‚ÑπÔ∏è **Mise √† jour ignor√©e** - Fichier d√©j√† r√©cent" >> $GITHUB_STEP_SUMMARY
          elif [ -f "data/etf_holdings.json" ]; then
            echo "‚úÖ **Mise √† jour r√©ussie**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìÅ Fichier g√©n√©r√©" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -lh data/etf_holdings.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **√âchec de la mise √† jour**" >> $GITHUB_STEP_SUMMARY
            echo "   Script utilis√©: ${{ env.HOLDINGS_SCRIPT }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "‚è∞ **Prochaine ex√©cution planifi√©e:** Dimanche prochain 3h00 UTC" >> $GITHUB_STEP_SUMMARY
