name: Update Holdings via Twelve Data API

on:
  schedule:
    # ExÃ©cution hebdomadaire - Dimanche Ã  3h00 UTC (4h00 Paris, 23h00 NYC samedi)
    - cron: '0 3 * * 0'
  
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Forcer la mise Ã  jour mÃªme si le fichier est rÃ©cent'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      max_holdings:
        description: 'Nombre max de holdings par ETF (dÃ©faut: 10)'
        required: false
        default: '10'
        type: string

env:
  PYTHON_VERSION: '3.10'
  TZ: 'Europe/Paris'

jobs:
  update-holdings:
    name: Update ETF Holdings Data
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ Cache Python Dependencies
        uses: actions/cache@v3
        id: cache-pip
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-holdings-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-holdings-
            ${{ runner.os }}-pip-
      
      - name: ðŸ“š Install Dependencies
        run: |
          echo "ðŸ“¦ Installation des dÃ©pendances Python..."
          python -m pip install --upgrade pip
          pip install requests
          echo "âœ… DÃ©pendances installÃ©es"
      
      - name: ðŸ” Check Current Holdings Status
        id: check_status
        run: |
          echo "ðŸ” VÃ©rification du statut actuel des holdings..."
          
          if [ -f "data/etf_holdings.json" ]; then
            FILE_SIZE=$(du -h data/etf_holdings.json | cut -f1)
            FILE_DATE=$(date -r data/etf_holdings.json '+%Y-%m-%d %H:%M:%S')
            FILE_AGE=$((($(date +%s) - $(date -r data/etf_holdings.json +%s)) / 86400))
            
            echo "ðŸ“ Fichier existant trouvÃ©:"
            echo "   - Taille: $FILE_SIZE"
            echo "   - Date: $FILE_DATE"
            echo "   - Ã‚ge: $FILE_AGE jours"
            
            # Extraire les stats du JSON
            python -c "
import json
try:
    with open('data/etf_holdings.json') as f:
        data = json.load(f)
        meta = data.get('meta', {})
        print(f'   - ETFs: {meta.get(\"etf_count\", 0)}')
        print(f'   - Holdings totaux: {meta.get(\"total_holdings\", 0)}')
        print(f'   - DerniÃ¨re gÃ©nÃ©ration: {meta.get(\"generated_at\", \"N/A\")}')
except:
    pass
            "
            
            if [ $FILE_AGE -lt 6 ] && [ "${{ github.event.inputs.force_update }}" != "true" ]; then
              echo "skip_update=true" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ Fichier rÃ©cent, mise Ã  jour non nÃ©cessaire"
            else
              echo "skip_update=false" >> $GITHUB_OUTPUT
              echo "ðŸ”„ Mise Ã  jour nÃ©cessaire (Ã¢ge > 6 jours ou forcÃ©e)"
            fi
          else
            echo "skip_update=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ Aucun fichier existant, crÃ©ation nÃ©cessaire"
          fi
      
      - name: ðŸ—‘ï¸ Force Update if requested
        if: github.event.inputs.force_update == 'true'
        run: |
          echo "ðŸ”§ Suppression du fichier existant pour forcer la mise Ã  jour..."
          rm -f data/etf_holdings.json
          echo "âœ… Fichier supprimÃ©"
      
      - name: ðŸ“Š Update Holdings Data
        if: steps.check_status.outputs.skip_update != 'true'
        env:
          TWELVE_DATA_API: ${{ secrets.TWELVE_DATA_API }}
          HOLDINGS_MAX: ${{ github.event.inputs.max_holdings || '10' }}
          HOLDINGS_STALE_DAYS: '7'
          HOLDINGS_SLEEP: '1.0'
        run: |
          echo "ðŸš€ Lancement de la mise Ã  jour des holdings ETF..."
          echo ""
          echo "âš™ï¸ Configuration:"
          echo "   - API: Twelve Data"
          echo "   - Max holdings/ETF: $HOLDINGS_MAX"
          echo "   - Pause entre requÃªtes: ${HOLDINGS_SLEEP}s"
          echo "   - PÃ©remption: $HOLDINGS_STALE_DAYS jours"
          echo ""
          
          # ExÃ©cuter le script
          python scripts/update_holdings.py
          
          echo ""
          echo "âœ… Script terminÃ©"
      
      - name: ðŸ“ˆ Verify Update Results
        if: steps.check_status.outputs.skip_update != 'true'
        id: verify_results
        run: |
          echo "ðŸ“Š VÃ©rification des rÃ©sultats..."
          
          if [ -f "data/etf_holdings.json" ]; then
            echo "âœ… Fichier gÃ©nÃ©rÃ© avec succÃ¨s"
            
            # Afficher les statistiques
            echo ""
            echo "ðŸ“ˆ Statistiques du fichier:"
            ls -lh data/etf_holdings.json
            
            python -c "
import json
with open('data/etf_holdings.json') as f:
    data = json.load(f)
    meta = data.get('meta', {})
    etfs = data.get('etfs', {})
    
    print(f'')
    print(f'ðŸ“Š Contenu:')
    print(f'   - ETFs avec holdings: {len(etfs)}')
    print(f'   - Holdings totaux: {meta.get(\"total_holdings\", 0)}')
    print(f'   - CrÃ©dits API utilisÃ©s: ~{meta.get(\"api_credits_used\", 0)}')
    print(f'   - Timestamp: {meta.get(\"generated_at\", \"N/A\")}')
    
    # Afficher les 5 premiers ETFs comme exemple
    print(f'')
    print(f'ðŸ“‹ Exemples d\\'ETFs traitÃ©s:')
    for symbol in list(etfs.keys())[:5]:
        etf = etfs[symbol]
        holdings_count = len(etf.get('holdings', []))
        print(f'   - {symbol}: {holdings_count} holdings')
            "
            
            echo "update_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Erreur: Fichier non gÃ©nÃ©rÃ©"
            echo "update_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ðŸ’¾ Commit and Push Changes
        if: steps.verify_results.outputs.update_success == 'true'
        run: |
          # Configuration Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # VÃ©rifier s'il y a des changements
          if [[ -n $(git status -s data/etf_holdings.json) ]]; then
            echo "ðŸ“ PrÃ©paration du commit..."
            
            git add data/etf_holdings.json
            
            # Message de commit avec date et heure
            TIMESTAMP=$(TZ=${{ env.TZ }} date '+%Y-%m-%d %H:%M')
            COMMIT_MSG="ðŸ“ˆ Update ETF holdings data [${TIMESTAMP}]"
            
            if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
              COMMIT_MSG="${COMMIT_MSG} (forced update)"
            fi
            
            git commit -m "$COMMIT_MSG"
            
            echo "ðŸš€ Push des modifications..."
            git push
            
            echo "âœ… Modifications pushÃ©es avec succÃ¨s"
          else
            echo "â„¹ï¸ Aucune modification dÃ©tectÃ©e (donnÃ©es identiques)"
          fi
      
      - name: ðŸ“ Generate Summary
        if: always()
        run: |
          echo "# ðŸ“Š Rapport de mise Ã  jour des Holdings ETF" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Informations d'exÃ©cution
          echo "## ðŸŽ¯ Contexte d'exÃ©cution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "- **Type:** DÃ©clenchement manuel" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
              echo "- **Mode:** Mise Ã  jour forcÃ©e" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "${{ github.event.inputs.max_holdings }}" ]; then
              echo "- **Holdings/ETF:** ${{ github.event.inputs.max_holdings }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Type:** PlanifiÃ© (hebdomadaire)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **Date:** $(TZ=${{ env.TZ }} date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # RÃ©sultats
          echo "## ðŸ“ˆ RÃ©sultats" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_status.outputs.skip_update }}" == "true" ]; then
            echo "â„¹ï¸ **Mise Ã  jour ignorÃ©e** - Fichier dÃ©jÃ  rÃ©cent" >> $GITHUB_STEP_SUMMARY
          elif [ -f "data/etf_holdings.json" ]; then
            echo "âœ… **Mise Ã  jour rÃ©ussie**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Fichier gÃ©nÃ©rÃ©" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -lh data/etf_holdings.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Ã‰chec de la mise Ã  jour**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "â° **Prochaine exÃ©cution planifiÃ©e:** Dimanche prochain 3h00 UTC" >> $GITHUB_STEP_SUMMARY
