name: Update Holdings via Twelve Data API

permissions:
  contents: write   # NÃ©cessaire pour git push
  actions: read

on:
  schedule:
    - cron: '0 3 * * 0'  # Dimanche 3h UTC
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Forcer la mise Ã  jour mÃªme si le fichier est rÃ©cent'
        required: false
        default: 'false'
        type: choice
        options: ['true', 'false']
      max_holdings:
        description: 'Nombre max de holdings par ETF (dÃ©faut: 10)'
        required: false
        default: '10'
        type: string

env:
  PYTHON_VERSION: '3.10'
  TZ: 'Europe/Paris'
  HOLDINGS_SCRIPT: 'scripts/update_holdings.py'

jobs:
  update-holdings:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ”‘ Preflight Checks
        run: |
          echo "ðŸ” VÃ©rification des prÃ©requis..."
          
          # VÃ©rifier le secret API
          if [ -z "${{ secrets.TWELVE_DATA_API }}" ]; then
            echo "::error::Secret TWELVE_DATA_API manquant. Configurez-le dans Settings > Secrets > Actions"
            exit 1
          fi
          echo "âœ… ClÃ© API configurÃ©e"
          
          # VÃ©rifier sectors.json
          if [ ! -f "data/sectors.json" ]; then
            echo "::error::data/sectors.json introuvable. Lancez d'abord update-sectors-data-twelve.yml"
            echo "Contenu du dossier data:"
            ls -la data/ || echo "Dossier data inexistant"
            exit 1
          fi
          echo "âœ… sectors.json trouvÃ©"
          
          # VÃ©rifier le script Python
          if [ ! -f "${{ env.HOLDINGS_SCRIPT }}" ]; then
            echo "::error::Script ${{ env.HOLDINGS_SCRIPT }} introuvable"
            exit 1
          fi
          echo "âœ… Script Python trouvÃ©"
          
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          
      - name: ðŸ” Check Current Holdings Status
        id: check_status
        run: |
          if [ -f "data/etf_holdings.json" ]; then
            FILE_AGE=$((($(date +%s) - $(date -r data/etf_holdings.json +%s)) / 86400))
            echo "ðŸ“ Holdings existants (Ã¢ge: $FILE_AGE jours)"
            
            if [ $FILE_AGE -lt 6 ] && [ "${{ github.event.inputs.force_update }}" != "true" ]; then
              echo "skip_update=true" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ Fichier rÃ©cent, pas de mise Ã  jour nÃ©cessaire"
            else
              echo "skip_update=false" >> $GITHUB_OUTPUT
              echo "ðŸ”„ Mise Ã  jour nÃ©cessaire"
            fi
          else
            echo "skip_update=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ Aucun fichier existant, crÃ©ation nÃ©cessaire"
          fi
          
      - name: ðŸ—‘ï¸ Force Update if requested
        if: github.event.inputs.force_update == 'true'
        run: |
          echo "ðŸ”§ Suppression forcÃ©e du fichier existant..."
          rm -f data/etf_holdings.json || true
          
      - name: ðŸ“Š Update Holdings Data
        if: steps.check_status.outputs.skip_update != 'true'
        env:
          TWELVE_DATA_API: ${{ secrets.TWELVE_DATA_API }}
          HOLDINGS_MAX: ${{ github.event.inputs.max_holdings || '10' }}
          HOLDINGS_STALE_DAYS: '7'
          HOLDINGS_SLEEP: '1.0'
        run: |
          echo "ðŸš€ Lancement du script Python..."
          python ${{ env.HOLDINGS_SCRIPT }}
          
      - name: ðŸ“ˆ Verify Update Results
        if: steps.check_status.outputs.skip_update != 'true'
        run: |
          if [ ! -f "data/etf_holdings.json" ]; then
            echo "::error::Le script n'a pas gÃ©nÃ©rÃ© data/etf_holdings.json"
            echo "VÃ©rifiez les logs de l'Ã©tape prÃ©cÃ©dente"
            exit 1
          fi
          
          echo "âœ… Fichier gÃ©nÃ©rÃ© avec succÃ¨s:"
          ls -lh data/etf_holdings.json
          
          # Afficher un rÃ©sumÃ©
          python -c "
import json
with open('data/etf_holdings.json') as f:
    data = json.load(f)
    meta = data.get('meta', {})
    print(f'ETFs: {len(data.get(\"etfs\", {}))}')
    print(f'Holdings totaux: {meta.get(\"total_holdings\", 0)}')
    print(f'CrÃ©dits utilisÃ©s: ~{meta.get(\"api_credits_used\", 0)}')
          "
          
      - name: ðŸ’¾ Commit and Push Changes
        if: steps.check_status.outputs.skip_update != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add data/etf_holdings.json
          
          # Commit seulement s'il y a des changements
          git diff --cached --quiet || {
            TIMESTAMP=$(TZ=${{ env.TZ }} date '+%Y-%m-%d %H:%M')
            git commit -m "ðŸ“ˆ Update ETF holdings data [$TIMESTAMP]"
            git push
            echo "âœ… Modifications pushÃ©es"
          } || echo "â„¹ï¸ Aucun changement Ã  commiter"
          
      - name: ðŸ“ Generate Summary
        if: always()
        run: |
          echo "# ðŸ“Š Rapport Holdings ETF" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_status.outputs.skip_update }}" == "true" ]; then
            echo "â„¹ï¸ **Mise Ã  jour ignorÃ©e** - Fichier dÃ©jÃ  rÃ©cent" >> $GITHUB_STEP_SUMMARY
          elif [ -f "data/etf_holdings.json" ]; then
            echo "âœ… **Mise Ã  jour rÃ©ussie**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Statistiques" >> $GITHUB_STEP_SUMMARY
            python -c "
import json
with open('data/etf_holdings.json') as f:
    data = json.load(f)
    meta = data.get('meta', {})
    etfs = data.get('etfs', {})
    print(f'- ETFs traitÃ©s: {len(etfs)}')
    print(f'- Holdings totaux: {meta.get(\"total_holdings\", 0)}')
    print(f'- CrÃ©dits API: ~{meta.get(\"api_credits_used\", 0)}')
    print(f'- GÃ©nÃ©rÃ© Ã : {meta.get(\"generated_at\", \"N/A\")}')
            " >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Ã‰chec de la mise Ã  jour**" >> $GITHUB_STEP_SUMMARY
            echo "Consultez les logs pour plus de dÃ©tails" >> $GITHUB_STEP_SUMMARY
          fi
