{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://tradepulse.io/schemas/portfolio_output.json",
  "title": "TradePulse Portfolio Output Schema",
  "description": "Schema for validating generated portfolio JSON files (v2.7.0 - Tickers Meta)",
  "type": "object",
  "required": ["Agressif", "Modéré", "Stable", "_meta"],
  "additionalProperties": false,
  "properties": {
    "Agressif": {
      "$ref": "#/definitions/ProfilePortfolio",
      "description": "Aggressive risk profile portfolio"
    },
    "Modéré": {
      "$ref": "#/definitions/ProfilePortfolio",
      "description": "Moderate risk profile portfolio"
    },
    "Stable": {
      "$ref": "#/definitions/ProfilePortfolio",
      "description": "Stable/Conservative risk profile portfolio"
    },
    "_meta": {
      "$ref": "#/definitions/MetaInfo",
      "description": "Generation metadata"
    },
    "_manifest": {
      "$ref": "#/definitions/Manifest",
      "description": "Run manifest for reproducibility (optional but recommended)"
    },
    "_limitations": {
      "$ref": "#/definitions/GlobalLimitations",
      "description": "Data and methodology limitations (optional but recommended)"
    },
    "_schema": {
      "$ref": "#/definitions/SchemaInfo",
      "description": "Schema version info (optional)"
    }
  },
  "definitions": {
    "ProfilePortfolio": {
      "type": "object",
      "required": ["Commentaire", "Actions", "ETF", "Obligations", "Crypto", "_tickers"],
      "additionalProperties": false,
      "properties": {
        "Commentaire": {
          "type": "string",
          "minLength": 50,
          "maxLength": 5000,
          "description": "LLM-generated commentary with disclaimers"
        },
        "Actions": {
          "$ref": "#/definitions/AllocationMap",
          "description": "Stock allocations by name"
        },
        "ETF": {
          "$ref": "#/definitions/AllocationMap",
          "description": "ETF allocations by name"
        },
        "Obligations": {
          "$ref": "#/definitions/AllocationMap",
          "description": "Bond allocations by name"
        },
        "Crypto": {
          "$ref": "#/definitions/AllocationMap",
          "description": "Crypto allocations by name"
        },
        "_tickers": {
          "$ref": "#/definitions/TickerWeights",
          "description": "Ticker symbols with decimal weights"
        },
        "_tickers_meta": {
          "$ref": "#/definitions/TickersMeta",
          "description": "v5.2.0: Ticker metadata with guaranteed category for stress test"
        },
        "_backtest": {
          "$ref": "#/definitions/BacktestResults",
          "description": "Backtest metrics (optional)"
        },
        "_constraint_report": {
          "$ref": "#/definitions/ConstraintReport",
          "description": "P0-2: Constraint verification report post-rounding"
        },
        "_limitations": {
          "$ref": "#/definitions/ProfileLimitations",
          "description": "P0-3: Profile-specific limitations and trade-offs"
        },
        "_optimization": {
          "$ref": "#/definitions/OptimizationInfo",
          "description": "P0-9: Optimization mode and diagnostics"
        },
        "_compliance_audit": {
          "$ref": "#/definitions/ComplianceAudit",
          "description": "P0-7: LLM sanitization audit trail"
        },
        "_exposures": {
          "$ref": "#/definitions/ExposuresReport",
          "description": "Phase 1: Portfolio exposures breakdown"
        },
        "_execution_summary": {
          "$ref": "#/definitions/ExecutionSummary",
          "description": "Phase 1: Ticker mapping and execution readiness"
        },
        "_asset_details": {
          "$ref": "#/definitions/AssetDetailsList",
          "description": "v4.11.0: LLM-generated rationales for each asset with RADAR context"
        },
        "risk_analysis": {
          "type": ["object", "null"],
          "description": "v5.2.1: Export risk analysis (may evolve)",
          "additionalProperties": true
        },
        "_numeric_weights": {
          "type": "object",
          "description": "v4.15.0: Numeric weights by category:name for sum validation",
          "additionalProperties": {
            "type": "number",
            "minimum": 0,
            "maximum": 100
          }
        },
        "_tickers_pricing": {
          "$ref": "#/definitions/TickerWeights",
          "description": "v4.15.0: Tradable tickers only (filtered for backtest)"
        },
        "_unpriced_assets": {
          "type": "array",
          "description": "v4.15.0: Assets without tradable ticker",
          "items": {
            "type": "object",
            "properties": {
              "candidate": { "type": "string" },
              "weight_pct": { "type": "number" },
              "reason": { "type": "string" }
            }
          }
        },
        "_pricing_coverage_pct": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "v4.15.0: Percentage of portfolio with tradable tickers"
        }
      }
    },
    "AllocationMap": {
      "type": "object",
      "additionalProperties": {
        "type": "string",
        "pattern": "^(<1%|[0-9]{1,3}(\\.[0-9])?%)$",
        "description": "Percentage allocation (e.g., '15%', '5.5%', '<1%')"
      },
      "description": "Map of asset names to percentage allocations"
    },
    "TickerWeights": {
      "type": "object",
      "additionalProperties": {
        "type": "number",
        "minimum": 0,
        "maximum": 1,
        "description": "Decimal weight (0.0 to 1.0)"
      },
      "description": "Map of ticker symbols to decimal weights"
    },
    "TickersMeta": {
      "type": "object",
      "description": "v5.2.0: Map of ticker symbols to metadata with guaranteed category",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "weight": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "Decimal weight (0.0 to 1.0)"
          },
          "category": {
            "type": "string",
            "enum": ["Actions", "ETF", "Obligations", "Crypto"],
            "description": "Asset category (guaranteed)"
          },
          "name": {
            "type": "string",
            "description": "Asset display name"
          },
          "asset_ids": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Original asset IDs"
          }
        },
        "required": ["weight", "category"]
      }
    },
    "AssetDetailsList": {
      "type": "array",
      "description": "v4.11.0: List of asset details with LLM-generated rationales",
      "items": {
        "$ref": "#/definitions/AssetDetail"
      }
    },
    "AssetDetail": {
      "type": "object",
      "description": "v4.11.0: Individual asset detail with rationale and context",
      "required": ["name", "weight_pct"],
      "additionalProperties": true,
      "properties": {
        "name": {
          "type": "string",
          "description": "Asset display name"
        },
        "ticker": {
          "type": ["string", "null"],
          "description": "Ticker symbol"
        },
        "weight_pct": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Allocation weight in percentage"
        },
        "category": {
          "type": "string",
          "enum": ["Actions", "ETF", "Obligations", "Crypto"],
          "description": "Asset category"
        },
        "sector": {
          "type": ["string", "null"],
          "description": "Sector classification"
        },
        "country": {
          "type": ["string", "null"],
          "description": "Country of domicile"
        },
        "rationale": {
          "type": "string",
          "minLength": 10,
          "maxLength": 1000,
          "description": "LLM-generated explanation for selection"
        },
        "role": {
          "type": "string",
          "enum": ["core", "satellite", "hedge", "income", "diversification", "trading", "defensive", "lottery", "growth", "value", "momentum", "recovery", "speculative"],
          "description": "Role in portfolio construction"
        },
        "risk_note": {
          "type": ["string", "null"],
          "description": "Key risk to monitor"
        },
        "market_context_link": {
          "type": ["string", "null"],
          "description": "Link to RADAR market context if applicable"
        },
        "metrics": {
          "type": "object",
          "description": "Asset metrics snapshot",
          "additionalProperties": true,
          "properties": {
            "roe": { "type": ["string", "number", "null"] },
            "pe_ratio": { "type": ["number", "null"] },
            "dividend_yield": { "type": ["string", "number", "null"] },
            "ytd": { "type": ["string", "number", "null"] },
            "volatility": { "type": ["string", "number", "null"] },
            "buffett_score": { "type": ["number", "null"] },
            "ter": { "type": ["string", "number", "null"] }
          }
        }
      }
    },
    "MetaInfo": {
      "type": "object",
      "required": ["generated_at", "version"],
      "additionalProperties": true,
      "properties": {
        "generated_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of generation"
        },
        "version": {
          "type": "string",
          "pattern": "^v[0-9]+\\.[0-9]+\\.[0-9]+.*$",
          "description": "Generator version (e.g., 'v4.8.3_p0_fix')"
        },
        "buffett_mode": {
          "type": "string",
          "enum": ["strict", "soft", "off", "none"],
          "description": "Buffett score filtering mode"
        },
        "buffett_min_score": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Minimum Buffett score threshold"
        },
        "tactical_context_enabled": {
          "type": "boolean",
          "description": "Whether market context was used"
        },
        "backtest_days": {
          "type": "integer",
          "minimum": 1,
          "maximum": 3650,
          "description": "Number of days for backtest"
        },
        "optimization_modes": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Optimization mode per profile"
        }
      }
    },
    "Manifest": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "git_sha": {
          "type": "string",
          "pattern": "^[a-f0-9]{40}$",
          "description": "Full git commit SHA"
        },
        "git_branch": {
          "type": "string",
          "description": "Git branch name"
        },
        "module_versions": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Python module versions used"
        },
        "data_sources": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "source": { "type": "string" },
              "hash": { "type": "string" },
              "timestamp": { "type": "string", "format": "date-time" }
            }
          },
          "description": "Data sources with hashes"
        }
      }
    },
    "GlobalLimitations": {
      "type": "object",
      "additionalProperties": true,
      "description": "Global data and methodology limitations",
      "properties": {
        "survivorship_bias": {
          "type": "object",
          "properties": {
            "present": { "type": "boolean" },
            "description": { "type": "string" }
          }
        },
        "point_in_time": {
          "type": "object",
          "properties": {
            "compliant": { "type": "boolean" },
            "description": { "type": "string" }
          }
        },
        "fx_handling": {
          "type": "object",
          "properties": {
            "method": { "type": "string" },
            "description": { "type": "string" }
          }
        },
        "backtest_methodology": {
          "type": "string",
          "description": "Backtest methodology used"
        }
      }
    },
    "ProfileLimitations": {
      "type": "array",
      "description": "P0-3: List of limitations and trade-offs for this profile",
      "items": {
        "type": "string",
        "minLength": 10,
        "maxLength": 500
      }
    },
    "SchemaInfo": {
      "type": "object",
      "properties": {
        "version": {
          "type": "string",
          "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
          "description": "Schema version (semver)"
        },
        "min_compatible_version": {
          "type": "string",
          "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
          "description": "Minimum compatible schema version"
        }
      }
    },
    "BacktestResults": {
      "type": "object",
      "properties": {
        "return_pct": { "type": "number" },
        "return_gross_pct": { "type": "number" },
        "return_net_pct": { "type": "number" },
        "volatility_pct": { "type": "number" },
        "sharpe_ratio": { "type": ["number", "null"] },
        "max_drawdown_pct": { "type": "number" },
        "benchmark_return_pct": { "type": "number" },
        "benchmark_symbol": { "type": "string" },
        "transaction_cost_bp": { "type": "number" },
        "turnover": { "type": "number" },
        "days": { "type": "integer" },
        "start_date": { "type": "string", "format": "date" },
        "end_date": { "type": "string", "format": "date" }
      }
    },
    "ConstraintReport": {
      "type": "object",
      "description": "P0-2: Post-rounding constraint verification report (supports both basic and Phase 1 enriched)",
      "additionalProperties": true,
      "properties": {
        "all_satisfied": { "type": "boolean" },
        "all_hard_satisfied": { "type": "boolean" },
        "all_soft_satisfied": { "type": "boolean" },
        "profile": { "type": "string" },
        "timestamp": { "type": "string", "format": "date-time" },
        "n_violations": { "type": "integer" },
        "violations": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": true,
            "properties": {
              "constraint_name": { "type": "string" },
              "priority": { "type": "string", "enum": ["hard", "soft", "relaxable"] },
              "actual": { "type": "number" },
              "expected": { "type": "string" },
              "context": { "type": "string" }
            }
          }
        },
        "warnings": {
          "type": "array",
          "items": { "type": "string" }
        },
        "margins": {
          "type": "object",
          "additionalProperties": true
        },
        "relaxed_constraints": {
          "type": "array",
          "items": { "type": "string" }
        },
        "quality_score": { "type": "number" },
        "bindings": {
          "type": "array",
          "items": { "type": "object", "additionalProperties": true }
        },
        "detailed_margins": {
          "type": "array",
          "items": { "type": "object", "additionalProperties": true }
        }
      }
    },
    "OptimizationInfo": {
      "type": "object",
      "description": "P0-9: Optimization mode and diagnostics",
      "additionalProperties": true,
      "properties": {
        "mode": {
          "type": "string",
          "description": "Optimization method used"
        },
        "is_heuristic": {
          "type": "boolean",
          "description": "Whether heuristic fallback was used"
        },
        "vol_realized": {
          "type": ["number", "null"],
          "description": "Realized portfolio volatility (%)"
        },
        "vol_target": {
          "type": ["number", "null"],
          "description": "Target volatility (%)"
        },
        "disclaimer": {
          "type": "string",
          "description": "Disclaimer if heuristic mode used"
        },
        "converged": {
          "type": "boolean",
          "description": "Whether SLSQP converged successfully"
        },
        "vol_tolerance": {
          "type": "number",
          "description": "Volatility tolerance band (%)"
        },
        "fallback_reason": {
          "type": ["string", "null"],
          "description": "Reason for fallback if applicable"
        },
        "covariance_method": {
          "type": "string",
          "description": "Covariance estimation method"
        },
        "n_assets": {
          "type": "integer",
          "description": "Number of assets in final allocation"
        },
        "n_bonds": {
          "type": "integer",
          "description": "Number of bonds in allocation"
        },
        "n_crypto": {
          "type": "integer",
          "description": "Number of crypto assets in allocation"
        }
      }
    },
    "ComplianceAudit": {
      "type": "object",
      "description": "P0-7: LLM sanitization audit trail",
      "properties": {
        "llm_sanitizer": {
          "type": "object",
          "properties": {
            "sanitized": { "type": "boolean" },
            "removed_sentences": { "type": "integer" },
            "original_length": { "type": "integer" },
            "cleaned_length": { "type": "integer" },
            "removal_ratio": { "type": "number" },
            "hits": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "pattern": { "type": "string" },
                  "matched": { "type": "string" },
                  "category": { "type": "string" }
                }
              }
            }
          }
        },
        "timestamp": { "type": "string", "format": "date-time" },
        "version": { "type": "string" },
        "fallback_used": { "type": "boolean" }
      }
    },
    "ExposuresReport": {
      "type": "object",
      "description": "Phase 1: Portfolio exposures breakdown with concentration metrics",
      "additionalProperties": true,
      "properties": {
        "by_category": {
          "type": "object",
          "description": "Exposure by asset category (Actions, ETF, Obligations, Crypto)",
          "additionalProperties": { "type": "number" }
        },
        "by_sector": {
          "type": "object",
          "description": "Exposure by sector",
          "additionalProperties": { "type": "number" }
        },
        "by_region": {
          "type": "object",
          "description": "Exposure by geographic region",
          "additionalProperties": { "type": "number" }
        },
        "by_risk_bucket": {
          "type": "object",
          "description": "Exposure by risk bucket (equity_like, bond_like, leveraged, etc.)",
          "additionalProperties": { "type": "number" }
        },
        "by_role": {
          "type": "object",
          "description": "Exposure by portfolio role (core, defensive, satellite, lottery)",
          "additionalProperties": { "type": "number" }
        },
        "concentration": {
          "type": "object",
          "description": "Concentration metrics",
          "properties": {
            "hhi": {
              "type": "number",
              "description": "Herfindahl-Hirschman Index (0-10000)"
            },
            "hhi_interpretation": {
              "type": "string",
              "enum": ["well_diversified", "diversified", "moderately_concentrated", "highly_concentrated"],
              "description": "HHI interpretation"
            },
            "effective_n": {
              "type": "number",
              "description": "Effective number of positions (1/HHI * 10000)"
            },
            "top_5_weight": {
              "type": "number",
              "description": "Combined weight of top 5 positions (%)"
            },
            "top_10_weight": {
              "type": "number",
              "description": "Combined weight of top 10 positions (%)"
            },
            "largest_position": {
              "type": "number",
              "description": "Weight of largest position (%)"
            },
            "smallest_position": {
              "type": "number",
              "description": "Weight of smallest position (%)"
            }
          }
        }
      }
    },
    "ExecutionSummary": {
      "type": "object",
      "description": "Phase 1: Ticker mapping and execution readiness",
      "additionalProperties": true,
      "properties": {
        "n_positions": {
          "type": "integer",
          "description": "Total number of positions"
        },
        "n_exchanges": {
          "type": "integer",
          "description": "Number of distinct exchanges"
        },
        "exchanges": {
          "type": "array",
          "description": "List of exchanges",
          "items": { "type": "string" }
        },
        "total_weight": {
          "type": "number",
          "description": "Total portfolio weight (should be 100)"
        },
        "missing_isin": {
          "type": "integer",
          "description": "Number of positions missing ISIN"
        },
        "missing_ticker": {
          "type": "integer",
          "description": "Number of positions missing ticker"
        },
        "data_quality": {
          "type": "object",
          "description": "Data quality metrics",
          "properties": {
            "isin_coverage": {
              "type": "number",
              "description": "Percentage of positions with ISIN"
            },
            "ticker_coverage": {
              "type": "number",
              "description": "Percentage of positions with ticker"
            }
          }
        },
        "ready_for_execution": {
          "type": "boolean",
          "description": "Whether portfolio is ready for execution"
        }
      }
    }
  }
}
